{% extends 'base.html' %}
{% load widget_tweaks %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4>📦 제품 등록/수정</h4>
    {% if form.instance.pk %}
        <a href="{% url 'product:product_price' form.instance.pk %}" class="btn btn-sm btn-outline-primary">💰 단가 탭</a>
    {% endif %}
</div>

<form method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}

    <!-- 🧾 기본정보 -->
    <h6>🧾 기본정보</h6>
    <div class="row">
        <div class="col-md-8">
            <div class="row">
                <div class="col-md-6 mb-2">{{ form.name.label_tag }} {{ form.name|add_class:"form-control form-control-sm" }}</div>
                <div class="col-md-6 mb-2">{{ form.program_name.label_tag }} {{ form.program_name|add_class:"form-control form-control-sm" }}</div>
                <div class="col-md-6 mb-2">{{ form.status.label_tag }} {{ form.status|add_class:"form-select form-select-sm" }}</div>
                <div class="col-md-6 mb-2">{{ form.alias.label_tag }} {{ form.alias|add_class:"form-control form-control-sm" }}</div>
                <div class="col-md-6 mb-2">{{ form.part_number.label_tag }} {{ form.part_number|add_class:"form-control form-control-sm" }}</div>
                <div class="col-md-6 mb-2">{{ form.sub_part_number.label_tag }} {{ form.sub_part_number|add_class:"form-control form-control-sm" }}</div>
                <div class="col-md-6 mb-2">{{ form.part_size.label_tag }} {{ form.part_size|add_class:"form-control form-control-sm" }}</div>
                <div class="col-md-6 mb-2">{{ form.material.label_tag }} {{ form.material|add_class:"form-select form-select-sm" }}</div>
                <div class="col-md-6 mb-2">{{ form.spec.label_tag }} {{ form.spec|add_class:"form-select form-select-sm" }}</div>
                <div class="col-md-6 mb-2">{{ form.customer.label_tag }} {{ form.customer|add_class:"form-select form-select-sm" }}</div>
                <div class="col-md-6 mb-2">{{ form.injection_vendor.label_tag }} {{ form.injection_vendor|add_class:"form-select form-select-sm" }}</div>
                <div class="col-md-6 mb-2">{{ form.weight.label_tag }} {{ form.weight|add_class:"form-control form-control-sm" }}</div>
                <div class="col-md-6 mb-2">{{ form.rack_info.label_tag }} {{ form.rack_info|add_class:"form-control form-control-sm" }}</div>
                <div class="col-md-4 mb-2">{{ form.use_yn.label_tag }} {{ form.use_yn|add_class:"form-select form-select-sm" }} {{ form.delete_yn.as_hidden }}</div>
            </div>
        </div>
        <div class="col-md-4 text-center">
            {% if form.instance.image %}
                <img src="{{ form.instance.image.url }}" class="img-thumbnail mb-2" width="200">
            {% endif %}
            <label>제품 이미지</label>
            {{ form.image|add_class:"form-control form-control-sm" }}
        </div>
    </div>

    <hr>

    <!-- 🏭 생산 정보 -->
    <h6>🏭 생산 정보</h6>
    <div class="row">
        <div class="col-md-6 mb-2">{{ form.production_program_code.label_tag }} {{ form.production_program_code|add_class:"form-control form-control-sm" }}</div>
        <div class="col-md-6 mb-2">{{ form.hanger_count.label_tag }} {{ form.hanger_count|add_class:"form-control form-control-sm" }}</div>
        <div class="col-md-6 mb-2">{{ form.turn_time_per_hanger.label_tag }} {{ form.turn_time_per_hanger|add_class:"form-control form-control-sm" }}</div>
        <div class="col-md-6 mb-2">{{ form.rack_per_hanger.label_tag }} {{ form.rack_per_hanger|add_class:"form-control form-control-sm" }}</div>
        <div class="col-md-6 mb-2">{{ form.product_per_rack.label_tag }} {{ form.product_per_rack|add_class:"form-control form-control-sm" }}</div>
        <div class="col-md-6 mb-2">{{ form.total_quantity.label_tag }} {{ form.total_quantity|add_class:"form-control form-control-sm" }}</div>
        <div class="col-md-6 mb-2">{{ form.total_time.label_tag }} {{ form.total_time|add_class:"form-control form-control-sm" }}</div>
        <div class="col-md-6 mb-2">{{ form.injection_item.label_tag }} {{ form.injection_item|add_class:"form-select form-select-sm" }}</div>
    </div>

    <hr>

    <!-- 🧱 부자재 구성 -->
    <h6>🧱 부자재 구성</h6>
    {{ formset.management_form }}
    <div id="submaterial-formset">
        {% for subform in formset %}
        <div class="form-row row mb-2 submaterial-form">
            <div class="col-md-5">{{ subform.submaterial.label_tag }} {{ subform.submaterial }}</div>
            <div class="col-md-5">{{ subform.quantity.label_tag }} {{ subform.quantity }}</div>
            <div class="col-md-2">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSubForm(this)">삭제</button>
                {{ subform.DELETE }}
            </div>
        </div>
        {% endfor %}
    </div>
    <!-- 숨겨진 템플릿 -->
    <div class="form-row row mb-2 submaterial-form d-none" id="submaterial-form-template">
        <div class="col-md-5"><label>부자재</label><select class="form-select form-select-sm" name="submaterial"></select></div>
        <div class="col-md-5"><label>소요 수량</label><input type="number" class="form-control form-control-sm" name="quantity" /></div>
        <div class="col-md-2"><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSubForm(this)">삭제</button><input type="checkbox" class="d-none" name="DELETE"></div>
    </div>
    <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addSubForm()">+ 부자재 추가</button>

    <hr>

    <!-- 📎 파일 업로드 -->
    <h6>📎 파일 업로드</h6>
    <div class="row">
        <div class="col-md-6 mb-2">
            {{ form.ppap_file.label_tag }}
            {{ form.ppap_file|add_class:"form-control form-control-sm" }}
            {% if form.instance.ppap_file %}
                <div><a href="{{ form.instance.ppap_file.url }}" target="_blank">📄 다운로드</a></div>
            {% endif %}
        </div>
        <div class="col-md-6 mb-2">
            {{ form.run_rate_file.label_tag }}
            {{ form.run_rate_file|add_class:"form-control form-control-sm" }}
            {% if form.instance.run_rate_file %}
                <div><a href="{{ form.instance.run_rate_file.url }}" target="_blank">📄 다운로드</a></div>
            {% endif %}
        </div>
    </div>

    <hr>

    <!-- 🧩 부가정보 -->
    <h6>🧩 부가정보</h6>
    <div class="row">
        <div class="col-md-6 mb-2">{{ form.finishing.label_tag }} {{ form.finishing|add_class:"form-control form-control-sm" }}</div>
        <div class="col-md-6 mb-2">{{ form.grade.label_tag }} {{ form.grade|add_class:"form-control form-control-sm" }}</div>
        <div class="col-md-6 mb-2">{{ form.injection_info.label_tag }} {{ form.injection_info|add_class:"form-control form-control-sm" }}</div>
        <div class="col-md-6 mb-2">{{ form.plating.label_tag }} {{ form.plating|add_class:"form-control form-control-sm" }}</div>
        <div class="col-md-6 mb-2">{{ form.assembly_packaging.label_tag }} {{ form.assembly_packaging|add_class:"form-control form-control-sm" }}</div>
        <div class="col-md-6 mb-2">{{ form.final_delivery.label_tag }} {{ form.final_delivery|add_class:"form-control form-control-sm" }}</div>
    </div>

    <div class="mt-3">
        <button type="submit" class="btn btn-success btn-sm">저장</button>
        <a href="{% url 'product:product_list' %}" class="btn btn-secondary btn-sm">← 목록</a>
    </div>
</form>

<!-- ✅ JavaScript -->
<script>
    let formIdx = {{ formset.total_form_count|default:0 }};

    function addSubForm() {
        const formset = document.getElementById("submaterial-formset");
        const template = document.getElementById("submaterial-form-template");
        const newForm = template.cloneNode(true);
        newForm.classList.remove("d-none");
        newForm.removeAttribute("id");

        newForm.querySelectorAll("input, select").forEach(el => {
            const name = el.getAttribute("name");
            if (name) {
                const newName = `productsubmaterial_set-${formIdx}-${name}`;
                el.setAttribute("name", newName);
                el.setAttribute("id", `id_${newName}`);
                if (el.tagName === "SELECT") el.selectedIndex = 0;
                if (el.type === "number") el.value = "";
                if (el.type === "checkbox") el.checked = false;
            }
        });

        document.getElementById("id_productsubmaterial_set-TOTAL_FORMS").value = ++formIdx;
        formset.appendChild(newForm);
    }

    function removeSubForm(btn) {
        const row = btn.closest(".submaterial-form");
        const del = row.querySelector("input[type='checkbox']");
        if (del) {
            del.checked = true;
            row.style.display = 'none';
        } else {
            row.remove();
            formIdx--;
            document.getElementById("id_productsubmaterial_set-TOTAL_FORMS").value = formIdx;
        }
    }
</script>
{% endblock %}
