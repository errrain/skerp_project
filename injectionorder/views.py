# injectionorder/views.py (patched)
import csv
import json
from datetime import datetime, timedelta
from datetime import date

from django.http import JsonResponse, HttpResponse
from django.shortcuts import render, redirect, get_object_or_404
from django.db import transaction
from django.db.models import Q
from django.utils import timezone
from django.views.decorators.http import require_POST
from django.contrib.auth.decorators import login_required
from django.core.paginator import Paginator

from .models import InjectionOrder, InjectionOrderItem, OrderStatus, FlowStatus
from .forms import InjectionOrderForm
from utils.lot import get_next_lot
from injection.models import Injection

# =========================
# Ïú†Ìã∏
# =========================
def _parse_date(s: str):
    if not s:
        return None
    try:
        return datetime.strptime(s, "%Y-%m-%d").date()
    except Exception:
        return None


def _latest_unit_price(injection) -> int:
    """
    injection.prices(Îã®Í∞Ä ÌûàÏä§ÌÜ†Î¶¨)ÏóêÏÑú ÏµúÏã† Îã®Í∞ÄÎ•º ÏïàÏ†ÑÌïòÍ≤å Í∞ÄÏ†∏Ïò®Îã§.
    - ÌïÑÎìú Ï°¥Ïû¨ Ïö∞ÏÑ†ÏàúÏúÑ: created_dt -> date -> id
    """
    if not hasattr(injection, "prices"):
        return 0
    qs = injection.prices.all()
    field_names = {f.name for f in qs.model._meta.get_fields()}
    if "created_dt" in field_names:
        obj = qs.order_by("-created_dt").first()
    elif "date" in field_names:
        obj = qs.order_by("-date").first()
    else:
        obj = qs.order_by("-id").first()
    return obj.price if obj else 0


# =========================
# Î∞úÏ£º Îì±Î°ù
# =========================
@login_required
@transaction.atomic
def injection_order_create(request):
    if request.method == 'POST':
        form = InjectionOrderForm(request.POST)

        # ÏÑ†ÌÉù Ìñâ ÏàòÏßë
        rows = []
        idx = 0
        while True:
            inj_id = request.POST.get(f'form-{idx}-injection')
            if not inj_id:
                break
            if request.POST.get(f'form-{idx}-checked'):
                qty = request.POST.get(f'form-{idx}-quantity')
                date = request.POST.get(f'form-{idx}-expected_date')
                if not qty or not str(qty).isdigit() or int(qty) <= 0 or not date:
                    form.add_error(None, f"{idx+1}Ìñâ: ÏàòÎüâ/ÏûÖÍ≥†ÏòàÏ†ïÏùºÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.")
                else:
                    rows.append((inj_id, int(qty), date))
            idx += 1

        if not rows:
            form.add_error(None, "Î∞úÏ£º ÌíàÎ™©ÏùÑ 1Í∞ú Ïù¥ÏÉÅ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.")

        if not form.is_valid():
            return render(request, 'injectionorder/order_form.html', {'form': form})

        # ÌñâÎßàÎã§ Í∞úÎ≥Ñ Ìó§Îçî(LOT) + ÌíàÎ™© 1Í±¥ ÏÉùÏÑ±
        vendor = form.cleaned_data['vendor']
        order_date = form.cleaned_data['order_date']

        for inj_id, qty, date in rows:
            order = InjectionOrder(
                vendor=vendor,
                order_date=order_date,
                order_lot=get_next_lot('OR', anchor_dt=order_date),
                due_date=date,
                created_by=request.user,
                order_status=OrderStatus.NEW,
                flow_status=FlowStatus.NG,
            )
            order.save()

            injection = get_object_or_404(Injection, id=inj_id)
            unit_price = _latest_unit_price(injection)

            InjectionOrderItem.objects.create(
                order=order,
                injection=injection,
                quantity=qty,
                expected_date=date,
                unit_price=unit_price,
                total_price=qty * unit_price,
                created_by=request.user,
            )

        return redirect('injectionorder:order_list')

    form = InjectionOrderForm()
    return render(request, 'injectionorder/order_form.html', {'form': form})


# =========================
# Î∞úÏ£º Î™©Î°ù
# =========================
@login_required
def order_list(request):
    items = (InjectionOrderItem.objects
             .select_related('order', 'injection', 'order__vendor',
                             'order__created_by', 'order__updated_by')
             .filter(order__dlt_yn='N')
             .order_by('-order__order_date'))

    # üìÖ Í∏∞Î≥∏ Ïõî Î≤îÏúÑ Í≥ÑÏÇ∞ (Ïù¥Î≤à Îã¨ 1Ïùº ~ ÎßêÏùº)
    today = date.today()
    month_start = today.replace(day=1)
    if today.month == 12:
        month_end = today.replace(year=today.year + 1, month=1, day=1) - timedelta(days=1)
    else:
        month_end = today.replace(month=today.month + 1, day=1) - timedelta(days=1)

    # ‚îÄ Í≤ÄÏÉâ ÌååÎùºÎØ∏ÌÑ∞
    order_date_start = _parse_date(request.GET.get('order_date_start')) or month_start
    order_date_end = _parse_date(request.GET.get('order_date_end')) or month_end
    expected_date_start = _parse_date(request.GET.get('expected_date_start')) or month_start
    expected_date_end = _parse_date(request.GET.get('expected_date_end')) or month_end
    vendor_name = (request.GET.get('vendor') or '').strip()
    product_name = (request.GET.get('product') or '').strip()
    order_status = (request.GET.get('order_status') or '').strip()
    flow_status = (request.GET.get('flow_status') or '').strip()

    # üìå ÎÇ†Ïßú ÌïÑÌÑ∞: Î∞úÏ£ºÏùº Î≤îÏúÑ OR ÏûÖÍ≥†ÏòàÏ†ïÏùº Î≤îÏúÑ
    date_q = (
        Q(order__order_date__range=(order_date_start, order_date_end)) |
        Q(expected_date__range=(expected_date_start, expected_date_end))
    )
    items = items.filter(date_q)

    if vendor_name:
        items = items.filter(order__vendor__name__icontains=vendor_name)
    if product_name:
        items = items.filter(injection__name__icontains=product_name)
    if order_status:
        items = items.filter(order__order_status=order_status)
    if flow_status:
        items = items.filter(order__flow_status=flow_status)

    # ÌéòÏù¥Ïßï
    page = request.GET.get('page', 1)
    paginator = Paginator(items, 20)
    page_obj = paginator.get_page(page)

    def _qs_without_page():
        qd = request.GET.copy()
        qd.pop('page', None)
        return qd.urlencode()

    return render(request, 'injectionorder/order_list.html', {
        'order_items': page_obj,
        'page_obj': page_obj,
        'querystring': _qs_without_page(),
        'order_status_choices': OrderStatus.choices,
        'flow_status_choices': FlowStatus.choices,
        # ÏûÖÎ†• Í∏∞Î≥∏Í∞í ÏÑ∏ÌåÖÏö© (ÏµúÏ¥à ÏßÑÏûÖ ÏãúÏóêÎèÑ Í∞íÏù¥ Ï±ÑÏõåÏ†∏ Î≥¥Ïù¥ÎèÑÎ°ù)
        'order_date_start_default': order_date_start.strftime('%Y-%m-%d'),
        'order_date_end_default': order_date_end.strftime('%Y-%m-%d'),
        'expected_date_start_default': expected_date_start.strftime('%Y-%m-%d'),
        'expected_date_end_default': expected_date_end.strftime('%Y-%m-%d'),
    })

# üü¢ ÏóëÏÖÄ(CSV) Îã§Ïö¥Î°úÎìú: ÌéòÏù¥Ïßï Î¨¥Ïãú, Í≤ÄÏÉâÏ°∞Í±¥ ÎèôÏùº Ï†ÅÏö©
@login_required
def order_export(request):
    qs = (InjectionOrderItem.objects
          .select_related('order', 'injection', 'order__vendor',
                          'order__created_by', 'order__updated_by')
          .filter(order__dlt_yn='N'))

    # Ïù¥Î≤à Îã¨ 1Ïùº~ÎßêÏùº Í∏∞Î≥∏Í∞í (views.listÏôÄ ÎèôÏùº Î°úÏßÅ)
    today = date.today()
    month_start = today.replace(day=1)
    if today.month == 12:
        month_end = today.replace(year=today.year + 1, month=1, day=1) - timedelta(days=1)
    else:
        month_end = today.replace(month=today.month + 1, day=1) - timedelta(days=1)

    # Í≤ÄÏÉâÍ∞í Ìï¥ÏÑù (ÏóÜÏúºÎ©¥ Í∏∞Î≥∏Í∞í Ï†ÅÏö©)
    def _parse_date(s):
        from datetime import datetime
        try:
            return datetime.strptime(s, "%Y-%m-%d").date()
        except Exception:
            return None

    order_date_start = _parse_date(request.GET.get('order_date_start')) or month_start
    order_date_end = _parse_date(request.GET.get('order_date_end')) or month_end
    expected_date_start = _parse_date(request.GET.get('expected_date_start')) or month_start
    expected_date_end = _parse_date(request.GET.get('expected_date_end')) or month_end
    vendor_name = (request.GET.get('vendor') or '').strip()
    product_name = (request.GET.get('product') or '').strip()
    order_status = (request.GET.get('order_status') or '').strip()
    flow_status = (request.GET.get('flow_status') or '').strip()

    qs = qs.filter(
        Q(order__order_date__range=(order_date_start, order_date_end)) |
        Q(expected_date__range=(expected_date_start, expected_date_end))
    )
    if vendor_name:
        qs = qs.filter(order__vendor__name__icontains=vendor_name)
    if product_name:
        qs = qs.filter(injection__name__icontains=product_name)
    if order_status:
        qs = qs.filter(order__order_status=order_status)
    if flow_status:
        qs = qs.filter(order__flow_status=flow_status)

    # ---------- CSV ÏùëÎãµ (UTF-8 BOM Ï∂îÍ∞ÄÎ°ú ÌïúÍ∏Ä Íπ®Ïßê Î∞©ÏßÄ) ----------
    response = HttpResponse(content_type='text/csv; charset=utf-8')
    filename = f"injection_orders_{today.strftime('%Y%m%d')}.csv"
    response['Content-Disposition'] = f'attachment; filename="{filename}"'

    # ‚òÖ ExcelÏö© BOM (UTF-8-SIG)
    response.write('\ufeff')

    writer = csv.writer(response, lineterminator='\n')

    writer.writerow([
        'Î∞úÏ£ºLOT','Î∞úÏ£ºÏ≤ò','Î∞úÏ£ºÏùº','ÌíàÎ™Ö','ÏàòÎüâ','ÏûÖÍ≥†ÏòàÏ†ïÏùº',
        'Î∞úÏ£ºÏÉÅÌÉú','ÏßÑÌñâÏÉÅÌÉú','Ï∑®ÏÜåÏùºÏãú','Ï∑®ÏÜåÏûê',
        'Îì±Î°ùÏùºÏãú','Îì±Î°ùÏûê','ÏàòÏ†ïÏùºÏãú','ÏàòÏ†ïÏûê','Îã®Í∞Ä','Ìï©Í≥ÑÍ∏àÏï°'
    ])

    def dstr(d):   # date -> 'YYYY-MM-DD' or '-'
        return d.strftime('%Y-%m-%d') if d else '-'

    def dtstr(dt): # datetime -> 'YYYY-MM-DD HH:MM' or '-'
        return dt.strftime('%Y-%m-%d %H:%M') if dt else '-'

    def ustr(u):   # user -> full_name/username or '-'
        if not u:
            return '-'
        return getattr(u, 'full_name', '') or getattr(u, 'username', '') or '-'

    for it in qs:
        o = it.order
        writer.writerow([
            o.order_lot or '-',
            getattr(o.vendor, 'name', '-') or '-',
            dstr(o.order_date),
            getattr(it.injection, 'name', '-') or '-',
            it.quantity if it.quantity is not None else 0,
            dstr(it.expected_date),

            o.get_order_status_display() or '-',
            o.get_flow_status_display() or '-',
            dtstr(o.cancel_at),
            ustr(o.cancel_by),

            dtstr(o.created_at),
            ustr(o.created_by),
            dtstr(o.updated_at),
            ustr(o.updated_by),

            it.unit_price if it.unit_price is not None else 0,
            it.total_price if it.total_price is not None else 0,
        ])

    return response

# =========================
# Î∞úÏ£º ÏàòÏ†ï
# =========================
@login_required
@transaction.atomic
def injection_order_edit(request, order_id):
    order = get_object_or_404(InjectionOrder, id=order_id)
    items = InjectionOrderItem.objects.filter(order=order).select_related('injection')

    if request.method == 'POST':
        form = InjectionOrderForm(request.POST, instance=order)
        if form.is_valid():
            order = form.save(commit=False)
            order.updated_by = request.user
            order.save()

            InjectionOrderItem.objects.filter(order=order).delete()

            index = 0
            while True:
                inj_id = request.POST.get(f'form-{index}-injection')
                qty = request.POST.get(f'form-{index}-quantity')
                date = request.POST.get(f'form-{index}-expected_date')
                is_checked = request.POST.get(f'form-{index}-checked')
                if not inj_id:
                    break

                if is_checked and qty and date:
                    injection = get_object_or_404(Injection, id=inj_id)
                    unit_price = _latest_unit_price(injection)

                    InjectionOrderItem.objects.create(
                        order=order,
                        injection=injection,
                        quantity=int(qty),
                        expected_date=date,
                        unit_price=unit_price,
                        total_price=int(qty) * unit_price,
                        created_by=request.user,
                    )
                index += 1

            return redirect('injectionorder:order_list')
    else:
        form = InjectionOrderForm(instance=order)

    existing_items = [
        {
            "injection": {
                "id": item.injection.id,
                "name": item.injection.name,
                "alias": item.injection.alias,
            },
            "quantity": item.quantity,
            "expected_date": item.expected_date.strftime('%Y-%m-%d'),
        }
        for item in items
    ]

    return render(request, 'injectionorder/order_form.html', {
        'form': form,
        'edit_mode': True,
        'order_id': order.id,
        'existing_items_json': json.dumps(existing_items),
    })


# =========================
# Î∞úÏ£º Ï∑®ÏÜå (Í∏∞Ï°¥ delete ÎåÄÏ≤¥)
# =========================
@login_required
@require_POST
def order_cancel(request, order_id):
    order = get_object_or_404(InjectionOrder, id=order_id, dlt_yn='N')
    if not order.can_cancel:
        # Ïù¥ÎØ∏ Ï∑®ÏÜåÎêòÏóàÍ±∞ÎÇò ÏûÖÍ≥† ÏßÑÌñâ Ï§ëÏù¥Î©¥ Ï∑®ÏÜå Î∂àÍ∞Ä
        return redirect('injectionorder:order_list')

    order.mark_cancelled(user=request.user, reason="ÏÇ¨Ïö©Ïûê ÏöîÏ≤≠ Ï∑®ÏÜå")
    return redirect('injectionorder:order_list')


# =========================
# ÌòëÎ†•ÏÇ¨Î≥Ñ ÏÇ¨Ï∂úÌíà Î™©Î°ù Î∞òÌôò(AJAX)
# =========================
@login_required
def get_injections_by_vendor(request):
    vendor_id = request.GET.get('vendor_id')
    if not vendor_id:
        return JsonResponse({'injections': []})

    qs = Injection.objects.filter(
        vendor_id=vendor_id, use_yn='Y', delete_yn='N'
    ).values('id', 'alias', 'name')

    today = timezone.now().strftime('%Y-%m-%d')
    data = [
        {'id': r['id'], 'alias': r['alias'], 'name': r['name'], 'today': today}
        for r in qs
    ]
    return JsonResponse({'injections': data})