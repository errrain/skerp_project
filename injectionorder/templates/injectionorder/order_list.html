{% extends 'base.html' %}
{% load humanize %}
{% block content %}
<style>
  .badge.status { font-size:.85rem; padding:.35rem .65rem; border-radius:9999px; font-weight:700; letter-spacing:.02em; }
</style>
<div class="d-flex justify-content-between align-items-center mb-3" style="font-size: 0.9rem;">
  <h4 class="mb-0">ì‚¬ì¶œ ë°œì£¼ ëª©ë¡</h4>
  <a href="{% url 'injectionorder:order_create' %}" class="btn btn-sm btn-success">+ ì‹ ê·œ ë°œì£¼ ë“±ë¡</a>
</div>

<form method="get" class="row g-2 mb-3 align-items-end">
  <!-- ë‚ ì§œ ê¸°ë³¸ê°’: ì´ë²ˆë‹¬ 1ì¼~ë§ì¼ ìë™ ì„¸íŒ… -->
  <div class="col-auto">
    <label class="form-label mb-1 small">ë°œì£¼ì¼ From</label>
    <input type="date" name="order_date_start"
           value="{{ request.GET.order_date_start|default:order_date_start_default }}"
           class="form-control form-control-sm">
  </div>
  <div class="col-auto">
    <label class="form-label mb-1 small">ë°œì£¼ì¼ To</label>
    <input type="date" name="order_date_end"
           value="{{ request.GET.order_date_end|default:order_date_end_default }}"
           class="form-control form-control-sm">
  </div>
  <div class="col-auto">
    <label class="form-label mb-1 small">ì…ê³ ì˜ˆì •ì¼ From</label>
    <input type="date" name="expected_date_start"
           value="{{ request.GET.expected_date_start|default:expected_date_start_default }}"
           class="form-control form-control-sm">
  </div>
  <div class="col-auto">
    <label class="form-label mb-1 small">ì…ê³ ì˜ˆì •ì¼ To</label>
    <input type="date" name="expected_date_end"
           value="{{ request.GET.expected_date_end|default:expected_date_end_default }}"
           class="form-control form-control-sm">
  </div>

  <div class="col-auto">
    <label class="form-label mb-1 small">ë°œì£¼ì²˜</label>
    <input type="text" name="vendor"
           value="{{ request.GET.vendor|default:'' }}"
           class="form-control form-control-sm" placeholder="ë°œì£¼ì²˜">
  </div>
  <div class="col-auto">
    <label class="form-label mb-1 small">í’ˆëª…</label>
    <input type="text" name="product"
           value="{{ request.GET.product|default:'' }}"
           class="form-control form-control-sm" placeholder="í’ˆëª…">
  </div>

  <div class="col-auto">
    <label class="form-label mb-1 small">ë°œì£¼ìƒíƒœ</label>
    <select name="order_status" class="form-select form-select-sm">
      <option value="">ì „ì²´</option>
      {% for code,label in order_status_choices %}
        <option value="{{ code }}" {% if request.GET.order_status == code %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-auto">
    <label class="form-label mb-1 small">ì§„í–‰ìƒíƒœ</label>
    <select name="flow_status" class="form-select form-select-sm">
      <option value="">ì „ì²´</option>
      {% for code,label in flow_status_choices %}
        <option value="{{ code }}" {% if request.GET.flow_status == code %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-auto d-flex align-items-end gap-2">
    <button type="submit" class="btn btn-sm btn-primary">ê²€ìƒ‰</button>
    <!-- ğŸŸ¢ ì—‘ì…€(CSV) ë‹¤ìš´ë¡œë“œ (í˜ì´ì§• ë¬´ê´€, ë™ì¼ ê²€ìƒ‰ì¡°ê±´ ì ìš©) -->
    <a class="btn btn-sm btn-outline-secondary"
       href="{% url 'injectionorder:order_export' %}{% if querystring %}?{{ querystring }}{% endif %}">
       ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    </a>
  </div>
</form>
<table class="table table-striped table-bordered table-sm text-center align-middle" style="font-size:12px; border:1px solid #000;">
  <thead class="table-light">
    <tr>
      <th class="fw-bold table-header">ë°œì£¼ LOT</th>
      <th class="fw-bold table-header">ë°œì£¼ì²˜</th>
      <th class="fw-bold table-header">ë°œì£¼ì¼</th>
      <th class="fw-bold table-header">í’ˆëª…</th>
      <th class="fw-bold table-header">ìˆ˜ëŸ‰</th>
      <th class="fw-bold table-header">ì…ê³  ì˜ˆì •ì¼</th>
      <!-- ìƒíƒœ ê°€ì‹œì„± ê°•í™” -->
      <th class="fw-bold table-header" >ë°œì£¼ìƒíƒœ</th>
      <th class="fw-bold table-header">ì§„í–‰ìƒíƒœ</th>
      <th class="fw-bold table-header">ì·¨ì†Œì¼ì‹œ</th>
      <th class="fw-bold table-header">ì·¨ì†Œì</th>
      <th class="fw-bold table-header">ë°°ì†¡ë“±ë¡ì‹œê°</th>
      <th class="fw-bold table-header">ë“±ë¡ì¼ì‹œ</th>
      <th class="fw-bold table-header">ë“±ë¡ì</th>
      <th class="fw-bold table-header">ìˆ˜ì •ì¼ì‹œ</th>
      <th class="fw-bold table-header">ìˆ˜ì •ì</th>
      <th class="fw-bold table-header">ë‹¨ê°€</th>
      <th class="fw-bold table-header">í•©ê³„ê¸ˆì•¡</th>
      <th class="fw-bold table-header">ê´€ë¦¬</th>
    </tr>
  </thead>
  <tbody>
    {% for item in order_items %}
    <tr class="{% if item.order.order_status != 'NEW' %}table-secondary{% endif %}">
      <td>{{ item.order.order_lot }}</td>
      <td class="text-start">{{ item.order.vendor.name }}</td>
      <td style="white-space:nowrap;">{{ item.order.order_date|date:"Y-m-d" }}</td>
      <td class="text-start">{{ item.injection.name }}</td>
      <td>{{ item.quantity|intcomma }}</td>
      <td style="white-space:nowrap;">{{ item.expected_date|date:"Y-m-d" }}</td>

<td>
  <span class="badge status {% if item.order.order_status == 'NEW' %}bg-success text-white{% else %}bg-danger text-white{% endif %}">
    {{ item.order.get_order_status_display }}
  </span>
</td>

<td>
  {% if item.order.flow_status == 'NG' %}
    <!-- ë¯¸ì…ê³ : ì—°í•œ ë°°ê²½ + í…Œë‘ë¦¬ë¡œ ëŒ€ë¹„ -->
    <span class="badge status bg-light text-secondary border border-secondary">
      {{ item.order.get_flow_status_display }}
    </span>
  {% elif item.order.flow_status == 'RDY' %}
    <!-- ì…ê³ ëŒ€ê¸°: ê²½ê³ ìƒ‰ -->
    <span class="badge status bg-warning text-dark">
      {{ item.order.get_flow_status_display }}
    </span>
  {% elif item.order.flow_status == 'RCV' %}
    <!-- ì…ê³ ì™„ë£Œ: ì •ë³´ìƒ‰ -->
    <span class="badge status bg-info text-dark">
      {{ item.order.get_flow_status_display }}
    </span>
  {% elif item.order.flow_status == 'RET' %}
    <!-- ë°˜ì¶œ: ì§„í•œ ëŒ€ë¹„ -->
    <span class="badge status bg-dark text-white">
      {{ item.order.get_flow_status_display }}
    </span>
  {% else %}
    <span class="badge status bg-secondary text-white">
      {{ item.order.get_flow_status_display }}
    </span>
  {% endif %}
</td>
      <td style="white-space:nowrap;">{% if item.order.cancel_at %}{{ item.order.cancel_at|date:"Y-m-d H:i" }}{% else %}-{% endif %}</td>
      <td>
        {% with u=item.order.cancel_by %}
          {% if u %}{{ u.full_name|default:u.username }}{% else %}-{% endif %}
        {% endwith %}
      </td>
      <td style="white-space:nowrap;">{% if item.order.shipping_registered_at %}{{ item.order.shipping_registered_at|date:"Y-m-d H:i" }}{% else %}-{% endif %}</td>

      <td style="white-space:nowrap;">{{ item.order.created_at|date:"Y-m-d H:i" }}</td>
      <td>{% with u=item.order.created_by %}{% if u %}{{ u.full_name|default:u.username }}{% else %}-{% endif %}{% endwith %}</td>
      <td style="white-space:nowrap;">{{ item.order.updated_at|date:"Y-m-d H:i" }}</td>
      <td>{% with u=item.order.updated_by %}{% if u %}{{ u.full_name|default:u.username }}{% else %}-{% endif %}{% endwith %}</td>

      <td class="text-end">{{ item.unit_price|intcomma }}</td>
      <td class="text-end">{{ item.total_price|intcomma }}</td>

      <td>
        <a href="{% url 'injectionorder:order_edit' item.order.id %}" class="btn btn-sm btn-outline-primary">ìˆ˜ì •</a>
        <form method="post" action="{% url 'injectionorder:order_cancel' item.order.id %}" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-sm btn-outline-danger"
                  {% if item.order.order_status != 'NEW' or item.order.flow_status != 'NG' %}disabled title="ì·¨ì†Œ ë¶ˆê°€ ìƒíƒœ"{% endif %}
                  onclick="return confirm('ì´ ë°œì£¼ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
            ì·¨ì†Œ
          </button>
        </form>
      </td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="18" class="text-center text-muted">ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<!-- ğŸ” í˜ì´ì§•ë°”: í˜ì´ì§€ ìˆ˜ 1ì´ì–´ë„ í•­ìƒ ë…¸ì¶œ -->
<nav aria-label="í˜ì´ì§€ë„¤ì´ì…˜">
  <ul class="pagination pagination-sm justify-content-center">

    <!-- ì²˜ìŒ -->
    <li class="page-item {% if page_obj.number == 1 %}disabled{% endif %}">
      {% if page_obj.number == 1 %}
        <span class="page-link">Â« ì²˜ìŒ</span>
      {% else %}
        <a class="page-link" href="?page=1{% if querystring %}&{{ querystring }}{% endif %}">Â« ì²˜ìŒ</a>
      {% endif %}
    </li>

    <!-- ì´ì „ -->
    <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
      {% if page_obj.has_previous %}
        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if querystring %}&{{ querystring }}{% endif %}">â€¹ ì´ì „</a>
      {% else %}
        <span class="page-link">â€¹ ì´ì „</span>
      {% endif %}
    </li>

    <!-- í˜„ì¬/ì „ì²´ -->
    <li class="page-item active">
      <span class="page-link">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
    </li>

    <!-- ë‹¤ìŒ -->
    <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
      {% if page_obj.has_next %}
        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if querystring %}&{{ querystring }}{% endif %}">ë‹¤ìŒ â€º</a>
      {% else %}
        <span class="page-link">ë‹¤ìŒ â€º</span>
      {% endif %}
    </li>

    <!-- ë -->
    <li class="page-item {% if page_obj.number == page_obj.paginator.num_pages %}disabled{% endif %}">
      {% if page_obj.number == page_obj.paginator.num_pages %}
        <span class="page-link">ë Â»</span>
      {% else %}
        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if querystring %}&{{ querystring }}{% endif %}">ë Â»</a>
      {% endif %}
    </li>
  </ul>
</nav>


{% endblock %}