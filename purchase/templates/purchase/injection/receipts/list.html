{# templates/purchase/injection/receipts/list.html #}
{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
{% if messages %}
  <div class="mb-2">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  </div>
{% endif %}

<style>
  /* í‘œì‹œ ì „ìš© ì¹©(ë²„íŠ¼ ëª¨ì–‘) */
  .btn-static { pointer-events:none; opacity:1!important; filter:none!important; font-weight:600; letter-spacing:.2px; }
  .btn-static.btn-outline-secondary { background:#fff; }
  .btn-chip { min-width:64px; text-align:center; } /* ë¶ˆí•©ê²© í­ ê¸°ì¤€ í†µì¼ */
</style>

<div class="d-flex justify-content-between align-items-center mb-3" style="font-size:.9rem;">
  <h4 class="mb-0">ì‚¬ì¶œ ì…ê³  ëª©ë¡</h4>
</div>

{# ğŸ” ê²€ìƒ‰ í¼: order_list ìŠ¤íƒ€ì¼ ë§ì¶¤ #}
<form method="get" class="row g-2 mb-3 align-items-end border border-dark rounded p-3" style="background:#f8f9fa;">
  <div class="col-auto">
    <label class="form-label mb-1 small">ë°œì£¼ì²˜</label>
    <input type="text" name="vendor" class="form-control form-control-sm" value="{{ request.GET.vendor }}">
  </div>
  <div class="col-auto">
    <label class="form-label mb-1 small">í’ˆëª…</label>
    <input type="text" name="product" class="form-control form-control-sm" value="{{ request.GET.product }}">
  </div>

  <div class="col-auto">
    <label class="form-label mb-1 small">ë°œì£¼ì¼ From</label>
    <input type="date" name="order_date_from" class="form-control form-control-sm" value="{{ filter.order_date_from }}">
  </div>
  <div class="col-auto">
    <label class="form-label mb-1 small">ë°œì£¼ì¼ To</label>
    <input type="date" name="order_date_to"   class="form-control form-control-sm" value="{{ filter.order_date_to }}">
  </div>

  <div class="col-auto">
    <label class="form-label mb-1 small">ê²€ì‚¬ì¼ From</label>
    <input type="date" name="insp_date_from"  class="form-control form-control-sm" value="{{ filter.insp_date_from }}">

  </div>
  <div class="col-auto">
    <label class="form-label mb-1 small">ê²€ì‚¬ì¼ To</label>
    <input type="date" name="insp_date_to"    class="form-control form-control-sm" value="{{ filter.insp_date_to }}">
  </div>

  <div class="col-auto">
    <label class="form-label mb-1 small">ìƒíƒœ</label>
    <select name="status" class="form-select form-select-sm">
      <option value="">-- ì „ì²´ --</option>
      <option value="ì…ê³ ëŒ€ê¸°" {% if request.GET.status == 'ì…ê³ ëŒ€ê¸°' %}selected{% endif %}>ì…ê³ ëŒ€ê¸°</option>
      <option value="ì…ê³ ì™„ë£Œ" {% if request.GET.status == 'ì…ê³ ì™„ë£Œ' %}selected{% endif %}>ì…ê³ ì™„ë£Œ</option>
    </select>
  </div>

  <div class="col-auto d-flex align-items-end gap-2">
    <button type="submit" class="btn btn-sm btn-primary">ê²€ìƒ‰</button>
    <a href="{% url 'purchase:inj_receipt_list' %}" class="btn btn-sm btn-outline-secondary">ì´ˆê¸°í™”</a>
      <!-- ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ê²€ìƒ‰ì¡°ê±´ ìœ ì§€) -->
  <a class="btn btn-sm btn-outline-secondary"
     href="{% url 'purchase:inj_receipt_export' %}{% if querystring %}?{{ querystring }}{% endif %}">
    ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
  </a>
  </div>
</form>

{# âœ… ì¼ê´„ ì…ê³  í¼ #}
<form method="post" action="{% url 'purchase:inj_receipt_add_bulk' %}" id="bulk-form" class="mb-2">
  {% csrf_token %}
  <div class="d-flex gap-2 align-items-center">
    <label class="me-1 small mb-0">ì…ê³ ì¼</label>
    <input type="date" class="form-control form-control-sm" style="max-width:180px"
           name="receipt_date" value="{{ today|date:'Y-m-d' }}">
    <button class="btn btn-primary btn-sm">ì„ íƒ í–‰ ì¼ê´„ ì…ê³ </button>
  </div>

  <div class="table-responsive mt-2">
    <table class="table table-striped table-bordered table-sm text-center align-middle" style="font-size:12px; border:1px solid #000;">
      <thead class="table-light">
        <tr>
          <th style="width:28px;"><input type="checkbox" id="chk-all"></th>
          <th class="fw-bold table-header">ë°œì£¼LOT</th>
          <th class="fw-bold table-header">ë°œì£¼ì²˜</th>
          <th class="fw-bold table-header">í’ˆëª…</th>
          <th class="fw-bold table-header">ìˆ˜ëŸ‰</th>
          <th class="fw-bold table-header">ë°œì£¼ì¼</th>
          <th class="fw-bold table-header">ë°°ì†¡ì¼</th>
          <th class="fw-bold table-header">ê²€ì‚¬ì¼</th>
          <th class="fw-bold table-header">ê²€ì‚¬ê²°ê³¼</th>
          <th class="fw-bold table-header">ìƒíƒœ</th>
          <th class="fw-bold table-header">ì…ê³  í—¤ë”LOT</th>
          <th class="fw-bold table-header" style="width:180px;">ë¹„ê³ </th>
          <th class="fw-bold table-header" style="width:170px;">ê´€ë¦¬</th>
        </tr>
      </thead>
      <tbody>
      {% for o in page_obj.object_list %}
        <tr>
          <td>
            <input type="checkbox" class="row-check"
                   name="selected_ids" value="{{ o.id }}"
                   {% if o.insp_status_display != "í•©ê²©" %}disabled title="ìµœì‹  ìˆ˜ì…ê²€ì‚¬ 'í•©ê²©'ë§Œ ì£¼ë¬¸ë‹¨ìœ„ ì¼ê´„ì…ê³  ê°€ëŠ¥"{% endif %}>
          </td>
          <td>{{ o.order_lot }}</td>
          <td>{{ o.vendor.name|default:"-" }}</td>
          <td>
            {# âœ” first()ëŠ” í…œí”Œë¦¿ì—ì„œ ì‹¤í–‰ ì•ˆ ë¨ â†’ all|first ë¡œ ì²« í•­ëª© #}
            {% with first=o.items.all|first %}
              {% if first and first.injection %}
                {{ first.injection.name }}
              {% elif first and first.product %}
                {{ first.product.name }}
              {% elif first and first.name %}
                {{ first.name }}
              {% else %}
                -
              {% endif %}
            {% endwith %}
          </td>
          <td>{{ o.qty_sum|default:0|intcomma }}</td>
          <td>{% if o.order_date %}{{ o.order_date|date:"Y-m-d" }}{% else %}-{% endif %}</td>
          <td>{% if o.shipping_date %}{{ o.shipping_date|date:"Y-m-d" }}{% else %}-{% endif %}</td>
          <td>{% if o.latest_insp_date %}{{ o.latest_insp_date|date:"Y-m-d" }}{% else %}-{% endif %}</td>
          <td>
            {% if o.insp_status_display == "í•©ê²©" %}
              <span class="btn btn-sm btn-success btn-static btn-chip">í•©ê²©</span>
            {% elif o.insp_status_display == "ë¶ˆí•©ê²©" %}
              <span class="btn btn-sm btn-danger btn-static btn-chip">ë¶ˆí•©ê²©</span>
            {% elif o.insp_status_display == "ë³´ë¥˜" %}
              <span class="btn btn-sm btn-warning text-dark btn-static btn-chip">ë³´ë¥˜</span>
            {% elif o.insp_status_display == "ëŒ€ê¸°" %}
              <span class="btn btn-sm btn-secondary btn-static btn-chip">ëŒ€ê¸°</span>
            {% else %}
              <span class="btn btn-sm btn-light text-dark btn-static btn-chip">-</span>
            {% endif %}
          </td>
          <td>
            {% if o.status_display == "ì…ê³ ì™„ë£Œ" %}
              <span class="btn btn-sm btn-primary btn-static">ì…ê³ í™•ì •ì™„ë£Œ</span>
            {% else %}
              <span class="btn btn-sm btn-outline-secondary btn-static">ì…ê³ í™•ì •ëŒ€ê¸°</span>
            {% endif %}
          </td>
          <td>{% if o.latest_receipt_lot %}{{ o.latest_receipt_lot }}{% endif %}</td>
          <td><input type="text" class="form-control form-control-sm" name="remark_{{ o.id }}" placeholder="ë¹„ê³ "></td>
          <td class="d-flex gap-1 justify-content-center">
            <a class="btn btn-sm btn-outline-success" href="{% url 'purchase:inj_receipt_candidates' o.id %}">ì„ íƒì…ê³ </a>
            <form method="post" action="{% url 'purchase:inj_receipt_add' o.id %}">
              {% csrf_token %}
              <input type="hidden" name="receipt_date" value="{{ today|date:'Y-m-d' }}">
              <input type="hidden" name="selected_ids" value="{{ o.id }}">
              <input type="hidden" name="remark_{{ o.id }}" value="" class="remark-shadow">
              <!-- button class="btn btn-sm btn-outline-primary"
                      {% if o.insp_status_display != "í•©ê²©" %}disabled title="ìµœì‹  â€˜í•©ê²©â€™ì´ ì•„ë‹™ë‹ˆë‹¤"{% endif %}>
                ì…ê³ 
              </button-->
            </form>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</form>

{# ğŸ“„ í˜ì´ì§• #}
{# ğŸ“„ í˜ì´ì§•: ë””ìì¸ í†µì¼(í•­ìƒ í‘œì‹œ) #}
<nav aria-label="í˜ì´ì§€ë„¤ì´ì…˜">
  <ul class="pagination pagination-sm justify-content-center">

    {# ì²˜ìŒ #}
    <li class="page-item {% if page_obj.number == 1 %}disabled{% endif %}">
      {% if page_obj.number == 1 %}
        <span class="page-link">Â« ì²˜ìŒ</span>
      {% else %}
        <a class="page-link" href="?page=1{% if querystring_wo_page %}&{{ querystring_wo_page }}{% endif %}">Â« ì²˜ìŒ</a>
      {% endif %}
    </li>

    {# ì´ì „ #}
    <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
      {% if page_obj.has_previous %}
        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if querystring_wo_page %}&{{ querystring_wo_page }}{% endif %}">â€¹ ì´ì „</a>
      {% else %}
        <span class="page-link">â€¹ ì´ì „</span>
      {% endif %}
    </li>

    {# í˜„ì¬/ì „ì²´ #}
    <li class="page-item active">
      <span class="page-link">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
    </li>

    {# ë‹¤ìŒ #}
    <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
      {% if page_obj.has_next %}
        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if querystring_wo_page %}&{{ querystring_wo_page }}{% endif %}">ë‹¤ìŒ â€º</a>
      {% else %}
        <span class="page-link">ë‹¤ìŒ â€º</span>
      {% endif %}
    </li>

    {# ë #}
    <li class="page-item {% if page_obj.number == page_obj.paginator.num_pages %}disabled{% endif %}">
      {% if page_obj.number == page_obj.paginator.num_pages %}
        <span class="page-link">ë Â»</span>
      {% else %}
        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if querystring_wo_page %}&{{ querystring_wo_page }}{% endif %}">ë Â»</a>
      {% endif %}
    </li>

  </ul>
</nav>


<script>
(function(){
  // ì „ì²´ ì„ íƒ(ë¹„í™œì„± ì œì™¸)
  const all = document.getElementById('chk-all');
  const rows = document.querySelectorAll('.row-check');
  all && all.addEventListener('change', e => rows.forEach(c => c.checked = !c.disabled && e.target.checked));

  // ë‹¨ê±´ ì…ê³  ì‹œ ê°™ì€ í–‰ì˜ ë¹„ê³ ë¥¼ hiddenìœ¼ë¡œ ë³µì‚¬
  document.querySelectorAll('tr').forEach(tr => {
    const remark = tr.querySelector('input[name^="remark_"]');
    const form = tr.querySelector('form[action*="/receipts/"][method="post"]');
    if (remark && form) form.addEventListener('submit', () => {
      const shadow = form.querySelector('.remark-shadow'); if (shadow) shadow.value = remark.value;
    });
  });
})();
</script>
{% endblock %}
