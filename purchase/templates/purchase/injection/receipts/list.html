{# templates/purchase/injection/receipts/list.html #}
{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% block content %}

{# 🔔 Django messages #}
{% if messages %}
  <div class="mb-2">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  </div>
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-3" style="font-size: 0.9rem;">
  <h4 class="mb-0">사출 입고 목록</h4>
</div>

{# 🔎 검색 영역 (GET) — 샘플 스타일 준수 #}
<form method="get" class="row g-2 mb-3 align-items-end border border-dark rounded p-3" style="background-color:#f8f9fa;">
  <div class="col-md-2">
    <label class="form-label mb-0 small">발주처</label>
    <input type="text" name="vendor" class="form-control form-control-sm" value="{{ filter.vendor }}">
  </div>
  <div class="col-md-2">
    <label class="form-label mb-0 small">품명</label>
    <input type="text" name="product" class="form-control form-control-sm" value="{{ filter.product }}">
  </div>
  <div class="col-md-2">
    <label class="form-label mb-0 small">발주일 from</label>
    <input type="date" name="order_date_from" class="form-control form-control-sm" value="{{ filter.order_date_from }}">
  </div>
  <div class="col-md-2">
    <label class="form-label mb-0 small">발주일 to</label>
    <input type="date" name="order_date_to" class="form-control form-control-sm" value="{{ filter.order_date_to }}">
  </div>
  <div class="col-md-2">
    <label class="form-label mb-0 small">검사일 from</label>
    <input type="date" name="insp_date_from" class="form-control form-control-sm" value="{{ filter.insp_date_from }}">
  </div>
  <div class="col-md-2">
    <label class="form-label mb-0 small">검사일 to</label>
    <input type="date" name="insp_date_to" class="form-control form-control-sm" value="{{ filter.insp_date_to }}">
  </div>
  <div class="col-md-2">
    <label class="form-label mb-0 small">상태</label>
    <select name="status" class="form-select form-select-sm">
      <option value="">-- 전체 --</option>
      <option value="입고대기" {% if filter.status == '입고대기' %}selected{% endif %}>입고대기</option>
      <option value="입고완료" {% if filter.status == '입고완료' %}selected{% endif %}>입고완료</option>
    </select>
  </div>
  <div class="col-md-10 text-end">
    <button type="submit" class="btn btn-sm btn-primary">검색</button>
    <a href="{% url 'purchase:inj_receipt_list' %}" class="btn btn-sm btn-outline-secondary">초기화</a>
  </div>
</form>

{# ✅ 일괄 입고 폼(체크박스와 비고 입력 포함) #}
<form method="post" action="{% url 'purchase:inj_receipt_add_bulk' %}" id="bulk-form" class="mb-2">
  {% csrf_token %}
  <div class="d-flex gap-2 align-items-center">
    <label class="me-1 small mb-0">입고일</label>
    <input type="date" class="form-control form-control-sm" style="max-width:180px"
           name="receipt_date" value="{{ today|date:'Y-m-d' }}">
    <button class="btn btn-primary btn-sm">선택 행 일괄 입고</button>
  </div>

  <div class="table-responsive mt-2">
    <table class="table table-striped table-bordered table-sm text-center align-middle" style="font-size:12px; border:1px solid #000;">
      <thead class="table-light">
        <tr>
          <th style="width:28px;"><input type="checkbox" id="chk-all"></th>
          <th class="fw-bold">발주LOT</th>
          <th class="fw-bold">발주처</th>
          <th class="fw-bold">품명</th>
          <th class="fw-bold">수량</th>
          <th class="fw-bold">발주일</th>
          <th class="fw-bold">배송일</th>
          <th class="fw-bold">검사일</th>
          <th class="fw-bold">검사결과</th>
          <th class="fw-bold">상태</th>
          <th class="fw-bold">입고LOT</th>
          <th class="fw-bold" style="width:180px;">비고</th>
          <th class="fw-bold" style="width:110px;">관리</th>
        </tr>
      </thead>
<tbody>
{% for o in page_obj.object_list %}
  <tr>
    <td><input type="checkbox" class="row-check" name="selected_ids" value="{{ o.id }}"></td>
    <td>{{ o.order_lot }}</td>
    <td>{{ o.vendor.name }}</td>
    <td>
      {% with first=o.items.first %}
        {% if first and first.injection %}{{ first.injection.name }}{% else %}-{% endif %}
      {% endwith %}
    </td>
    <td>{{ o.qty_sum|default:0|intcomma }}</td>
    <td>{% if o.order_date %}{{ o.order_date|date:"Y-m-d" }}{% else %}-{% endif %}</td>
    {# ✅ 배송일: 협력사 배송등록 시각(날짜화) #}
    <td>{% if o.shipping_date %}{{ o.shipping_date|date:"Y-m-d" }}{% else %}-{% endif %}</td>
    <td>{% if o.latest_insp_date %}{{ o.latest_insp_date|date:"Y-m-d" }}{% else %}-{% endif %}</td>
    <td>
      {% if o.insp_status_display == "합격" %}
        <span class="badge text-bg-success">합격</span>
      {% elif o.insp_status_display == "불합격" %}
        <span class="badge text-bg-danger">불합격</span>
      {% elif o.insp_status_display == "보류" %}
        <span class="badge text-bg-warning text-dark">보류</span>
      {% elif o.insp_status_display == "대기" %}
        <span class="badge text-bg-secondary">대기</span>
      {% else %}
        <span class="badge text-bg-light text-dark">-</span>
      {% endif %}
    </td>
    <td>{% if o.status == "입고완료" %}<span class="badge text-bg-primary">입고완료</span>
        {% elif o.status == "입고대기" %}<span class="badge text-bg-secondary">입고대기</span>
        {% else %}<span class="badge text-bg-light text-dark">{{ o.status }}</span>
        {% endif %}
    </td>
    <td>{% if o.latest_receipt_lot %}{{ o.latest_receipt_lot }}{% else %}{% endif %}</td>
    <td><input type="text" class="form-control form-control-sm" name="remark_{{ o.id }}" placeholder="비고"></td>
    <td>
      <form method="post" action="{% url 'purchase:inj_receipt_add' o.id %}">
        {% csrf_token %}
        <input type="hidden" name="receipt_date" value="{{ today|date:'Y-m-d' }}">
        <input type="hidden" name="selected_ids" value="{{ o.id }}">
        <input type="hidden" name="remark_{{ o.id }}" value="" class="remark-shadow">
        <button class="btn btn-sm btn-outline-primary">입고</button>
      </form>
    </td>
  </tr>
{% endfor %}
</tbody>
    </table>
  </div>
</form>

{# 📄 페이징: 20개/페이지 가정(뷰에서 Paginator(per_page=20)) #}
{% if page_obj.paginator.num_pages > 1 %}
<nav aria-label="페이지">
  <ul class="pagination pagination-sm justify-content-center">
    {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}&{% endif %}page={{ page_obj.previous_page_number }}">‹</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">‹</span></li>
    {% endif %}
    {% for i in page_range %}
      {% if i == page_obj.number %}
        <li class="page-item active"><span class="page-link">{{ i }}</span></li>
      {% else %}
        <li class="page-item"><a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}&{% endif %}page={{ i }}">{{ i }}</a></li>
      {% endif %}
    {% endfor %}
    {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}&{% endif %}page={{ page_obj.next_page_number }}">›</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">›</span></li>
    {% endif %}
  </ul>
</nav>
{% endif %}

<script>
(function(){
  // 전체선택
  const chkAll = document.getElementById('chk-all');
  const rowChecks = document.querySelectorAll('.row-check');
  chkAll && chkAll.addEventListener('change', e=>{
    rowChecks.forEach(chk => { chk.checked = !chk.disabled && e.target.checked; });
  });

  // 단건 입고 시 같은 행의 비고값을 hidden에 복사해서 POST
  document.querySelectorAll('tr').forEach(row => {
    const remarkInput = row.querySelector('input[name^="remark_"]');
    const oneForm = row.querySelector('form[action*="/receipts/"][method="post"]');
    if (remarkInput && oneForm) {
      oneForm.addEventListener('submit', () => {
        const shadow = oneForm.querySelector('.remark-shadow');
        if (shadow) shadow.value = remarkInput.value;
      });
    }
  });
})();
</script>
{% endblock %}