{# templates/purchase/injection/receipts/list.html #}
{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% block content %}

{# ğŸ”” Django messages #}
{% if messages %}
  <div class="mb-2">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  </div>
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-3" style="font-size: 0.9rem;">
  <h4 class="mb-0">ì‚¬ì¶œ ì…ê³  ëª©ë¡</h4>
</div>

{# ğŸ” ê²€ìƒ‰ ì˜ì—­ (GET) â€” ìƒ˜í”Œ ìŠ¤íƒ€ì¼ ì¤€ìˆ˜ #}
<form method="get" class="row g-2 mb-3 align-items-end border border-dark rounded p-3" style="background-color:#f8f9fa;">
  <div class="col-md-2">
    <label class="form-label mb-0 small">ë°œì£¼ì²˜</label>
    <input type="text" name="vendor" class="form-control form-control-sm" value="{{ filter.vendor }}">
  </div>
  <div class="col-md-2">
    <label class="form-label mb-0 small">í’ˆëª…</label>
    <input type="text" name="product" class="form-control form-control-sm" value="{{ filter.product }}">
  </div>
  <div class="col-md-2">
    <label class="form-label mb-0 small">ë°œì£¼ì¼ from</label>
    <input type="date" name="order_date_from" class="form-control form-control-sm" value="{{ filter.order_date_from }}">
  </div>
  <div class="col-md-2">
    <label class="form-label mb-0 small">ë°œì£¼ì¼ to</label>
    <input type="date" name="order_date_to" class="form-control form-control-sm" value="{{ filter.order_date_to }}">
  </div>
  <div class="col-md-2">
    <label class="form-label mb-0 small">ê²€ì‚¬ì¼ from</label>
    <input type="date" name="insp_date_from" class="form-control form-control-sm" value="{{ filter.insp_date_from }}">
  </div>
  <div class="col-md-2">
    <label class="form-label mb-0 small">ê²€ì‚¬ì¼ to</label>
    <input type="date" name="insp_date_to" class="form-control form-control-sm" value="{{ filter.insp_date_to }}">
  </div>
  <div class="col-md-2">
    <label class="form-label mb-0 small">ìƒíƒœ</label>
    <select name="status" class="form-select form-select-sm">
      <option value="">-- ì „ì²´ --</option>
      <option value="ì…ê³ ëŒ€ê¸°" {% if filter.status == 'ì…ê³ ëŒ€ê¸°' %}selected{% endif %}>ì…ê³ ëŒ€ê¸°</option>
      <option value="ì…ê³ ì™„ë£Œ" {% if filter.status == 'ì…ê³ ì™„ë£Œ' %}selected{% endif %}>ì…ê³ ì™„ë£Œ</option>
    </select>
  </div>
  <div class="col-md-10 text-end">
    <button type="submit" class="btn btn-sm btn-primary">ê²€ìƒ‰</button>
    <a href="{% url 'purchase:inj_receipt_list' %}" class="btn btn-sm btn-outline-secondary">ì´ˆê¸°í™”</a>
  </div>
</form>

{# âœ… ì¼ê´„ ì…ê³  í¼(ì²´í¬ë°•ìŠ¤ì™€ ë¹„ê³  ì…ë ¥ í¬í•¨) #}
<form method="post" action="{% url 'purchase:inj_receipt_add_bulk' %}" id="bulk-form" class="mb-2">
  {% csrf_token %}
  <div class="d-flex gap-2 align-items-center">
    <label class="me-1 small mb-0">ì…ê³ ì¼</label>
    <input type="date" class="form-control form-control-sm" style="max-width:180px"
           name="receipt_date" value="{{ today|date:'Y-m-d' }}">
    <button class="btn btn-primary btn-sm">ì„ íƒ í–‰ ì¼ê´„ ì…ê³ </button>
  </div>

  <div class="table-responsive mt-2">
    <table class="table table-striped table-bordered table-sm text-center align-middle" style="font-size:12px; border:1px solid #000;">
      <thead class="table-light">
        <tr>
          <th style="width:28px;"><input type="checkbox" id="chk-all"></th>
          <th class="fw-bold">ë°œì£¼LOT</th>
          <th class="fw-bold">ë°œì£¼ì²˜</th>
          <th class="fw-bold">í’ˆëª…</th>
          <th class="fw-bold">ìˆ˜ëŸ‰</th>
          <th class="fw-bold">ë°œì£¼ì¼</th>
          <th class="fw-bold">ë°°ì†¡ì¼</th>
          <th class="fw-bold">ê²€ì‚¬ì¼</th>
          <th class="fw-bold">ê²€ì‚¬ê²°ê³¼</th>
          <th class="fw-bold">ìƒíƒœ</th>
          <th class="fw-bold">ì…ê³ LOT</th>
          <th class="fw-bold" style="width:180px;">ë¹„ê³ </th>
          <th class="fw-bold" style="width:110px;">ê´€ë¦¬</th>
        </tr>
      </thead>
<tbody>
{% for o in page_obj.object_list %}
  <tr>
    <td><input type="checkbox" class="row-check" name="selected_ids" value="{{ o.id }}"></td>
    <td>{{ o.order_lot }}</td>
    <td>{{ o.vendor.name }}</td>
    <td>
      {% with first=o.items.first %}
        {% if first and first.injection %}{{ first.injection.name }}{% else %}-{% endif %}
      {% endwith %}
    </td>
    <td>{{ o.qty_sum|default:0|intcomma }}</td>
    <td>{% if o.order_date %}{{ o.order_date|date:"Y-m-d" }}{% else %}-{% endif %}</td>
    {# âœ… ë°°ì†¡ì¼: í˜‘ë ¥ì‚¬ ë°°ì†¡ë“±ë¡ ì‹œê°(ë‚ ì§œí™”) #}
    <td>{% if o.shipping_date %}{{ o.shipping_date|date:"Y-m-d" }}{% else %}-{% endif %}</td>
    <td>{% if o.latest_insp_date %}{{ o.latest_insp_date|date:"Y-m-d" }}{% else %}-{% endif %}</td>
    <td>
      {% if o.insp_status_display == "í•©ê²©" %}
        <span class="badge text-bg-success">í•©ê²©</span>
      {% elif o.insp_status_display == "ë¶ˆí•©ê²©" %}
        <span class="badge text-bg-danger">ë¶ˆí•©ê²©</span>
      {% elif o.insp_status_display == "ë³´ë¥˜" %}
        <span class="badge text-bg-warning text-dark">ë³´ë¥˜</span>
      {% elif o.insp_status_display == "ëŒ€ê¸°" %}
        <span class="badge text-bg-secondary">ëŒ€ê¸°</span>
      {% else %}
        <span class="badge text-bg-light text-dark">-</span>
      {% endif %}
    </td>
    <td>{% if o.status == "ì…ê³ ì™„ë£Œ" %}<span class="badge text-bg-primary">ì…ê³ ì™„ë£Œ</span>
        {% elif o.status == "ì…ê³ ëŒ€ê¸°" %}<span class="badge text-bg-secondary">ì…ê³ ëŒ€ê¸°</span>
        {% else %}<span class="badge text-bg-light text-dark">{{ o.status }}</span>
        {% endif %}
    </td>
    <td>{% if o.latest_receipt_lot %}{{ o.latest_receipt_lot }}{% else %}{% endif %}</td>
    <td><input type="text" class="form-control form-control-sm" name="remark_{{ o.id }}" placeholder="ë¹„ê³ "></td>
    <td>
      <form method="post" action="{% url 'purchase:inj_receipt_add' o.id %}">
        {% csrf_token %}
        <input type="hidden" name="receipt_date" value="{{ today|date:'Y-m-d' }}">
        <input type="hidden" name="selected_ids" value="{{ o.id }}">
        <input type="hidden" name="remark_{{ o.id }}" value="" class="remark-shadow">
        <button class="btn btn-sm btn-outline-primary">ì…ê³ </button>
      </form>
    </td>
  </tr>
{% endfor %}
</tbody>
    </table>
  </div>
</form>

{# ğŸ“„ í˜ì´ì§•: 20ê°œ/í˜ì´ì§€ ê°€ì •(ë·°ì—ì„œ Paginator(per_page=20)) #}
{% if page_obj.paginator.num_pages > 1 %}
<nav aria-label="í˜ì´ì§€">
  <ul class="pagination pagination-sm justify-content-center">
    {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}&{% endif %}page={{ page_obj.previous_page_number }}">â€¹</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">â€¹</span></li>
    {% endif %}
    {% for i in page_range %}
      {% if i == page_obj.number %}
        <li class="page-item active"><span class="page-link">{{ i }}</span></li>
      {% else %}
        <li class="page-item"><a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}&{% endif %}page={{ i }}">{{ i }}</a></li>
      {% endif %}
    {% endfor %}
    {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}&{% endif %}page={{ page_obj.next_page_number }}">â€º</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">â€º</span></li>
    {% endif %}
  </ul>
</nav>
{% endif %}

<script>
(function(){
  // ì „ì²´ì„ íƒ
  const chkAll = document.getElementById('chk-all');
  const rowChecks = document.querySelectorAll('.row-check');
  chkAll && chkAll.addEventListener('change', e=>{
    rowChecks.forEach(chk => { chk.checked = !chk.disabled && e.target.checked; });
  });

  // ë‹¨ê±´ ì…ê³  ì‹œ ê°™ì€ í–‰ì˜ ë¹„ê³ ê°’ì„ hiddenì— ë³µì‚¬í•´ì„œ POST
  document.querySelectorAll('tr').forEach(row => {
    const remarkInput = row.querySelector('input[name^="remark_"]');
    const oneForm = row.querySelector('form[action*="/receipts/"][method="post"]');
    if (remarkInput && oneForm) {
      oneForm.addEventListener('submit', () => {
        const shadow = oneForm.querySelector('.remark-shadow');
        if (shadow) shadow.value = remarkInput.value;
      });
    }
  });
})();
</script>
{% endblock %}