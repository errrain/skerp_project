{# templates/purchase/unified/issues/list.html #}
{% extends 'base.html' %}
{% load humanize %}

{% block content %}

<style>
  .issue-toolbar{display:flex;align-items:center;gap:12px;flex-wrap:wrap;font-size:.9rem}
  .issue-toolbar .grp{display:flex;align-items:center;gap:8px;white-space:nowrap}
  .issue-toolbar label{margin-bottom:0;font-weight:700}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
  .ta-center{text-align:center}
  .ta-right{text-align:right}

  /* ---------- 필터 바(한 줄) ---------- */
  .filterbar{
    display:flex; align-items:center; flex-wrap:wrap; gap:8px;
    padding:8px; background:#f8f9fa; border:1px solid #212529; border-radius:.25rem;
  }
  .filterbar .fb-item{ display:flex; align-items:center; gap:6px; }
  .filterbar .fb-input{ min-width:180px; }
  .filterbar .fb-date{ width:140px; }
  .filterbar .fb-select{ min-width:220px; }
  .filterbar .fb-sep{ color:#6c757d; }
  .filterbar .fb-actions{ margin-left:auto; display:flex; gap:6px; }

  /* ---------- 테이블 ---------- */
  table.issue-table{font-size:12px;border:1px solid #000}
  .issue-table th,.issue-table td{vertical-align:middle}
  .issue-table thead th{background:#f1f1f1}

  /* Bootstrap .table-striped가 우리 교차색을 덮지 않도록 무효화 */
  .table.table-striped tbody tr:nth-of-type(odd){ background:inherit !important; }
  .table.table-striped tbody tr:hover{ background:inherit; }

  /* 헤더 LOT 교차 배경 (짝수 그룹만 색, 홀수 그룹은 흰색) */
  .issue-table tbody tr.lot-even{ background:#f7f9fc; }
  .issue-table tbody tr.lot-odd { background:transparent; }

  /* hover 시에도 패턴 유지 */
  .issue-table.table-hover tbody tr.lot-even:hover{ background:#edf3ff; }
  .issue-table.table-hover tbody tr.lot-odd:hover { background:transparent; }

  /* (요청) 체크 강조 비활성화 */
  .issue-table tbody tr.row-selected{ outline:none; background:inherit !important; }
  .issue-table.table-hover tbody tr.row-selected:hover{ background:inherit !important; }
  .issue-table tbody tr.row-selected td:first-child{ background:inherit; }
</style>

<div class="container-fluid py-2">
  <h5 class="mb-2">출고(이동) - 통합</h5>

  {# 검색/필터 영역 #}
  <form method="get" class="filterbar mb-3">
      {# 통합 카테고리 유지용 #}
      <input type="hidden" name="cat" value="{{ cat }}">

      <!-- 품명 -->
      <div class="fb-item">
        <label class="visually-hidden" for="f_q">품명</label>
        <input id="f_q" type="text" name="q"
               class="form-control form-control-sm fb-input"
               value="{{ filter.q }}" placeholder="품명 일부">
      </div>

      <!-- 입고일 범위 -->
      <div class="fb-item">
        <span class="small text-muted">입고일</span>
        <label class="visually-hidden" for="f_from">입고일 from</label>
        <input id="f_from" type="date" name="date_from"
               class="form-control form-control-sm fb-date"
               value="{{ filter.date_from }}">
        <span class="fb-sep">~</span>
        <label class="visually-hidden" for="f_to">입고일 to</label>
        <input id="f_to" type="date" name="date_to"
               class="form-control form-control-sm fb-date"
               value="{{ filter.date_to }}">
      </div>

      <!-- 현재 위치 -->
      <div class="fb-item">
        <label class="visually-hidden" for="f_wh">현재 위치</label>
        <select id="f_wh" name="wh" class="form-select form-select-sm fb-select">
          {% for w in warehouses %}
            <option value="{{ w.warehouse_id }}" {% if filter.wh == w.warehouse_id %}selected{% endif %}>
              {{ w.name }} ({{ w.warehouse_id }})
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="fb-item">
        <label class="visually-hidden" for="f_status">사용상태</label>
        <select id="f_status" name="use_status" class="form-select form-select-sm">
          <option value="">-- 상태 전체 --</option>
          <option value="미사용"   {% if filter.use_status == "미사용" %}selected{% endif %}>미사용</option>
          <option value="부분사용" {% if filter.use_status == "부분사용" %}selected{% endif %}>부분사용</option>
          <option value="사용완료" {% if filter.use_status == "사용완료" %}selected{% endif %}>사용완료</option>
        </select>
      </div>
      <!-- 버튼 -->
      <div class="fb-actions">
        <button type="submit" class="btn btn-sm btn-primary">검색</button>
        <a href="{% url 'purchase:uni_issue_list' %}?cat={{ cat }}" class="btn btn-sm btn-secondary">초기화</a>
      </div>
  </form>

  {# 상단 툴바(이동일시/이동위치/일괄이동) #}
  <div class="issue-toolbar mb-2">
    <div class="grp">
      <label>이동 일시</label>
      <input type="date" id="move_date" class="form-control form-control-sm"
             value="{{ today|date:'Y-m-d' }}" style="min-width:140px">
    </div>
    <div class="grp">
      <label>이동 위치</label>
      <select id="list-dest" class="form-select form-select-sm" style="min-width:220px">
        {% for w in warehouses %}
          <option value="{{ w.id }}" {% if w.id == default_dest_id %}selected{% endif %}>
            {{ w.name }} ({{ w.warehouse_id }})
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="grp">
      <button type="button" id="btn-bulk-move" class="btn btn-sm btn-success">선택항목 모두이동</button>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-bordered table-sm text-center align-middle issue-table" style="font-size:12px; border:1px solid #000;">
      <thead>
        <tr>
          <th style="width:32px" class="fw-bold table-header">
            <input type="checkbox" id="chk-all">
          </th>
          <th class="fw-bold table-header">입고 헤더LOT</th>
          <th class="fw-bold table-header">입고 서브LOT</th>
          <th class="fw-bold table-header">품명</th>
          <th class="fw-bold table-header ta-right">수량</th>
          <th class="fw-bold table-header">사용상태</th>
          <th class="fw-bold table-header">입고일</th>
          <th class="fw-bold table-header">현재위치</th>
          <th class="fw-bold table-header">이동위치</th>
          <th class="fw-bold table-header">비고</th>
          <th class="fw-bold table-header">관리</th>
        </tr>
      </thead>
      <tbody id="issue-list-body">
      {% for r in items %}
        {% with sl=r.sub_lines %}
          {% for ln in sl %}
          <tr data-receipt-id="{{ r.id }}"
              data-line-id="{{ ln.id }}"
              data-receipt-lot="{{ r.receipt_lot }}">
            <td class="ta-center">
              <input type="checkbox"
                     class="row-check"
                     data-receipt="{{ r.id }}"
                     data-line-id="{{ ln.id }}">
            </td>
            <td class="mono">{{ r.receipt_lot }}</td>
            <td class="mono">{{ ln.sub_lot }}</td>
            <td>{{ r.product_display|default:"-" }}</td>
            <td class="ta-right">{{ ln.qty|intcomma }}</td>
            <td>{{ ln.use_status|default:"미사용" }}</td>
            <td>{{ r.date|date:"Y-m-d" }}</td>
            <td>
              {% if ln.warehouse %}
                {{ ln.warehouse.name }} ({{ ln.warehouse.warehouse_id }})
              {% else %}
                {{ r.warehouse.name }} ({{ r.warehouse.warehouse_id }})
              {% endif %}
            </td>
            <td>
              <select class="form-select form-select-sm dest-select-row">
                {% for w in warehouses %}
                  <option value="{{ w.id }}" {% if w.id == default_dest_id %}selected{% endif %}>
                    {{ w.name }} ({{ w.warehouse_id }})
                  </option>
                {% endfor %}
              </select>
            </td>
            <td>
              <input type="text" class="form-control form-control-sm remark-input" placeholder="비고">
            </td>
            <td class="ta-center">
              <button type="button" class="btn btn-sm btn-outline-primary btn-move-one">이동</button>
            </td>
          </tr>
          {% endfor %}
        {% endwith %}
      {% empty %}
        <tr><td colspan="10" class="ta-center py-4 text-muted">데이터가 없습니다.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  {# 페이징 #}
  <nav aria-label="pagination">
    <ul class="pagination pagination-sm justify-content-center">
      <li class="page-item {% if page_obj.number == 1 %}disabled{% endif %}">
        {% if page_obj.number == 1 %}
          <span class="page-link">« 처음</span>
        {% else %}
          <a class="page-link" href="?page=1{% if querystring %}&{{ querystring }}{% endif %}">« 처음</a>
        {% endif %}
      </li>
      <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
        {% if page_obj.has_previous %}
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if querystring %}&{{ querystring }}{% endif %}">‹ 이전</a>
        {% else %}
          <span class="page-link">‹ 이전</span>
        {% endif %}
      </li>
      <li class="page-item active"><span class="page-link">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span></li>
      <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
        {% if page_obj.has_next %}
          <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if querystring %}&{{ querystring }}{% endif %}">다음 ›</a>
        {% else %}
          <span class="page-link">다음 ›</span>
        {% endif %}
      </li>
      <li class="page-item {% if page_obj.number == page_obj.paginator.num_pages %}disabled{% endif %}">
        {% if page_obj.number == page_obj.paginator.num_pages %}
          <span class="page-link">끝 »</span>
        {% else %}
          <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if querystring %}&{{ querystring }}{% endif %}">끝 »</a>
        {% endif %}
      </li>
    </ul>
  </nav>
</div>

<script>
  /* ========== 공통 유틸 ========== */
  function getCsrfToken(){
    const m = document.cookie.match(/csrftoken=([^;]+)/);
    return m ? m[1] : "";
  }
  function getMoveDate(){
    const el = document.getElementById('move_date');
    return (el && el.value) ? el.value : "{{ today|date:'Y-m-d' }}";
  }
  function getListDest(){
    const el = document.getElementById('list-dest');
    return el ? el.value : "";
  }
  async function postJSON(url, payload){
    const resp = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type':'application/json',
        'X-CSRFToken': getCsrfToken()
      },
      body: JSON.stringify(payload || {}),
    });
    let data = {};
    try { data = await resp.json(); } catch(e) {}
    if (!resp.ok || data.ok === false){
      throw new Error(data.msg || data.detail || '처리 중 오류가 발생했습니다.');
    }
    return data;
  }

  /* ========== 화면 갱신 유틸 ========== */

  // 헤더 LOT 교차색(첫 그룹=짝수=색)
  function applyGroupStripes(){
    const rows = [...document.querySelectorAll('#issue-list-body tr[data-receipt-lot]')];
    let prevLot = null, groupIdx = -1;
    rows.forEach(tr => {
      const lot = tr.dataset.receiptLot || '';
      if (lot !== prevLot){
        groupIdx += 1;
        prevLot = lot;
      }
      tr.classList.remove('lot-even','lot-odd');
      tr.classList.add((groupIdx % 2 === 0) ? 'lot-even' : 'lot-odd');
    });
  }

  // 헤더 LOT(2번째 칸) 화면용 rowspan
  function applyRowspanByHeaderLot(){
    const tbody = document.getElementById('issue-list-body');
    if (!tbody) return;

    // 초기화
    tbody.querySelectorAll('tr td:nth-child(2)').forEach(td => {
      td.style.display = '';
      td.removeAttribute('rowspan');
    });

    const rows = [...tbody.querySelectorAll('tr[data-receipt-lot]')];
    let prevLot = null, headTd = null, span = 0;

    rows.forEach((tr, i) => {
      const lot = tr.dataset.receiptLot || '';
      const td  = tr.querySelector('td:nth-child(2)');
      if (!td) return;

      if (lot !== prevLot){
        if (headTd && span > 1) headTd.rowSpan = span;
        prevLot = lot;
        headTd  = td;
        span    = 1;
      } else {
        span += 1;
        td.style.display = 'none';
      }
      if (i === rows.length - 1 && headTd && span > 1){
        headTd.rowSpan = span;
      }
    });
  }

  // 강조(행 하이라이트) 무효화 – 호출해도 스타일 변화 없음
  function _toggleRowClassByCheckbox(cb){ /* no-op */ }

  // 같은 헤더 LOT 그룹의 체크박스 일괄 동기화
  function setLotGroupCheckedByRow(tr, checked){
    if (!tr) return;
    const lot = tr.dataset.receiptLot;
    if (!lot) return;
    document
      .querySelectorAll(`#issue-list-body tr[data-receipt-lot="${lot}"] .row-check`)
      .forEach(cb => {
        cb.checked = checked;
        _toggleRowClassByCheckbox(cb);
      });
  }

  // 행 제거 후 재적용(교차색 + rowspan)
  function removeRowsByLineIds(ids){
    (ids || []).forEach(id => {
      const row = document.querySelector(`tr[data-line-id="${id}"]`);
      if (row) row.remove();
    });
    applyGroupStripes();
    applyRowspanByHeaderLot();
  }

  /* ========== 메인 바인딩 ========== */
  document.addEventListener('DOMContentLoaded', () => {
    applyGroupStripes();
    applyRowspanByHeaderLot();

    const body = document.getElementById('issue-list-body');

    // 행 클릭 → 그 LOT 전체 체크/해제
    body.addEventListener('click', (e) => {
      if (e.target.closest('input,select,button,textarea,a')) return;
      const tr = e.target.closest('tr[data-line-id]');
      if (!tr) return;
      const cb = tr.querySelector('.row-check');
      if (!cb) return;
      cb.checked = !cb.checked;
      setLotGroupCheckedByRow(tr, cb.checked);
    });

    // 개별 체크박스 직접 조작 → 그 LOT 전체 동기화
    body.addEventListener('change', (e) => {
      const cb = e.target.closest('.row-check');
      if (!cb) return;
      const tr = cb.closest('tr[data-line-id]');
      setLotGroupCheckedByRow(tr, cb.checked);
    });

    // 전체 선택 토글
    document.getElementById('chk-all')?.addEventListener('change', (e) => {
      document.querySelectorAll('.row-check').forEach(cb => {
        cb.checked = e.target.checked;
        _toggleRowClassByCheckbox(cb);
      });
    });

    /* ── 단건 이동 ── */
    document.body.addEventListener('click', async (e) => {
      const btn = e.target.closest('.btn-move-one');
      if (!btn) return;

      const tr = btn.closest('tr[data-line-id]');
      const receiptId = tr?.dataset.receiptId;
      const lineId    = Number(tr?.dataset.lineId || '0');
      if (!receiptId || !lineId){
        alert('행 식별자가 없습니다.');
        return;
      }

      const destSel = tr.querySelector('.dest-select-row');
      const destId  = Number(destSel?.value || (getListDest() || '0'));
      if (!Number.isInteger(destId) || destId <= 0){
        alert('이동할 창고를 선택하세요.');
        return;
      }

      const remark = tr.querySelector('.remark-input')?.value || '';
      btn.disabled = true;
      try{
        const data = await postJSON("{% url 'purchase:uni_issue_add' %}", {
          cat        : "{{ cat }}",
          receipt_id : receiptId,
          dest_wh_id : destId,
          move_date  : getMoveDate(),
          remark     : remark,
          sub_line_ids: [lineId],
        });
        const mids = data.moved_ids || [];
        const sids = data.skipped_ids || [];
        if (mids.includes(lineId) || (data.moved || 0) > 0){
          removeRowsByLineIds([lineId]);
        } else if (sids.includes(lineId)){
          alert('이미 목적지에 있습니다.');
        } else {
          alert('이동 항목이 없습니다.');
        }
      }catch(err){
        alert(err.message);
      }finally{
        btn.disabled = false;
      }
    });

    /* ── 선택항목 모두이동 ── */
    document.getElementById('btn-bulk-move')?.addEventListener('click', async () => {
      const destId = Number(getListDest() || '0');
      if (!Number.isInteger(destId) || destId <= 0){
        alert('이동할 창고를 선택하세요.');
        return;
      }
      const moveDate = getMoveDate();

      const checked = [...document.querySelectorAll('.row-check:checked')];
      if (checked.length === 0){
        alert('이동할 항목을 체크하세요.');
        return;
      }

      // receipt별 묶기
      const groups = {};
      checked.forEach(cb => {
        const rid = cb.dataset.receipt;
        const lid = Number(cb.dataset.lineId || '0');
        if (!rid || !Number.isInteger(lid) || lid <= 0) return;
        (groups[rid] ||= []).push(lid);
      });

      const rids = Object.keys(groups);
      if (rids.length === 0){
        alert('유효한 항목이 없습니다.');
        return;
      }

      let movedCnt = 0, skippedCnt = 0, errorCnt = 0;
      const btn = document.getElementById('btn-bulk-move');
      btn.disabled = true;

      try{
        for (const rid of rids){
          const lineIds = groups[rid];
          const data = await postJSON("{% url 'purchase:uni_issue_add' %}", {
            cat         : "{{ cat }}",
            receipt_id  : rid,
            dest_wh_id  : destId,
            move_date   : moveDate,
            remark      : '',
            sub_line_ids: lineIds,
          });
          const mids = data.moved_ids || [];
          const sids = data.skipped_ids || [];
          removeRowsByLineIds(mids);
          movedCnt   += mids.length || (data.moved || 0);
          skippedCnt += sids.length;
          if (data.ok !== true && data.reason !== 'already_there'){
            errorCnt++;
          }
        }
        if (movedCnt || skippedCnt || errorCnt){
          console.log(`이동 ${movedCnt} / 스킵 ${skippedCnt} / 오류 ${errorCnt}`);
        }
      }catch(err){
        alert(err.message);
      }finally{
        btn.disabled = false;
      }
    });
  });
</script>


{% endblock %}
