{% extends 'base.html' %}
{% load humanize %}
{% block content %}
<style>
  .badge.status { font-size:.85rem; padding:.35rem .65rem; border-radius:9999px; font-weight:700; letter-spacing:.02em; }
  .table-header { white-space:nowrap; }
  .actions .btn { margin-right: .25rem; }
</style>

<!-- 헤더: [제목] | [신규 발주 등록] [엑셀 다운로드] -->
<div class="d-flex align-items-center justify-content-between mb-3" style="font-size:0.9rem;">
  <div class="d-flex align-items-center gap-3">
    <h4 class="mb-0">
      {% if cat == 'CHEM' %}약품{% elif cat == 'NF' %}비철{% else %}부자재{% endif %} 발주 목록
    </h4>
    {# 필요 시 카테고리 전환 버튼을 다시 켤 수 있음
    <div class="btn-group btn-group-sm" role="group" aria-label="카테고리 전환">
      <a class="btn {% if cat == 'CHEM' %}btn-dark{% else %}btn-outline-secondary{% endif %}"
         href="{% url 'purchase:uni_order_list' %}?cat=CHEM">약품</a>
      <a class="btn {% if cat == 'NF' %}btn-dark{% else %}btn-outline-secondary{% endif %}"
         href="{% url 'purchase:uni_order_list' %}?cat=NF">비철</a>
      <a class="btn {% if cat == 'SUP' %}btn-dark{% else %}btn-outline-secondary{% endif %}"
         href="{% url 'purchase:uni_order_list' %}?cat=SUP">부자재</a>
    </div>
  </div>

  <div class="d-flex gap-2">
    <a href="{% url 'purchase:uni_order_export' %}?cat={{ cat }}{% if request.GET %}&{{ request.GET.urlencode }}{% endif %}"
       class="btn btn-sm btn-outline-secondary">엑셀 다운로드</a>
    <a href="{% url 'purchase:uni_order_form' %}?cat={{ cat }}" class="btn btn-sm btn-success">
      + 신규 발주 등록
    </a>
  </div>
</div>

<form method="get" class="row g-2 mb-3 align-items-end">
  <input type="hidden" name="cat" value="{{ cat }}">
  <div class="col-auto">
    <label class="form-label mb-1 small">발주일 From</label>
    <input type="date" name="order_date_start"
           value="{{ request.GET.order_date_start|default:order_date_start_default }}"
           class="form-control form-control-sm">
  </div>
  <div class="col-auto">
    <label class="form-label mb-1 small">발주일 To</label>
    <input type="date" name="order_date_end"
           value="{{ request.GET.order_date_end|default:order_date_end_default }}"
           class="form-control form-control-sm">
  </div>
  <div class="col-auto">
    <label class="form-label mb-1 small">입고예정일 From</label>
    <input type="date" name="expected_date_start"
           value="{{ request.GET.expected_date_start|default:expected_date_start_default }}"
           class="form-control form-control-sm">
  </div>
  <div class="col-auto">
    <label class="form-label mb-1 small">입고예정일 To</label>
    <input type="date" name="expected_date_end"
           value="{{ request.GET.expected_date_end|default:expected_date_end_default }}"
           class="form-control form-control-sm">
  </div>

  <div class="col-auto">
    <label class="form-label mb-1 small">발주처</label>
    <input type="text" name="vendor"
           value="{{ request.GET.vendor|default:'' }}"
           class="form-control form-control-sm" placeholder="발주처">
  </div>
  <div class="col-auto">
    <label class="form-label mb-1 small">품명</label>
    <input type="text" name="product"
           value="{{ request.GET.product|default:'' }}"
           class="form-control form-control-sm" placeholder="품명">
  </div>

  <div class="col-auto">
    <label class="form-label mb-1 small">발주상태</label>
    <select name="order_status" class="form-select form-select-sm">
      <option value="">전체</option>
      {% for code,label in order_status_choices %}
        <option value="{{ code }}" {% if request.GET.order_status == code %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-auto">
    <label class="form-label mb-1 small">진행상태</label>
    <select name="flow_status" class="form-select form-select-sm">
      <option value="">전체</option>
      {% for code,label in flow_status_choices %}
        <option value="{{ code }}" {% if request.GET.flow_status == code %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-auto d-flex align-items-end gap-2">
    <button type="submit" class="btn btn-sm btn-primary">검색</button>
    <a href="{% url 'purchase:uni_order_export' %}?cat={{ cat }}{% if request.GET %}&{{ request.GET.urlencode }}{% endif %}"
       class="btn btn-sm btn-outline-secondary">엑셀 다운로드</a>
  </div>
</form>

<table class="table table-striped table-bordered table-sm text-center align-middle" style="font-size:12px; border:1px solid #000;">
  <thead class="table-light">
    <tr>
      <th class="fw-bold table-header">발주 LOT</th>
      <th class="fw-bold table-header">발주처</th>
      <th class="fw-bold table-header">발주일</th>
      <th class="fw-bold table-header">품명</th>
      <th class="fw-bold table-header">수량</th>
      <th class="fw-bold table-header">입고 예정일</th>
      <th class="fw-bold table-header">발주상태</th>
      <th class="fw-bold table-header">진행상태</th>
      <th class="fw-bold table-header">취소일시</th>
      <th class="fw-bold table-header">취소자</th>
      <th class="fw-bold table-header">등록일시</th>
      <th class="fw-bold table-header">등록자</th>
      <th class="fw-bold table-header">수정일시</th>
      <th class="fw-bold table-header">수정자</th>
      <th class="fw-bold table-header">단가</th>
      <th class="fw-bold table-header">합계금액</th>
      <th class="fw-bold table-header">관리</th>
    </tr>
  </thead>
  <tbody>
    {% for item in order_items %}
    {% with ord=item.order %}
    <tr class="{% if ord.order_status != 'NEW' %}table-secondary{% endif %}">
      <td class="lot-cell" data-order-lot="{{ ord.order_lot }}" data-order-id="{{ ord.id }}">
        <span class="mono">{{ ord.order_lot }}</span>
        <button type="button" class="btn btn-sm btn-outline-dark ms-1 btn-po-modal"
                data-order-id="{{ ord.id }}">발주서</button>
      </td>
      <td class="vendor-cell">{{ ord.vendor.name }}</td>
      <td class="orderdate-cell">{{ ord.order_date|date:"Y-m-d" }}</td>
      <td class="text-start">{{ item.item_name_snapshot }}</td>
      <td>{{ item.qty|intcomma }}</td>
      <td style="white-space:nowrap;">{{ item.expected_date|date:"Y-m-d" }}</td>

      <td>
        <span class="badge status {% if ord.order_status == 'NEW' %}bg-success text-white{% else %}bg-danger text-white{% endif %}">
          {{ ord.get_order_status_display }}
        </span>
      </td>

      <td>
        {% if ord.flow_status == 'NG' %}
          <span class="badge status bg-light text-secondary border border-secondary">{{ ord.get_flow_status_display }}</span>
        {% elif ord.flow_status == 'RCV' %}
          <span class="badge status bg-info text-dark">{{ ord.get_flow_status_display }}</span>
        {% elif ord.flow_status == 'PRT' %}
          <span class="badge status bg-primary">{{ ord.get_flow_status_display }}</span>
        {% else %}
          <span class="badge status bg-secondary text-white">{{ ord.get_flow_status_display }}</span>
        {% endif %}
      </td>

      <td style="white-space:nowrap;">{% if ord.cancel_at %}{{ ord.cancel_at|date:"Y-m-d H:i" }}{% else %}-{% endif %}</td>
      <td>
        {% with u=ord.cancel_by %}{% if u %}{{ u.full_name|default:u.username }}{% else %}-{% endif %}{% endwith %}
      </td>

      <td style="white-space:nowrap;">{{ ord.created_at|date:"Y-m-d H:i" }}</td>
      <td>{% with u=ord.created_by %}{% if u %}{{ u.full_name|default:u.username }}{% else %}-{% endif %}{% endwith %}</td>
      <td style="white-space:nowrap;">{{ ord.updated_at|date:"Y-m-d H:i" }}</td>
      <td>{% with u=ord.updated_by %}{% if u %}{{ u.full_name|default:u.username }}{% else %}-{% endif %}{% endwith %}</td>

      <td class="text-end">{{ item.unit_price|floatformat:0|intcomma }}</td>
      <td class="text-end">{{ item.total_price|floatformat:0|intcomma }}</td>

      <td class="actions" style="white-space:nowrap;">
        {# 수정: NEW 상태에서만 허용 #}
        {% if ord.order_status == 'NEW' and not ord.cancel_at %}
          <a class="btn btn-sm btn-outline-primary"
             href="{% url 'purchase:uni_order_edit' ord.id %}?cat={{ cat }}">수정</a>
        {% else %}
          <button class="btn btn-sm btn-outline-secondary" disabled>수정</button>
        {% endif %}

        {# 취소: NEW 상태 & 미취소 일 때만 허용 #}
        {% if ord.order_status == 'NEW' and not ord.cancel_at %}
          <form method="post" action="{% url 'purchase:uni_order_cancel' ord.id %}?cat={{ cat }}"
                style="display:inline"
                onsubmit="return confirm('이 발주를 취소 하시겠습니까?');">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-outline-danger">취소</button>
          </form>
        {% else %}
          <button class="btn btn-sm btn-outline-secondary" disabled>취소</button>
        {% endif %}
      </td>
    </tr>
    {% endwith %}
    {% empty %}
    <tr>
      <td colspan="17" class="text-center text-muted">조회된 데이터가 없습니다.</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- 페이징 -->
<nav aria-label="페이지네이션">
  <ul class="pagination pagination-sm justify-content-center">
    <li class="page-item {% if page_obj.number == 1 %}disabled{% endif %}">
      {% if page_obj.number == 1 %}
        <span class="page-link">« 처음</span>
      {% else %}
        <a class="page-link" href="?page=1{% if querystring %}&{{ querystring }}{% endif %}">« 처음</a>
      {% endif %}
    </li>
    <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
      {% if page_obj.has_previous %}
        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if querystring %}&{{ querystring }}{% endif %}">‹ 이전</a>
      {% else %}
        <span class="page-link">‹ 이전</span>
      {% endif %}
    </li>
    <li class="page-item active">
      <span class="page-link">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
    </li>
    <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
      {% if page_obj.has_next %}
        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if querystring %}&{{ querystring }}{% endif %}">다음 ›</a>
      {% else %}
        <span class="page-link">다음 ›</span>
      {% endif %}
    </li>
    <li class="page-item {% if page_obj.number == page_obj.paginator.num_pages %}disabled{% endif %}">
      {% if page_obj.number == page_obj.paginator.num_pages %}
        <span class="page-link">끝 »</span>
      {% else %}
        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if querystring %}&{{ querystring }}{% endif %}">끝 »</a>
      {% endif %}
    </li>
  </ul>
</nav>
<div class="modal fade" id="poPrintModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">발주서</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>
      <div class="modal-body" id="poPrintBody"><div class="text-muted">불러오는 중…</div></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
        <button type="button" class="btn btn-primary" id="btnPoPrint">인쇄</button>
      </div>
    </div>
  </div>
</div>
<script>
 // 같은 발주 LOT가 연속된 구간을 화면에서 병합(rowspan)
  (function () {
    const rows = Array.from(document.querySelectorAll('table tbody tr'));
    if (!rows.length) return;

    let i = 0;
    while (i < rows.length) {
      const firstRow  = rows[i];
      const lotCell   = firstRow.querySelector('td.lot-cell');
      if (!lotCell) { i++; continue; }

      const lot = lotCell.dataset.orderLot || lotCell.textContent.trim();
      let span = 1, j = i + 1;

      // 뒤의 행들 중 같은 LOT 연속 구간 찾기
      while (j < rows.length) {
        const rowJ   = rows[j];
        const lotJ   = rowJ.querySelector('td.lot-cell');
        if (!lotJ) break;
        const lotVal = lotJ.dataset.orderLot || lotJ.textContent.trim();
        if (lotVal !== lot) break;

        // 후속 행의 LOT/발주처/발주일 셀 숨김
        lotJ.style.display = 'none';
        const vJ = rowJ.querySelector('td.vendor-cell');
        if (vJ) vJ.style.display = 'none';
        const dJ = rowJ.querySelector('td.orderdate-cell');
        if (dJ) dJ.style.display = 'none';

        span++; j++;
      }

      // 첫 행의 3개 셀에 rowspan 부여
      lotCell.rowSpan = span;
      const v0 = firstRow.querySelector('td.vendor-cell');
      if (v0) v0.rowSpan = span;
      const d0 = firstRow.querySelector('td.orderdate-cell');
      if (d0) d0.rowSpan = span;

      i = j;
    }
  })();

  document.addEventListener('click', async (e)=>{
  const btn = e.target.closest('.btn-po-modal');
  if(!btn) return;
  const id = btn.dataset.orderId;
  try{
    const resp = await fetch(`{% url 'purchase:uni_order_print' 0 %}`.replace('0', id), {
      headers: {"X-Requested-With":"XMLHttpRequest"}
    });
    const html = await resp.text();
    document.getElementById('poPrintBody').innerHTML = html;
    const modal = new bootstrap.Modal(document.getElementById('poPrintModal'));
    modal.show();
  }catch(err){
    alert('발주서를 불러오지 못했습니다.');
  }
});

document.getElementById('btnPoPrint')?.addEventListener('click', ()=>{
  // 모달 안의 내용만 새 창으로 인쇄
  const body = document.getElementById('poPrintBody').innerHTML;
  const w = window.open('', 'po_print', 'width=900,height=1100');
  w.document.write('<html><head><title>발주서</title>');
  w.document.write('<meta charset="utf-8">');
  w.document.write('<style>@page{size:A4;margin:12mm} body{font-size:12px} table{width:100%;border-collapse:collapse} th,td{border:1px solid #000;padding:4px}</style>');
  w.document.write('</head><body>');
  w.document.write(body);
  w.document.write('</body></html>');
  w.document.close(); w.focus(); w.print();
});

</script>

{% endblock %}
