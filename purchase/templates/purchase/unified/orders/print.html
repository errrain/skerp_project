{% load humanize %}
<!-- templates/purchase/unified/orders/print.html -->
<style>
  /* ===== 인쇄 기본 ===== */
  @media print{
    @page{ size:A4; margin:8mm; }
    body{ -webkit-print-color-adjust:exact; print-color-adjust:exact; }
    .print-hide{ display:none !important; }
  }

  /* ===== A4 캔버스 (여백 축소) ===== */
  .po-a4{
    width: calc(210mm - 16mm);
    max-width: 194mm;
    margin:0 auto; color:#000; background:#fff;
    font-size:8pt; line-height:1.30;                 /* 줄간격 ↓ */
    font-family:"맑은 고딕","Malgun Gothic","굴림",Gulim,Arial,sans-serif;
    border:3px solid #2050b3; box-sizing:border-box;
    padding:7mm 7mm;                                  /* 10mm→7mm */
    position:relative;
  }
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
  .ta-c{text-align:center} .ta-r{text-align:right}
  .mb-2{margin-bottom:2mm}

  /* ===== 상단 1행: 제목 + 결재칸 (컴팩트) ===== */
  .row-title{ position:relative; min-height:22mm; margin:0 0 2mm; }  /* 30mm→22mm */
  .title-center{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    font-weight:900; font-size:22pt; letter-spacing:.5px;             /* 26pt→22pt */
    line-height:1.1;
  }
  .approve-wrap{
    position:absolute; right:0; top:0;
    transform: scale(0.7);                      /* ★ 30% 축소 */
    transform-origin: top right;
  }
  .approve{ width:210px; border-collapse:collapse; table-layout:fixed; font-size:6.5pt; }
  .approve th,.approve td{ border:1px solid #000; padding:3pt 3.5pt; text-align:center; vertical-align:middle }
  .approve thead th{ background:#f2f2f2; font-weight:700 }
  .approve tbody td{ height:20mm; }            /* scale(0.7) 적용 후 체감 14mm */

  /* ===== 상단 2행: 로고 + 정보표 (간격 축소) ===== */
  .row-head{ display:grid; grid-template-columns:auto 210px; gap:4mm; align-items:center; } /* 6mm→4mm */
  .logo-box{ display:flex; align-items:center; gap:6mm; justify-content:flex-start; }
  .logo-box .name{ font-weight:800; font-size:8pt; }
  .logo-box img{ height:14mm; width:auto; object-fit:contain; }      /* 18mm→14mm */
  .logo-ph{ width:14mm; height:14mm; border:1px solid #000; display:flex; align-items:center; justify-content:center; font-size:7pt }

  .infotab{ width:100%; border-collapse:collapse; table-layout:fixed; font-size:7.3pt; }
  .infotab th,.infotab td{ border:1px solid #000; padding:3pt 4.5pt; line-height:1.2; vertical-align:middle }
  .infotab th{ background:#f2f2f2; width:64px; font-weight:700 }

  /* ===== 수신/발주LOT/담당자 + 우측 회사정보 ===== */
  .box{ border:2px solid #000; padding:0; margin-top:3mm; }          /* 6mm→3mm */
  .meta{ width:100%; border-collapse:collapse; table-layout:fixed; font-size:8pt; }
  .meta th,.meta td{ border:1px solid #000; padding:4pt 6pt; vertical-align:middle }
  .meta th{ background:#f2f2f2; width:80px; font-weight:700 }
  .meta.meta-3col .meta-right{ vertical-align:top; }

  /* ===== 중앙 문구 (여백 축소) ===== */
  .center-note{ margin:3mm 0 1.5mm; text-align:center; font-size:9.5pt; font-weight:700; }
  .center-sub { text-align:center; font-size:9pt; margin-bottom:2mm; }

  /* ===== 품목 테이블 (셀 패딩↓, 폭 재배치) ===== */
  .tbl{ width:100%; border-collapse:collapse; table-layout:fixed; font-size:8pt; border:1pt solid #000; }
  .tbl thead th{ background:#f2f2f2; font-weight:700 }
  .tbl th,.tbl td{ border:1pt solid #000; padding:3.5pt 5pt; vertical-align:middle }
  .tbl th:last-child, .tbl td:last-child{ border-right:1.2pt solid #000; } /* 비고 테두리 보강 */

  /* 열 너비 (세부항목/규격 확대, 수량/단가/금액 축소) */
  .w-no{ width:32px }
  .w-name{ width:40% !important; }
  .w-spec{ width:30% !important; }
  .w-unit{ width:44px !important; }
  .w-qty{ width:60px !important; }
  .w-price{ width:84px !important; }
  .w-amt{ width:96px !important; }
  .w-remark{ width:auto }

  /* ===== 합계/각주 (간격 축소) ===== */
  .sum-row th{ background:#f2f2f2 }
  .sum-wrap{ display:grid; grid-template-columns:1fr 1fr; gap:4mm; align-items:start; margin-top:3mm; font-size:8pt; }
  .sum-note{ font-size:8.3pt; color:#555 }

  .bullet{ margin-top:4mm; font-size:8.3pt; }
  .bullet li{ margin:2px 0 }
  .footer{ margin-top:4mm; text-align:center; font-size:8.3pt; }

    /* 비고 열 폭/테두리 보강 */
  .w-remark{ width: 60px !important; min-width: 56px; }  /* 헤더 글자 잘리지 않도록 고정폭 */
  .tbl th:last-child,
  .tbl td:last-child{ border-right: 1.2pt solid #000; }  /* 오른쪽 외곽선 확실히 */

  /* 워터마크(옵션) */
  .wm{
    position:absolute; left:0; right:0; top:53%; transform:translateY(-50%);
    text-align:center; font-size:28pt; color:#000; opacity:.06; font-weight:800; pointer-events:none;
  }
</style>

<div class="po-a4">
  <!-- 상단 1행: 제목(가운데) + 결재칸(오른쪽) -->
  <div class="row-title">
    <div class="title-center">발주서</div>
    <div class="approve-wrap">
      <table class="approve">
        <thead>
          <tr><th>담당</th><th>승인</th><th>결재</th></tr>
        </thead>
        <tbody>
          <tr><td></td><td></td><td></td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- 상단 2행: 좌(로고/회사명, 좌정렬) + 우(부서/작성자/작성일자) -->
  <div class="row-head mb-2">
    <div class="logo-box">
      {% if company_logo_url %}
        <img src="{{ company_logo_url }}" alt="서경화학 로고">
      {% else %}
        <div class="logo-ph">LOGO</div>
      {% endif %}
    </div>
    <table class="infotab">
      <tbody>
        <tr><th>부서명</th><td>구매부</td></tr>
        <tr><th>작성자</th><td>{{ order.created_by.full_name|default:order.created_by.username }}</td></tr>
        <tr><th>작성일자</th><td>{{ order.order_date|date:"Y년 m월 d일" }}</td></tr>
      </tbody>
    </table>
  </div>

  <!-- 수신/발주LOT/담당자 + 회사정보 -->
  <div class="box">
    <table class="meta meta-3col">
      <colgroup>
        <col style="width:80px">
        <col>
        <col style="width:45%">
      </colgroup>
      <tbody>
        <tr>
          <th>수신</th>
          <td>{{ order.vendor.name }}</td>
          <td rowspan="3" class="meta-right">
            ㈜서경화학&nbsp;&nbsp;<br>광주광역시 광산구 월전동 912-23<br>
            TEL {{ company_tel|default:"(062) 716-8264" }} <br> FAX {{ company_fax|default:"(062) 716-8267" }}
          </td>
        </tr>
        <tr>
          <th>발주 LOT</th>
          <td class="mono">{{ order.order_lot }}</td>
        </tr>
        <tr>
          <th>담당자</th>
          <td>
            {% with name=order.vendor.manager_name phone=order.vendor.contact_phone %}
              {% if name %}{{ name }}{% else %}-{% endif %}
              {% if phone %} : {{ phone }}{% endif %}
            {% endwith %}
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- 중앙 문구 -->
  <div class="center-note">입고 요청일: {{ due_text }}</div>
  <div class="center-sub">아래와 같이 발주합니다</div>

  <!-- 항목 테이블 -->
  <table class="tbl">
  <thead>
    <tr class="ta-c">
      <th class="w-no">No</th>
      <th class="w-name">세부항목</th>
      <th class="w-spec">규격</th>
      <th class="w-unit">단위</th>
      <th class="w-qty">수량</th>
      <th class="w-price">단가</th>
      <th class="w-amt">금액</th>
      <th class="w-remark">비고</th>
    </tr>
  </thead>
  <tbody>
    {# ----- 실제 데이터 ----- #}
    {% for it in items %}
    <tr>
      <td class="ta-c">{{ forloop.counter }}</td>
      <td>{{ it.item_name_snapshot }}</td>
      <td>{{ it.spec_snapshot }}</td>
      <td class="ta-c">{{ it.unit_name|default:"KG" }}</td>
      <td class="ta-r">{{ it.qty|default_if_none:0|intcomma }}</td>
      <td class="ta-r">{{ it.unit_price|default_if_none:0|floatformat:"0"|intcomma }}</td>
      <td class="ta-r">{{ it.amount|default_if_none:0|floatformat:"0"|intcomma }}</td>
      <td>{{ it.remark|default_if_none:"" }}</td>
    </tr>
    {% empty %}
    {% endfor %}

    {# ----- 빈 행으로 채워 target_rows 보장 & No 연속부여 ----- #}
    {% with start=items|length %}
      {% for _ in filler_range %}
      <tr>
        <td class="ta-c">{{ forloop.counter|add:start }}</td>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td class="ta-c">&nbsp;</td>
        <td class="ta-r">&nbsp;</td>
        <td class="ta-r">&nbsp;</td>
        <td class="ta-r">&nbsp;</td>
        <td>&nbsp;</td>
      </tr>
      {% endfor %}
    {% endwith %}

    {# ----- 합계 ----- #}
    <tr class="sum-row">
      <th class="ta-c" colspan="4">합 계</th>
      <th class="ta-r">{{ total_qty|default_if_none:0|intcomma }}</th>
      <th></th>
      <th class="ta-r"><b>{{ total_amount|default_if_none:0|floatformat:"0"|intcomma }}</b></th>
      <th></th>
    </tr>
  </tbody>
</table>


  <div class="sum-wrap">
    <div class="sum-note">※ 금액은 부가세 포함입니다.</div>
    <div class="ta-r" style="font-weight:700; font-size:13px;">
       {{ total_amount_vat|default:total_amount|floatformat:0|intcomma }} 원
    </div>
  </div>

  <ol class="bullet">
    <li>입고예정일 연락 부탁드립니다.</li>
    <li>입고지연/변경 연락 부탁드립니다.</li>
    <li>견적가 기반/세부조건을 준수해주시기 바랍니다.</li>
    <li>아울러 결제조건 또한 같이 알려 주십시오.</li>
  </ol>
  <div class="footer">정품, 정량, 납기준수는 당사의 소중한 도움이 됩니다. 감사합니다.</div>

  <div class="wm">{{ page_no|default:"1" }} 페이지</div>
</div>
