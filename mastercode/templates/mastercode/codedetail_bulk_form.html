{% extends 'base.html' %}
{% load widget_tweaks %}

{% block content %}
<h4>ì½”ë“œìƒì„¸ ì¼ê´„ ë“±ë¡</h4>

<form method="post" id="formset-form" novalidate>
    {% csrf_token %}
    {{ formset.management_form }}

    {% if formset.non_form_errors %}
    <div class="alert alert-danger">
        {{ formset.non_form_errors }}
    </div>
    {% endif %}

    <table class="table table-bordered table-sm align-middle text-center" style="font-size: 12px;" id="formset-table">
        <thead class="table-light">
            <tr>
                <th>ì½”ë“œê·¸ë£¹</th>
                <th>ì½”ë“œ</th>
                <th>ì½”ë“œëª…</th>
                <th>ì •ë ¬ìˆœì„œ</th>
                <th>ì‚¬ìš©ì—¬ë¶€</th>
            </tr>
        </thead>
        <tbody>
            {% for form in formset %}
            <tr class="form-row">
                <td>{{ form.group|add_class:"form-select form-select-sm" }}</td>
                <td>{{ form.code|add_class:"form-control form-control-sm" }}</td>
                <td>{{ form.name|add_class:"form-control form-control-sm" }}</td>
                <td>{{ form.sort_order|add_class:"form-control form-control-sm" }}</td>
                <td class="text-center">{{ form.is_active|add_class:"form-check-input" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="mb-3">
        <button type="button" class="btn btn-outline-primary btn-sm" id="add-row">[ + ] í–‰ ì¶”ê°€</button>
    </div>

    <div class="mt-3">
        <button type="submit" class="btn btn-success btn-sm">ğŸ’¾ ì €ì¥</button>
        <a href="{% url 'mastercode:codedetail_list' %}?group={{ group_id }}" class="btn btn-secondary btn-sm">â† ëª©ë¡ìœ¼ë¡œ</a>
    </div>
</form>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const addRowBtn = document.getElementById("add-row");
    const formsetTable = document.getElementById("formset-table").getElementsByTagName("tbody")[0];
    const totalForms = document.getElementById("id_form-TOTAL_FORMS");

    addRowBtn.addEventListener("click", function () {
        const currentCount = parseInt(totalForms.value);
        const lastRow = formsetTable.querySelector(".form-row:last-child");
        const newRow = lastRow.cloneNode(true);

        // ëª¨ë“  input/select ì´ˆê¸°í™” ë° name ë³€ê²½
        newRow.querySelectorAll("input, select").forEach(function (input) {
            const name = input.name.replace(/-\d+-/, `-${currentCount}-`);
            const id = input.id.replace(/-\d+-/, `-${currentCount}-`);
            input.name = name;
            input.id = id;

            if (input.type === "checkbox") {
                input.checked = false;
            } else {
                input.value = "";
            }+
        });

        totalForms.value = currentCount + 1;
        formsetTable.appendChild(newRow);
    });
});
</script>
{% endblock %}
