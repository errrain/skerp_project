{# mis/templates/trace/lot_trace.html #}
{% extends "base.html" %}

{% block content %}
<style>
/* ===============================
   Mermaid LOT Trace ìŠ¤íƒ€ì¼ (ì•ˆì „ ë²„ì „)
   =============================== */

/* ì „ì²´ ì»¨í…Œì´ë„ˆ ì •ëˆ */
.trace-container {
    padding: 10px 20px;
}

/* Mermaid ê·¸ë˜í”„ í¬ê¸° ì¡°ì • */
.mermaid {
    width: 100%;
    overflow-x: auto;
    padding: 10px 0;
}

/* ---------------------------------------------------
   1) ë…¸ë“œ ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ â€” ìœ„ì¹˜(translate) ì˜í–¥ ì—†ìŒ!
   --------------------------------------------------- */

/* Mermaid ë…¸ë“œëŠ” g.node ë¡œ êµ¬ì„±ë¨ â†’ transform ê¸ˆì§€!! */
.mermaid svg g.node {
    opacity: 0;
    animation: nodeFade 1.6s ease-out forwards;
}

@keyframes nodeFade {
    0% { opacity: 0; }
    100% { opacity: 1; }
}

/* ---------------------------------------------------
   2) ë…¸ë“œ ë°•ìŠ¤(rect)ë§Œ ì‚´ì§ í™•ëŒ€ (ì„ íƒì ìœ¼ë¡œ ì¼œë„ ì•ˆì „í•¨)
   --------------------------------------------------- */
.mermaid svg g.node rect {
    transform-origin: center;
    transform-box: fill-box;
    animation: nodeScale 0.6s ease-out;
}

@keyframes nodeScale {
    0%   { transform: scale(0.92); }
    100% { transform: scale(1.0); }
}

/* ---------------------------------------------------
   3) í™”ì‚´í‘œ(ì—ì§€) ì• ë‹ˆë©”ì´ì…˜ â€” ë¶€ë“œëŸ½ê²Œ ê·¸ë ¤ì§
   --------------------------------------------------- */
.mermaid svg path {
    stroke-dasharray: 260;
    stroke-dashoffset: 260;
    animation: drawEdge 0.9s ease-out forwards;
}

@keyframes drawEdge {
    0%   { stroke-dashoffset: 260; }
    100% { stroke-dashoffset: 0; }
}

/* ---------------------------------------------------
   4) ë…¸ë“œ(ë°•ìŠ¤) ìŠ¤íƒ€ì¼ ì»¤ìŠ¤í…€ (ìƒ‰ê° ê°œì„ )
   --------------------------------------------------- */
.mermaid svg g.node rect {
    fill: #f9f6ff;        /* ì€ì€í•œ ë¼ë²¤ë” */
    stroke: #8c77ff;      /* ë³´ë¼ë¹› ìœ¤ê³½ì„  */
    stroke-width: 1.4px;
    rx: 6px;              /* ë‘¥ê·¼ ëª¨ì„œë¦¬ */
}

.mermaid svg g.node text {
    fill: #333;
    font-weight: 600;
    font-size:3px;
}

</style>

<div class="container-fluid mt-3">
  <h4>LOT ì¶”ì (Trace) ë·°ì–´</h4>

  <!-- ğŸ” LOT ì…ë ¥ ì˜ì—­ -->
  <form id="lot-trace-form" class="card mb-3">
    <div class="card-header py-2">
      LOT ê²€ìƒ‰
    </div>
    <div class="card-body py-2">
      <div class="row g-2 align-items-center">
        <div class="col-auto">
          <label for="lot-input" class="col-form-label col-form-label-sm">
            LOT ë²ˆí˜¸
          </label>
        </div>
        <div class="col-4">
          <input type="text"
                 id="lot-input"
                 name="lot_no"
                 class="form-control form-control-sm"
                 placeholder="ì˜ˆ) OR20251211-001, IN20251211002-02, JB20251211-001, C-20251211-01, SH20251211-001">
        </div>
        <div class="col-auto">
          <button type="submit" class="btn btn-primary btn-sm" id="btn-trace">
            ì¶”ì 
          </button>
        </div>
        <div class="col-auto text-muted small">
          OR / IN / IN-SS / JB / C-LOT / SHLOT ëª¨ë‘ ì…ë ¥ ê°€ëŠ¥
        </div>
      </div>
    </div>
  </form>

  <!-- âš™ Trace ê²°ê³¼/ë©”ì‹œì§€ -->
  <div id="trace-message" class="mb-2 text-muted small"></div>

  <!-- ğŸ§  Mind-map/ë‹¤ì´ì–´ê·¸ë¨ ì˜ì—­ -->
  <div class="card">
    <div class="card-header py-2">
      LOT íë¦„ ë‹¤ì´ì–´ê·¸ë¨
    </div>
    <div class="card-body py-2">
      <div id="diagram-container">
        <pre class="mermaid" id="mermaid-code">
graph LR
    A[LOTë¥¼ ì…ë ¥í•˜ê³  ì¶”ì  ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.]
        </pre>
      </div>
    </div>
  </div>
</div>

<!-- Mermaid CDN -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

<script>
// Mermaid ì´ˆê¸° ì„¤ì •
mermaid.initialize({ startOnLoad: false });

document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('lot-trace-form');
  const lotInput = document.getElementById('lot-input');
  const msgBox = document.getElementById('trace-message');
  const mermaidEl = document.getElementById('mermaid-code');

  const traceUrl = "{% url 'mis:lot_trace_api' %}";

  form.addEventListener('submit', function (e) {
    e.preventDefault();

    const lotNo = (lotInput.value || '').trim();
    if (!lotNo) {
      alert('LOT ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
      return;
    }

    msgBox.textContent = 'ì¡°íšŒ ì¤‘ì…ë‹ˆë‹¤...';

    const url = traceUrl + '?lot_no=' + encodeURIComponent(lotNo);

    fetch(url, { method: 'GET' })
      .then(res => res.json())
      .then(data => {
        if (!data.success) {
          msgBox.textContent = data.message || 'ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
          return;
        }

        msgBox.textContent = data.summary || '';

        // ì„œë²„ì—ì„œ ë‚´ë ¤ì¤€ mermaid ì½”ë“œë¡œ êµì²´
        mermaidEl.textContent = data.mermaid || 'graph LR\n  A[ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤]';

        // Mermaid ë‹¤ì‹œ ë Œë”ë§
        mermaid.run({
          querySelector: '#diagram-container .mermaid'
        });
      })
      .catch(err => {
        console.error(err);
        msgBox.textContent = 'ì¡°íšŒ ì¤‘ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      });
  });
});
</script>
{% endblock %}
