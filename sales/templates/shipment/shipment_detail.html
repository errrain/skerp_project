{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-3">
  <h4>ì¶œí•˜ ìƒì„¸</h4>

  <!-- ğŸ”¹ ì¶œí•˜ ê¸°ë³¸ ì •ë³´ (ë§ˆìŠ¤í„°) -->
  <div class="card mb-3">
    <div class="card-header py-2">
      ì¶œí•˜ ì •ë³´
    </div>
    <div class="card-body py-2">
      <div class="row g-2 mb-2">
        <div class="col-3">
          <label class="form-label form-label-sm">ì¶œí•˜ LOT</label>
          <input type="text"
                 class="form-control form-control-sm"
                 value="{{ shipment.sh_lot }}"
                 readonly>
        </div>
        <div class="col-3">
          <label class="form-label form-label-sm">ì¶œí•˜ì¼</label>
          <input type="text"
                 class="form-control form-control-sm"
                 value="{{ shipment.ship_date|date:'Y-m-d' }}"
                 readonly>
        </div>
        <div class="col-3">
          <label class="form-label form-label-sm">ì¶œê³ ì</label>
          <input type="text"
                 class="form-control form-control-sm"
                 value="{{ shipment.operator }}"
                 readonly>
        </div>
        <div class="col-3">
          <label class="form-label form-label-sm">ê³ ê°ì‚¬</label>
          <input type="text"
                 class="form-control form-control-sm"
                 value="{{ shipment.customer.name }}"
                 readonly>
        </div>
      </div>

      <div class="row g-2 mb-2">
        <div class="col-4">
          <label class="form-label form-label-sm">í”„ë¡œê·¸ë¨</label>
          <input type="text"
                 class="form-control form-control-sm"
                 value="{{ shipment.program }}"
                 readonly>
        </div>
        <div class="col-4">
          <label class="form-label form-label-sm">í’ˆëª…</label>
          <input type="text"
                 class="form-control form-control-sm"
                 value="{{ shipment.product_name }}"
                 readonly>
        </div>
        <div class="col-4">
          <label class="form-label form-label-sm">ì´ ì¶œí•˜ ìˆ˜ëŸ‰</label>
          <input type="text"
                 class="form-control form-control-sm text-end"
                 value="{{ shipment.total_qty }}"
                 readonly>
        </div>
      </div>

      <div class="mb-1">
        <label class="form-label form-label-sm">ë¹„ê³ </label>
        <textarea class="form-control form-control-sm"
                  rows="2"
                  readonly>{{ shipment.memo }}</textarea>
      </div>
    </div>
  </div>

  <!-- ğŸ”¹ ì¶œí•˜ C-LOT ëª©ë¡ (ë¼ì¸) -->
  <!-- ğŸ”¹ ì¶œí•˜ C-LOT ëª©ë¡ (ë¼ì¸ + LOT ì¶”ì ) -->
  <div class="card mb-3">
    <div class="card-header py-2 d-flex justify-content-between align-items-center">
      <span>ì¶œí•˜ LOT ëª©ë¡</span>
      <span class="text-muted small">
        ì´ {{ lines|length }}ê±´
      </span>
        <div>
          <button type="button" class="btn btn-outline-primary btn-sm" id="btn-add-line">
            ì¶”ê°€
          </button>
      </div>
    </div>
    <div class="card-body py-2">
      <table class="table table-sm table-bordered table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th style="width: 50px;" class="text-center">No</th>
            <th>í”„ë¡œê·¸ë¨</th>
            <th>í’ˆëª…</th>
            <th style="width: 80px;" class="text-end">ìˆ˜ëŸ‰</th>
            <th style="width: 150px;">ë°œì£¼ LOT</th>
            <th style="width: 220px;">ì…ê³  LOT (ì‚¬ì¶œì¼)</th>
            <th style="width: 150px;">ìƒì‚° LOT</th>
            <th style="width: 150px;">ê²€ì‚¬ LOT</th>
            <th style="width: 120px;">ê²€ì‚¬ì</th>
            <th style="width: 70px;" class="text-center">ì‚­ì œ</th>
          </tr>
        </thead>
        <tbody>
          {% for line in lines %}
          {% with box=line.finished_box %}
           <tr data-line-id="{{ line.id }}">
            <td class="text-center">{{ forloop.counter }}</td>
            <td>{{ box.program }}</td>
            <td>{{ box.product_name }}</td>
            <td class="text-end">
              {{ line.quantity }}
            </td>
            <td>{{ box.order_lot }}</td>
            <td>{{ box.in_lot }}</td>
            <td>{{ box.work_lot }}</td>
            <td>{{ box.inspect_lot }}</td>
            <td>{{ box.inspector }}</td>
            <td class="text-center">
              <button type="button"
                      class="btn btn-outline-danger btn-sm btn-line-delete">
                ì‚­ì œ
              </button>
            </td>
          </tr>
          {% endwith %}
          {% empty %}
          <tr>
            <td colspan="9" class="text-center text-muted">
              ì¶œí•˜ ë¼ì¸ì´ ì—†ìŠµë‹ˆë‹¤.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- ğŸ”¹ í•˜ë‹¨ ë²„íŠ¼ -->
  <div class="d-flex justify-content-between mt-2">
    <div>
      <!-- ë‚˜ì¤‘ì— ì¶œí•˜ ì·¨ì†Œ ë“± ê¸°ëŠ¥ ìë¦¬ -->
    </div>
    <div>
      <a href="{% url 'sales:shipment_list' %}" class="btn btn-secondary btn-sm">
        ëª©ë¡
      </a>
      <button type="button" id="btn-shipment-update" class="btn btn-primary btn-sm">
        ìˆ˜ì •
      </button>
    </div>
  </div>
</div>

<!-- ğŸ”¹ C-LOT ì¶”ê°€ ëª¨ë‹¬ -->
<!-- ğŸ”¹ C-LOT ì¶”ê°€ ëª¨ë‹¬ (ê²€ìƒ‰í˜•) -->
<div class="modal fade" id="addLineModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h6 class="modal-title">C-LOT ì¶”ê°€</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body py-2">
        <!-- ê²€ìƒ‰ ì˜ì—­ -->
        <form class="mb-2" id="add-search-form">
          <div class="row g-2 align-items-center">
            <div class="col-auto">
              <label class="col-form-label col-form-label-sm">í”„ë¡œê·¸ë¨</label>
            </div>
            <div class="col-2">
              <input type="text" id="search-program"
                     class="form-control form-control-sm">
            </div>

            <div class="col-auto">
              <label class="col-form-label col-form-label-sm">í’ˆëª…</label>
            </div>
            <div class="col-4">
              <input type="text" id="search-product"
                     class="form-control form-control-sm">
            </div>

            <div class="col-auto">
              <label class="col-form-label col-form-label-sm">C-LOT</label>
            </div>
            <div class="col-3">
              <input type="text" id="search-clot"
                     class="form-control form-control-sm">
            </div>

            <div class="col-auto">
              <button type="button" class="btn btn-secondary btn-sm" id="btn-search-clot">
                ì¡°íšŒ
              </button>
            </div>
          </div>
        </form>

        <!-- ê²€ìƒ‰ ê²°ê³¼ í…Œì´ë¸” -->
        <div class="table-responsive" style="max-height: 360px; overflow-y:auto;">
          <table class="table table-sm table-bordered table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th style="width:36px;" class="text-center">
                  <input type="checkbox" id="chk-all-add">
                </th>
                <th>í”„ë¡œê·¸ë¨</th>
                <th>í’ˆëª…</th>
                <th style="width:80px;" class="text-end">ìˆ˜ëŸ‰</th>
                <th style="width:150px;">ë°œì£¼ LOT</th>
                <th style="width:220px;">ì…ê³  LOT (ì‚¬ì¶œì¼)</th>
                <th style="width:150px;">ìƒì‚° LOT</th>
                <th style="width:150px;">C-LOT</th>
                <th style="width:120px;">ê²€ì‚¬ì</th>
              </tr>
            </thead>
            <tbody id="add-result-body">
              <tr>
                <td colspan="9" class="text-center text-muted">
                  ì¡°íšŒ ì¡°ê±´ì„ ì…ë ¥í•œ í›„ [ì¡°íšŒ] ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="text-muted small mt-1">
          â€» ì´ë¯¸ ì¶œí•˜ëœ C-LOT ì€ ì¡°íšŒ ëŒ€ìƒì—ì„œ ì œì™¸ë©ë‹ˆë‹¤.
        </div>
      </div>

      <div class="modal-footer py-2">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
          ë‹«ê¸°
        </button>
        <button type="button" class="btn btn-primary btn-sm" id="btn-add-clot-confirm">
          ì„ íƒ C-LOT ì¶”ê°€
        </button>
      </div>
    </div>
  </div>
</div>

<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

document.addEventListener('DOMContentLoaded', function () {
  // ---------------- ê¸°ë³¸ ì„¤ì • ----------------
  const shipmentId = {{ shipment.id }};
  const deleteLineIds = new Set();   // ì‚­ì œ ì˜ˆì • ë¼ì¸ id
  const addClots = new Set();        // ì¶”ê°€ ì˜ˆì • C-LOT ì½”ë“œ

  const updateUrl = "{% url 'sales:shipment_update' shipment.id %}";

  // ---------------- ì‚­ì œ í† ê¸€ ----------------
  document.querySelectorAll('.btn-line-delete').forEach(function (btn) {
    btn.addEventListener('click', function () {
      const tr = btn.closest('tr');
      if (!tr) return;

      const lineId = tr.getAttribute('data-line-id');
      if (!lineId) return;           // data-line-id ì—†ìœ¼ë©´ ì•„ë¬´ ê²ƒë„ ì•ˆ í•¨

      if (deleteLineIds.has(lineId)) {
        // ì´ë¯¸ ì‚­ì œ í‘œì‹œ â†’ ì·¨ì†Œ
        deleteLineIds.delete(lineId);
        tr.classList.remove('table-danger');
      } else {
        // ìƒˆë¡œ ì‚­ì œ í‘œì‹œ
        deleteLineIds.add(lineId);
        tr.classList.add('table-danger');  // ë¹¨ê°„ ì¤„í‘œì‹œ
      }
    });
  });

  // ---------------- ì¶”ê°€ ëª¨ë‹¬ ê´€ë ¨ ----------------
  const addBtn = document.getElementById('btn-add-line');
  const addModalEl = document.getElementById('addLineModal');
  let addModal = null;

  if (addBtn && addModalEl && typeof bootstrap !== 'undefined') {
    addModal = new bootstrap.Modal(addModalEl);
  }

  // ë‘ ê°€ì§€ ëª¨ë‹¬ íƒ€ì… ëª¨ë‘ ì§€ì›:
  // 1) ë‹¨ì¼ ì…ë ¥:  <input id="add-clot-input">
  // 2) ê²€ìƒ‰í˜•:     ê²€ìƒ‰ì¡°ê±´ + ê²°ê³¼í…Œì´ë¸” (search-program, search-product, search-clot, add-result-body, chk-all-add)
  const addInput       = document.getElementById('add-clot-input');        // ë‹¨ì¼ C-LOT ì…ë ¥
  const searchProgram  = document.getElementById('search-program');
  const searchProduct  = document.getElementById('search-product');
  const searchClot     = document.getElementById('search-clot');
  const resultBody     = document.getElementById('add-result-body');
  const chkAllAdd      = document.getElementById('chk-all-add');
  const searchBtn      = document.getElementById('btn-search-clot');

  // ê²€ìƒ‰ API URL (ê²€ìƒ‰í˜• ëª¨ë‹¬ì´ ìˆì„ ë•Œë§Œ ì‚¬ìš©)
  const searchUrl = "{% url 'sales:shipment_box_search' shipment.id %}";

  // "ì¶”ê°€" ë²„íŠ¼ â†’ ëª¨ë‹¬ ì˜¤í”ˆ
  if (addBtn && addModal) {
    addBtn.addEventListener('click', function () {
      // ê²€ìƒ‰í˜• ëª¨ë‹¬ì´ ìˆëŠ” ê²½ìš°: ê¸°ë³¸ ê²€ìƒ‰ì¡°ê±´ ì„¸íŒ…
      if (searchProgram && searchProduct && resultBody) {
        searchProgram.value = "{{ shipment.program|default:''|escapejs }}";
        searchProduct.value = "{{ shipment.product_name|default:''|escapejs }}";
        if (searchClot) searchClot.value = "";

        resultBody.innerHTML = `
          <tr>
            <td colspan="9" class="text-center text-muted">
              ì¡°íšŒ ì¡°ê±´ì„ ì…ë ¥í•œ í›„ [ì¡°íšŒ] ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.
            </td>
          </tr>
        `;
        if (chkAllAdd) chkAllAdd.checked = false;
      }

      // ë‹¨ì¼ ì…ë ¥ ëª¨ë‹¬ì¼ ê²½ìš°: ì…ë ¥ê°’ ë¹„ìš°ê¸°
      if (addInput) {
        addInput.value = "";
      }

      addModal.show();
    });
  }

  // ---------------- ê²€ìƒ‰í˜• ëª¨ë‹¬: ì¡°íšŒ ë²„íŠ¼ ----------------
  if (searchBtn && resultBody) {
    searchBtn.addEventListener('click', function () {
      const params = new URLSearchParams({
        program:      (searchProgram && searchProgram.value) || "",
        product_name: (searchProduct && searchProduct.value) || "",
        c_lot:        (searchClot && searchClot.value) || "",
      });

      fetch(`${searchUrl}?${params.toString()}`)
        .then(res => res.json())
        .then(data => {
          if (!data.success) {
            alert(data.message || "ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            return;
          }
          const rows = data.results || [];
          if (!rows.length) {
            resultBody.innerHTML = `
              <tr>
                <td colspan="9" class="text-center text-muted">
                  ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
                </td>
              </tr>`;
            return;
          }

          let html = "";
          rows.forEach(row => {
            html += `
              <tr>
                <td class="text-center">
                  <input type="checkbox" class="chk-add-clot" value="${row.c_lot}">
                </td>
                <td>${row.program}</td>
                <td>${row.product_name}</td>
                <td class="text-end">${row.qty}</td>
                <td>${row.order_lot}</td>
                <td>${row.in_lot}</td>
                <td>${row.work_lot}</td>
                <td>${row.c_lot}</td>
                <td>${row.inspector}</td>
              </tr>`;
          });
          resultBody.innerHTML = html;
        })
        .catch(err => {
          console.error(err);
          alert("ì¡°íšŒ ì¤‘ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
    });
  }

  // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ (ê²€ìƒ‰í˜• ëª¨ë‹¬)
  if (chkAllAdd) {
    chkAllAdd.addEventListener('change', function () {
      document.querySelectorAll('.chk-add-clot').forEach(chk => {
        chk.checked = chkAllAdd.checked;
      });
    });
  }

  // ---------------- "ì„ íƒ C-LOT ì¶”ê°€" ë²„íŠ¼ ----------------
  const addConfirmBtn = document.getElementById('btn-add-clot-confirm');
  if (addConfirmBtn) {
    addConfirmBtn.addEventListener('click', function () {
      // 1) ê²€ìƒ‰í˜• ëª¨ë‹¬ì´ ìˆëŠ” ê²½ìš°: ì²´í¬ëœ C-LOT ìˆ˜ì§‘
      const checked = document.querySelectorAll('.chk-add-clot:checked');
      if (checked.length > 0) {
        checked.forEach(chk => addClots.add(chk.value));
        if (addModal) addModal.hide();
        alert("ì¶”ê°€ ì˜ˆì • C-LOT: " + Array.from(addClots).join(", "));
        return;
      }

      // 2) ê²€ìƒ‰í˜•ì´ ì—†ê³ , ë‹¨ì¼ ì…ë ¥ í•„ë“œë§Œ ìˆëŠ” ê²½ìš° fallback
      if (addInput) {
        const val = (addInput.value || "").trim();
        if (!val) {
          alert("C-LOT ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
          return;
        }
        addClots.add(val);
        if (addModal) addModal.hide();
        alert("ì¶”ê°€ ì˜ˆì • C-LOT: " + val);
        return;
      }

      alert("ì¶”ê°€í•  C-LOTë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
    });
  }

  // ---------------- "ìˆ˜ì •" ë²„íŠ¼ â†’ ì„œë²„ë¡œ ë³€ê²½ì‚¬í•­ ì „ì†¡ ----------------
  const updateBtn = document.getElementById('btn-shipment-update');
  if (updateBtn) {
    updateBtn.addEventListener('click', function () {
      if (deleteLineIds.size === 0 && addClots.size === 0) {
        alert('ë³€ê²½ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      if (!confirm('ì¶œí•˜ ì •ë³´ë¥¼ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      const payload = {
        delete_line_ids: Array.from(deleteLineIds),
        add_clots: Array.from(addClots),
      };

      fetch(updateUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify(payload),
      })
      .then(res => res.json())
      .then(data => {
        if (!data.success) {
          alert(data.message || 'ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          return;
        }
        alert('ì¶œí•˜ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        window.location.reload();
      })
      .catch(err => {
        console.error(err);
        alert('ìˆ˜ì • ì¤‘ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      });
    });
  }
});
</script>

{% endblock %}
