<!-- shipment_form.html -->
{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-3">
  <h4>ì¶œí•˜ ë“±ë¡</h4>

  <!-- ğŸ”¹ ì¶œí•˜ ê¸°ë³¸ ì •ë³´ = ì œí’ˆ ê²€ìƒ‰ ì˜ì—­ (í”„ë¡œê·¸ë¨ / í’ˆëª…) -->
  <form method="get" class="mb-3">
    <div class="card mb-2">
      <div class="card-header py-2">
        ì¶œí•˜ ê¸°ë³¸ ì •ë³´
      </div>
      <div class="card-body py-2">
        <div class="row g-2 align-items-center">
          <div class="col-auto">
            <label class="col-form-label col-form-label-sm">í”„ë¡œê·¸ë¨</label>
          </div>
          <div class="col-2">
            <input type="text"
                   name="program"
                   value="{{ program }}"
                   class="form-control form-control-sm" />
          </div>

          <div class="col-auto">
            <label class="col-form-label col-form-label-sm">í’ˆëª…</label>
          </div>
          <div class="col-4">
            <input type="text"
                   name="product_name"
                   value="{{ product_name }}"
                   class="form-control form-control-sm" />
          </div>

          <div class="col-auto">
            <button type="submit" class="btn btn-secondary btn-sm">
              ì¡°íšŒ
            </button>
          </div>
        </div>
      </div>
    </div>
  </form>

  <!-- ğŸ”¹ ì™„ì œí’ˆ LOT ì„ íƒ í…Œì´ë¸” -->
  <div class="card mb-3">
    <div class="card-header py-2">
      ì™„ì œí’ˆ LOT ì„ íƒ
    </div>
    <div class="card-body py-2">
      <table class="table table-sm table-bordered table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th style="width: 36px;"></th>
            <th>í”„ë¡œê·¸ë¨</th>
            <th>í’ˆëª…</th>
            <th style="width: 80px;">ìˆ˜ëŸ‰</th>
            <th style="width: 150px;">ë°œì£¼ LOT</th>
            <th style="width: 300px;">ì…ê³  LOT (ì‚¬ì¶œì¼)</th>
            <th style="width: 150px;">ìƒì‚° LOT</th>
            <th style="width: 150px;">ê²€ì‚¬ LOT</th>
            <th style="width: 140px;">ê²€ì‚¬ì</th>
          </tr>
        </thead>
        <tbody>
          {% for box in box_list %}
          <tr>
            <td class="text-center">
              <input type="checkbox"
                     name="box_ids"
                     value="{{ box.id }}"
                     data-qty="{{ box.display_qty }}"
                     data-program="{{ box.program }}"
                     data-product="{{ box.product_name }}"
                     data-customer="{{ box.customer_name }}">
            </td>
            <td>{{ box.program }}</td>
            <td>{{ box.product_name }}</td>
            <td class="text-end">{{ box.display_qty }}</td>
            <td>{{ box.order_lot }}</td>
            <td>{{ box.in_lot }}</td>
            <td>{{ box.work_lot }}</td>
            <td>{{ box.inspect_lot }}</td>
            <td>{{ box.inspector }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="9" class="text-center text-muted">
              ì¡°íšŒ ë²„íŠ¼ìœ¼ë¡œ LOTë¥¼ ì¡°íšŒí•œ í›„ ì„ íƒí•©ë‹ˆë‹¤.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- ğŸ”¹ ë²„íŠ¼ ì˜ì—­ (ì•„ì§ ë™ì‘ì€ ë¯¸êµ¬í˜„) -->
  <div class="d-flex justify-content-between">
    <button type="button" class="btn btn-outline-info btn-sm" disabled>
      ìˆ˜ì£¼ë§¤ì¹­(ë³´ë¥˜)
    </button>

    <div>
      <a href="{% url 'sales:shipment_list' %}" class="btn btn-secondary btn-sm">
        ëª©ë¡
      </a>
      <button type="button" id="btn-open-shipment-modal" class="btn btn-primary btn-sm">
        ì €ì¥
      </button>
    </div>
  </div>
</div>

<!-- ğŸ”¹ ì¶œí•˜ í—¤ë” ì •ë³´ ì…ë ¥ ëª¨ë‹¬ -->
<div class="modal fade" id="shipmentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h5 class="modal-title">ì¶œí•˜ ì •ë³´ ì…ë ¥</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">

        <!-- 1í–‰: ì¶œí•˜ LOT / ì¶œí•˜ì¼ / ì¶œê³ ì -->
        <div class="row g-2 mb-2">
          <div class="col-4">
            <label class="form-label form-label-sm">ì¶œí•˜ LOT</label>
            <input type="text"
                   id="sh-lot-display"
                   class="form-control form-control-sm"
                   readonly>
          </div>
          <div class="col-4">
            <label class="form-label form-label-sm">ì¶œí•˜ì¼</label>
            <input type="date"
                   id="ship-date-input"
                   class="form-control form-control-sm">
          </div>
          <div class="col-4">
            <label class="form-label form-label-sm">ì¶œê³ ì</label>
            <input type="text"
                   id="operator-input"
                   class="form-control form-control-sm">
          </div>
        </div>

        <!-- 2í–‰: í”„ë¡œê·¸ë¨ / í’ˆëª… / ì´ ìˆ˜ëŸ‰ / ê³ ê°ì‚¬ -->
        <div class="row g-2 mb-2">
          <div class="col-3">
            <label class="form-label form-label-sm">í”„ë¡œê·¸ë¨</label>
            <input type="text"
                   id="program-display"
                   class="form-control form-control-sm"
                   readonly>
          </div>
          <div class="col-3">
            <label class="form-label form-label-sm">í’ˆëª…</label>
            <input type="text"
                   id="product-display"
                   class="form-control form-control-sm"
                   readonly>
          </div>
          <div class="col-3">
            <label class="form-label form-label-sm">ì´ ìˆ˜ëŸ‰</label>
            <input type="text"
                   id="total-qty-display"
                   class="form-control form-control-sm"
                   readonly>
          </div>
          <div class="col-3">
            <label class="form-label form-label-sm">ê³ ê°ì‚¬</label>
            <input type="text"
                   id="customer-display"
                   class="form-control form-control-sm"
                   readonly>
          </div>
        </div>

        <!-- ë¹„ê³  -->
        <div class="mb-2">
          <label class="form-label form-label-sm">ë¹„ê³ </label>
          <textarea id="memo-input"
                    rows="3"
                    class="form-control form-control-sm"></textarea>
        </div>
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
          ì·¨ì†Œ
        </button>
        <button type="button" id="btn-save-shipment" class="btn btn-primary btn-sm">
          ì €ì¥
        </button>
      </div>
    </div>
  </div>
</div>


<script>
// CSRF í† í° ê°€ì ¸ì˜¤ê¸°
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

document.addEventListener('DOMContentLoaded', function () {
  const openBtn = document.getElementById('btn-open-shipment-modal');
  const saveBtn = document.getElementById('btn-save-shipment');
  const modalEl = document.getElementById('shipmentModal');

  // í•„ìˆ˜ ìš”ì†Œê°€ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ì¢…ë£Œ
  if (!openBtn || !saveBtn || !modalEl) {
    console.warn('shipment modal elements not found');
    return;
  }

  const DEFAULT_OPERATOR = "{{ current_user_name|default_if_none:'' }}";
  const saveUrl = "{% url 'sales:shipment_save' %}";
  const detailUrlTemplate = "{% url 'sales:shipment_detail' 0 %}";

  const programInput   = document.getElementById('program-display');
  const productInput   = document.getElementById('product-display');
  const customerInput  = document.getElementById('customer-display');
  const totalQtyInput  = document.getElementById('total-qty-display');
  const shipDateInput  = document.getElementById('ship-date-input');
  const operatorInput  = document.getElementById('operator-input');
  const memoInput      = document.getElementById('memo-input');
  const shLotInput     = document.getElementById('sh-lot-display');

  // ğŸ”¹ ì €ì¥ ë²„íŠ¼ í´ë¦­ â†’ ì²´í¬ë°•ìŠ¤ í™•ì¸ í›„ ëª¨ë‹¬ ì˜¤í”ˆ
  openBtn.addEventListener('click', function () {
    const checked = document.querySelectorAll("input[name='box_ids']:checked");
    if (checked.length === 0) {
      alert('ì¶œí•˜í•  LOTë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
      return;
    }

    // ì²« ë²ˆì§¸ ì„ íƒí–‰ ê¸°ì¤€ìœ¼ë¡œ í”„ë¡œê·¸ë¨/í’ˆëª…/ê³ ê°ì‚¬ ê°€ì ¸ì˜¤ê¸°
    const first = checked[0];
    const program  = first.getAttribute('data-program')  || '';
    const product  = first.getAttribute('data-product')  || '';
    const customer = first.getAttribute('data-customer') || '';

    // ì´ ìˆ˜ëŸ‰ í•©ê³„
    let totalQty = 0;
    checked.forEach(chk => {
      const qty = parseInt(chk.getAttribute('data-qty') || '0', 10);
      if (!isNaN(qty)) totalQty += qty;
    });

    // í•„ë“œ ì„¸íŒ…
    if (programInput)  programInput.value  = program;
    if (productInput)  productInput.value  = product;
    if (customerInput) customerInput.value = customer;
    if (totalQtyInput) totalQtyInput.value = totalQty.toString();

    // ì¶œí•˜ì¼ = ì˜¤ëŠ˜
    const today = new Date().toISOString().slice(0, 10);
    if (shipDateInput) shipDateInput.value = today;

    // ì¶œê³ ì ê¸°ë³¸ê°’ = ë¡œê·¸ì¸ ì‚¬ìš©ì ì´ë¦„
    if (operatorInput && !operatorInput.value) {
      operatorInput.value = DEFAULT_OPERATOR;
    }

    // LOT í‘œì‹œ(ì„œë²„ì—ì„œ ìƒì„±í•˜ë¯€ë¡œ ì•ˆë‚´ í…ìŠ¤íŠ¸)
    if (shLotInput) shLotInput.value = 'ì €ì¥ ì‹œ ìë™ ìƒì„±';

    const modal = new bootstrap.Modal(modalEl);
    modal.show();
  });

  // ğŸ”¹ ëª¨ë‹¬ ë‚´ë¶€ ì €ì¥ ë²„íŠ¼ â†’ AJAX ë¡œ shipment_save í˜¸ì¶œ
  saveBtn.addEventListener('click', function () {
    const checked = document.querySelectorAll("input[name='box_ids']:checked");
    if (checked.length === 0) {
      alert('ì¶œí•˜í•  LOTë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
      return;
    }

    const boxIds  = Array.from(checked).map(chk => chk.value);
    const shipDate = shipDateInput ? shipDateInput.value : '';
    const memo     = memoInput ? memoInput.value : '';
    const operator = operatorInput ? operatorInput.value : '';

    fetch(saveUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie('csrftoken'),
      },
      body: JSON.stringify({
        box_ids: boxIds,
        ship_date: shipDate,
        memo: memo,
        operator: operator,
      }),
    })
    .then(res => res.json())
    .then(data => {
      if (!data.success) {
        alert(data.message || 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        return;
      }

      if (shLotInput) {
        shLotInput.value = data.sh_lot || '';
      }

      alert('ì¶œí•˜ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.\nì¶œí•˜ LOT: ' + (data.sh_lot || ''));

      // ìƒì„¸ í™”ë©´ìœ¼ë¡œ ì´ë™
      const detailUrl = detailUrlTemplate.replace('/0/', '/' + data.shipment_id + '/');
      window.location.href = detailUrl;
    })
    .catch(err => {
      console.error(err);
      alert('ì €ì¥ ì¤‘ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
  });
});
</script>

{% endblock %}
