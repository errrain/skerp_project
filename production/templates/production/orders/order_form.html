{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}
{% load humanize %}

{% block content %}

<style>
  .erp-box{border:1px solid #000; padding:12px; border-radius:2px; background:#fff; margin-bottom:12px;}
  .erp-title{font-size:20px; font-weight:700; margin:8px 0 12px;}
  .erp-table{width:100%; border-collapse:collapse; font-size:11.4px; table-layout:fixed; line-height:1.2;}
  .erp-table th,.erp-table td{border:1px solid #000; padding:4px 5px;}
  .erp-table thead th{background:#f1f1f1; font-weight:700; text-align:center;}
  .text-right{text-align:right;} .text-center{text-align:center;}
  .btn-erp{border:1px solid #000; background:#efefef; padding:4px 10px; cursor:pointer; font-size:12px;}
  .btn-erp-danger{background:#ffedf0; border-color:#c00; color:#c00;}
  .btn-erp-primary{background:#4CAF50; border-color:#3c9b43; color:#fff;}
  .btn-ghost{background:#fff;}
  .warn{border-color:#dc3545 !important;}
  .num input{ text-align:right; }
  .icon-btn{ width:28px; height:26px; line-height:22px; text-align:center; padding:0; border:1px solid #000; background:#fff; cursor:pointer;}
  .arrow{border:0;background:transparent;cursor:pointer;font-weight:700;color:#0d6efd; padding:0 2px;}
  .arrow:focus{outline:none;}
  .val{display:inline-block; min-width:22px;}

  #suju { height:170px; overflow-y:auto; overflow-x:hidden; }
  #search { height:170px; overflow-y:auto; overflow-x:hidden; }

  .inline-form{ display:flex; align-items:center; gap:8px; flex-wrap:nowrap; overflow-x:auto; white-space:nowrap; }
  .inline-form > *{ flex:0 0 auto; }

  .erp-table-wrap{ max-height:260px; height:auto; overflow-y:auto; overflow-x:hidden; padding-bottom:5px; }
  #suju-list thead th, #suju-list tbody td,
  #search-list thead th, #search-list tbody td,
  #line-table thead th, #line-table tbody td{ white-space:nowrap; }

  .row-flash { animation: flash 1.2s ease-out 1; }
  @keyframes flash { 0%{background:#fff9cc;} 100%{background:transparent;} }

  .btn-erp.btn-apply{ padding:0 6px; height:22px; line-height:20px; font-size:11px; display:inline-block; vertical-align:middle; }

  #check-form { display:flex; align-items:center; flex-wrap:nowrap; gap:8px; }
  #check-form label { margin:0 4px 0 0; font-weight:600; font-size:12px; }
  #check-form input, #check-form button { height:26px; padding:2px 6px; font-size:12px; }

  .erp-inline-form { display:flex; align-items:center; flex-wrap:nowrap; gap:8px; }
  .erp-inline-form label { margin:0 4px 0 0; font-weight:600; font-size:12px; }
  .erp-inline-form input, .erp-inline-form button, .erp-inline-form select { height:28px; padding:2px 6px; font-size:12px; }

  .arrow.inc[data-field="prod"] { color:#d00; font-weight:700; }
  .arrow.inc[data-field="prod"]:hover { color:#f33; }
  .arrow.inc { color:#d00; font-weight:700; }
  .arrow.inc:hover { color:#f33; }
</style>

<!--
  ========================= ë¦¬íŒ©í† ë§ í•µì‹¬ =========================
  1) [ì¤‘ìš”] ë¼ì¸ë³„ product_id/customer_id íˆë“  í•„ë“œ ì¶”ê°€
     - views.order_createëŠ” per-line product/customerê°€ ìˆìœ¼ë©´ ê·¸ ê°’ì„ ìš°ì„  ì‚¬ìš©
  2) [ì¤‘ìš”] TOTAL_FORMS ê°’ì€ "ì „ì²´ í¼ ìˆ˜(ì‚­ì œ í¬í•¨)"ë¥¼ ìœ ì§€
     - ì‚­ì œ ì‹œ ê°ì†Œì‹œí‚¤ì§€ ì•ŠìŒ. ì œì¶œ ì§ì „ TOTAL_FORMSë¥¼ S.formsCountë¡œ ê³ ì •
  3) ì œì¶œ ì§ì „ ë¼ì¸ë³„ start_text/end_text ìƒì„±Â·ì£¼ì… (ì—†ìœ¼ë©´ ë§Œë“¤ì–´ì„œ ë„£ìŒ)
  4) 'ë§ˆì§€ë§‰ ê³„íš' ê¸°ì¤€ ì‚¬ìš© ì‹œ, last_end ë¯¸ë¡œë”©ì´ë©´ ì•ˆì „ ì°¨ë‹¨
  5) í–‰ ì´ë™ì€ ì‹œí€€ìŠ¤(seq) ê°’ë§Œ ê°±ì‹ (í¼ ì¸ë±ìŠ¤ëŠ” ë³€ê²½í•˜ì§€ ì•ŠìŒ â†’ Django formset ì•ˆì •)
  ================================================================
-->

<div class="erp-title">{{ work_order|default_if_none:''|yesno:"ì‘ì—…ì§€ì‹œì„œ ìˆ˜ì •,ì‘ì—…ì§€ì‹œì„œ ë“±ë¡" }}</div>

<!-- ===== suju : ìˆ˜ì£¼ëª©ë¡ ===== -->
<div id="suju" class="erp-box">
  <div class="d-flex align-items-end justify-content-between" style="gap:8px; margin-bottom:6px;">
    <div style="font-weight:700;">ìˆ˜ì£¼ëª©ë¡</div>

    <form id="suju-search-form" class="inline-form">
      <div>ìˆ˜ì£¼ì¼ From
        <input type="date" name="order_date_from" class="form-control form-control-sm d-inline-block" style="width:150px;" value="{{ order_date_from }}">
      </div>
      <div>To
        <input type="date" name="order_date_to" class="form-control form-control-sm d-inline-block" style="width:150px;" value="{{ order_date_to }}">
      </div>
      <div>ì¶œê³ ì˜ˆì • From
        <input type="date" name="delivery_date_from" class="form-control form-control-sm d-inline-block" style="width:150px;" value="{{ delivery_date_from }}">
      </div>
      <div>To
        <input type="date" name="delivery_date_to" class="form-control form-control-sm d-inline-block" style="width:150px;" value="{{ delivery_date_to }}">
      </div>
      <div>í’ˆëª…/í’ˆë²ˆ
        <input type="text" name="name" class="form-control form-control-sm d-inline-block" style="width:260px;" placeholder="í’ˆëª… ë˜ëŠ” í’ˆë²ˆ">
      </div>
      <button type="submit" class="btn-erp">ì¡°íšŒ</button>
      <button type="button" class="btn-erp btn-ghost" id="btn-suju-reset">ì´ˆê¸°í™”</button>
      <span id="suju-count" class="small text-muted"></span>
    </form>
  </div>

  <div id="suju-list-wrap" class="erp-table-wrap">
    <table id="suju-list" class="erp-table">
      <thead>
        <tr>
          <th style="width:3%">NO</th>
          <th style="width:7%">í’ˆë²ˆ</th>
          <th>í’ˆëª…</th>
          <th style="width:12%">ê³ ê°ì‚¬</th>
          <th style="width:7%">ìˆ˜ëŸ‰</th>
          <th style="width:11%">ìˆ˜ì£¼ì¼</th>
          <th style="width:11%">ì¶œê³  ì˜ˆì •ì¼</th>
          <th style="width:10%">ì‚¬ì¶œì¬ê³ </th>
        </tr>
      </thead>
      <tbody id="suju-tbody">
        {% for s in sales_list %}
        <tr>
          <td class="text-center">{{ forloop.counter }}</td>
          <td class="text-start">{{ s.product.part_number }}</td>
          <td class="text-start">{{ s.product.name }}</td>
          <td class="text-center">{{ s.order.customer.name }}</td>
          <td class="text-end">{{ s.quantity|intcomma }}</td>
          <td class="text-center">{{ s.order.order_date|date:"Y-m-d" }}</td>
          <td class="text-center">{{ s.delivery_date|date:"Y-m-d" }}</td>
          <td class="text-center">-</td>
        </tr>
        {% empty %}
        <tr><td colspan="8" class="text-center">ìˆ˜ì£¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- ===== search : ì œí’ˆ ê²€ìƒ‰ ===== -->
<div id="search" class="erp-box">
  <div class="d-flex align-items-center justify-content-between mb-2" style="gap:12px;">
    <div style="font-weight:700;">ì œí’ˆê²€ìƒ‰</div>

    <form method="get" id="search-form" class="inline-form mb-0">
      <div>ê³ ê°ì‚¬
        <select name="customer" class="form-select form-select-sm d-inline-block" style="width:200px;">
          <option value="">------</option>
          {% for c in customers %}
            <option value="{{ c.id }}" {% if selected_customer|default:'' == c.id|stringformat:'s' %}selected{% endif %}>{{ c.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div>í’ˆëª…/í’ˆë²ˆ
        <input type="text" name="q" value="{{ query|default:'' }}" class="form-control form-control-sm d-inline-block" style="width:320px;">
      </div>
      <button type="submit" class="btn-erp">ì¡°íšŒ</button>
      <button type="button" class="btn-erp btn-ghost" id="btn-search-reset">ì´ˆê¸°í™”</button>
    </form>

    <div id="dummy-box" class="inline-form">
      <div>ë¹ˆí–‰ê±°
        <button type="button" class="arrow inc" id="dummy-inc">â–²</button>
        <span class="val" id="dummy-hanger">&nbsp;1</span>
        <button type="button" class="arrow dec" id="dummy-dec">â–¼</button>
        <button type="button" class="btn-erp" id="btn-dummy-append">ì¶”ê°€</button>
      </div>
    </div>
  </div>
  <div id="search-list-wrap" class="erp-table-wrap">
    <table id="search-list" class="erp-table">
      <thead>
        <tr>
          <th style="width:10%">ì œì¡°ì‚¬ì–‘</th>
          <th style="width:10%">ì†Œì¬</th>
          <th>í’ˆëª…</th>
          <th style="width:12%">íˆ¬ì…í–‰ê±°ìˆ˜</th>
          <th style="width:12%">í–‰ê±°ë‹¹ ë ‰ìˆ˜ëŸ‰</th>
          <th style="width:12%">ë ‰ë‹¹ ì œí’ˆìˆ˜</th>
          <th style="width:10%">ìƒì‚°ëŸ‰</th>
          <th style="width:10%">ì¶”ê°€</th>
        </tr>
      </thead>
      <tbody>
        {% for p in search_results %}
        <tr class="sr-row"
            data-product="{{ p.id }}"
            data-product-name="{{ p.name|escape }}"
            data-customer="{{ p.customer_id }}"
            data-customer-name="{{ p.customer.name|escapejs }}"
            data-spec="{{ p.spec|escapejs }}"
            data-material="{{ p.material|escapejs }}"
            data-cap-rack="{{ p.product_per_rack|default:0 }}"
            data-cap-hanger="{{ p.rack_per_hanger|default:1 }}"
            data-hanger="{{ p.hanger_count|default:1 }}">
          <td class="text-start">{{ p.spec }}</td>
          <td class="text-center">{{ p.material }}</td>
          <td class="text-start">{{ p.name }}</td>
          <td class="text-center">
            <button type="button" class="arrow dec" data-field="hanger">â–¼</button>
            <span class="val hanger-val">{{ p.hanger_count|default:1 }}</span>
            <button type="button" class="arrow inc" data-field="hanger">â–²</button>
          </td>
          <td class="text-center">
            <button type="button" class="arrow dec" data-field="cap-hanger">â–¼</button>
            <span class="val cap-hanger-val">{{ p.rack_per_hanger|default:1 }}</span>
            <button type="button" class="arrow inc" data-field="cap-hanger">â–²</button>
          </td>
          <td class="text-center"><span class="val cap-rack-val">{{ p.product_per_rack|default:0 }}</span></td>
          <td class="text-end">
            <button type="button" class="arrow dec" data-field="prod">â–¼</button>
            <span class="prod-val">0</span>
            <button type="button" class="arrow inc" data-field="prod">â–²</button>
          </td>
          <td class="text-center"><button type="button" class="btn-erp btn-apply">ì¶”ê°€</button></td>
        </tr>
        {% empty %}
        <tr><td colspan="8" class="text-center">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- ===== ì²´í¬ ===== -->
<div id="check" class="erp-box">
  <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
    <div style="font-weight:700;">ì‘ì—… ì§€ì‹œ ì¼ì‹œ</div>

    <div id="base-mode-wrap" style="display:flex; align-items:center; gap:8px;">
      <span style="font-size:12px; color:#666;">ìµœì´ˆí–‰ ê¸°ì¤€</span>
      <label style="margin:0; display:inline-flex; align-items:center; gap:4px;">
        <input type="radio" name="baseMode" value="header" checked> í—¤ë”ì‹œê°„
      </label>
      <label style="margin:0; display:inline-flex; align-items:center; gap:4px;">
        <input type="radio" name="baseMode" value="last"> ë§ˆì§€ë§‰ ê³„íš
      </label>
    </div>
  </div>

  <form id="check-form" class="erp-inline-form" style="display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-top:6px;">
    <label>ì‘ì—…ì¼ì</label>
    <input type="date" id="chk-date" class="form-control form-control-sm" style="width:140px;">
    <label>ì‘ì—…ì‹œì‘ì‹œê°„</label>
    <input type="time" id="chk-start" class="form-control form-control-sm" style="width:120px;" step="60">
    <button type="button" class="btn-erp" id="btn-now">ì§€ê¸ˆìœ¼ë¡œ</button>
    <button type="button" class="btn-erp" data-delta="-1">-1ë¶„</button>
    <button type="button" class="btn-erp" data-delta="-10">-10ë¶„</button>
    <button type="button" class="btn-erp" data-delta="10">+10ë¶„</button>
    <button type="button" class="btn-erp" data-delta="1">+1ë¶„</button>
    <button type="button" class="btn-erp btn-ghost" id="btn-clear-check">ì´ˆê¸°í™”</button>

    <label>í–‰ê±°ê°„ê²©</label>
    <input type="text" id="timestep" class="form-control form-control-sm" style="width:70px;" inputmode="numeric" placeholder="mm:ss" value="4:30">
  </form>

  <div id="last-plan-wrap" class="erp-table-wrap" style="margin-top:8px;">
    <table class="erp-table" id="last-plan-table">
      <thead>
        <tr>
          <th style="width:14%">ì‘ì—… LOT</th>
          <th>í’ˆëª…</th>
          <th style="width:18%">ê³ ê°ì‚¬</th>
          <th style="width:10%">íˆ¬ì…í–‰ê±°ìˆ˜</th>
          <th style="width:10%">ìƒì‚°ëŸ‰</th>
          <th style="width:14%">ê³„íš ì‹œì‘</th>
          <th style="width:14%">ê³„íš ì¢…ë£Œ</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="7" class="text-center">ì½ëŠ” ì¤‘...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ===== task : New Task(í¼ì…‹) + ì €ì¥ ===== -->
<form method="post" id="order-form" novalidate action="{% url 'orders:order_create' %}">
  {% csrf_token %}
  <div class="d-none">
    {{ form.product }} {{ form.customer }} {{ form.order_qty }}
    {{ form.planned_start }} {{ form.planned_end }} {{ form.remark }}
  </div>

  {{ formset.management_form }}
  <div id="task" class="erp-box">
    <div id="line-list-wrap" class="erp-table-wrap">
      <table class="erp-table" id="line-table">
        <thead>
          <tr>
            <th style="width:60px;">seq</th>
            <th style="width:7%">ì œì¡°ì‚¬ì–‘</th>
            <th style="width:7%">ì†Œì¬</th>
            <th style="width:*">í’ˆëª…</th>
            <th style="width:7%">íˆ¬ì…í–‰ê±°ìˆ˜</th>
            <th style="width:7%">ìƒì‚°ëŸ‰</th>
            <th style="width:10%">ì‘ì—…ì‹œì‘ ì˜ˆì •ì¼ì‹œ</th>
            <th style="width:10%">ì‘ì—…ì¢…ë£Œ ì˜ˆì •ì¼ì‹œ</th>
            <th style="width:10%">ë¹„ê³ </th>
            <th style="width:100px;">ì´ë™</th>
            <th style="width:60px;">ì‚­ì œ</th>
          </tr>
        </thead>
        <tbody id="line-tbody">
  {# ìˆ˜ì • í™”ë©´: work_order ê°€ ìˆì„ ë•Œë§Œ ê¸°ì¡´ ë¼ì¸ ë Œë” #}
  {% if work_order %}
    {% for f in formset.forms %}
    <tr>
      <td>{{ f.sequence|add_class:"form-control form-control-sm text-center seq" }}</td>
      <td class="cell-spec"></td>
      <td class="cell-material"></td>
      <td class="cell-name text-start"></td>
      <td class="cell-hanger text-end"></td>
      <td class="cell-prod text-end"></td>
      <td class="cell-start text-center"></td>
      <td class="cell-end text-center"></td>
      <td>{{ f.remark|add_class:"form-control form-control-sm remark" }}</td>
      <td class="text-center">
        <button type="button" class="icon-btn btn-up">â–²</button>
        <button type="button" class="icon-btn btn-down">â–¼</button>
      </td>
      <td class="text-center">
        {% if formset.can_delete %}
          <button type="button" class="btn-erp btn-erp-danger btn-del">ì‚­ì œ</button>
          {{ f.DELETE|add_class:"d-none del-flag" }}
        {% endif %}
      </td>

      {# ìˆ¨ê¹€: ë¼ì¸ë³„ ìˆ˜ëŸ‰/ìš©ëŸ‰ #}
      {{ f.rack_capacity|add_class:"d-none cap-rack" }}
      {{ f.rack_count|add_class:"d-none rack-count" }}
      {{ f.hanger_capacity|add_class:"d-none cap-hanger" }}
      {{ f.hanger_count|add_class:"d-none hanger-count" }}

      {# ë¼ì¸ë³„ ì œí’ˆ/ê³ ê° (ì—†ìœ¼ë©´ ì„œë²„ì—ì„œ í—¤ë”ë¡œ fallback) #}
      <input type="hidden" name="{{ formset.prefix }}-{{ forloop.counter0 }}-product_id"
             class="line-product-id" value="{{ f.instance.product_id|default_if_none:'' }}">
      <input type="hidden" name="{{ formset.prefix }}-{{ forloop.counter0 }}-customer_id"
             class="line-customer-id" value="{{ f.instance.customer_id|default_if_none:'' }}">

      {# ë¼ì¸ë³„ ì‹œê°„ í…ìŠ¤íŠ¸(ì €ì¥ ì§ì „ JSê°€ ì±„ì›€) #}
      <input type="hidden" name="{{ formset.prefix }}-{{ forloop.counter0 }}-start_text"
             class="line-start" value="">
      <input type="hidden" name="{{ formset.prefix }}-{{ forloop.counter0 }}-end_text"
             class="line-end" value="">
    </tr>
    {% empty %}
      <tr><td colspan="11" class="text-center">ë¼ì¸ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ ê²€ìƒ‰ ê²°ê³¼ì—ì„œ [ì¶”ê°€]í•˜ê±°ë‚˜ [+ í–‰ ì¶”ê°€]ë¥¼ ì´ìš©í•˜ì„¸ìš”.</td></tr>
    {% endfor %}

  {# ë“±ë¡ í™”ë©´: ê¸°ë³¸ ë¹ˆ í–‰ ë Œë” ê¸ˆì§€ #}
  {% else %}
    <tr><td colspan="11" class="text-center">ë¼ì¸ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ ê²€ìƒ‰ ê²°ê³¼ì—ì„œ [ì¶”ê°€]í•˜ê±°ë‚˜ [+ í–‰ ì¶”ê°€]ë¥¼ ì´ìš©í•˜ì„¸ìš”.</td></tr>
  {% endif %}
</tbody>
      </table>
    </div>

    <div class="d-flex justify-content-between align-items-center" style="margin-top:8px;">
      <div class="small text-muted">â€» ê·œì¹™: <b>ì§€ì‹œEA = ë ‰ ìˆ˜ Ã— 1ë ‰ë‹¹EA</b>, <b>í–‰ê±° ìˆ˜ Ã— 1í–‰ê±°ë‹¹ ë ‰ìˆ˜</b></div>
      <div class="d-flex" style="gap:6px;">
        <button type="submit" class="btn-erp btn-erp-primary">ğŸ’¾ ì €ì¥</button>
      </div>
    </div>
  </div>
</form>

<script>
/* ============================================================================
   Production Order Form â€“ Final Refactor (ì£¼ìš” ë³´ì™„: per-line product/customer, TOTAL_FORMS, ì‹œê°„ì£¼ì…)
============================================================================ */
(function () {
  'use strict';

  const SEL = {
    tbody: '#line-tbody',
    form: '#order-form',
    formsetTF: (prefix) => `input[name="${prefix}-TOTAL_FORMS"]`,
    seq: '.seq',
    cell: { name: '.cell-name', hanger: '.cell-hanger', prod: '.cell-prod', start: '.cell-start', end: '.cell-end' },
    hidden: {
      start: 'input.line-start', end: 'input.line-end',
      rackCap: '.cap-rack', rackCnt: '.rack-count', hangCap: '.cap-hanger', hangCnt: '.hanger-count',
      del: '.del-flag',
      prodId: '.line-product-id', custId: '.line-customer-id'
    },
    header: { date: '#chk-date', start: '#chk-start', gap: '#timestep' },
    suju: { form: '#suju-search-form', tbody: '#suju-tbody', count: '#suju-count', reset: '#btn-suju-reset' },
    search: { reset: '#btn-search-reset', form: '#search-form', rows: '.sr-row', arrow: '.sr-row .arrow', btnApply: '.sr-row .btn-apply' },
    dummy: { inc: '#dummy-inc', dec: '#dummy-dec', add: '#btn-dummy-append', val: '#dummy-hanger' },
    lineBtn: { up: 'button.btn-up', down: 'button.btn-down', del: 'button.btn-del' },
    lastPlanWrap: '#last-plan-wrap',
    lastPlanTbody: '#last-plan-table tbody',
    baseMode: 'input[name="baseMode"]'
  };

  const S = {
    formPrefix: '{{ formset.prefix }}',
    TBody: null,
    $totalForms: null,
    formsCount: 0,       // ì‚­ì œ í¬í•¨ ì´ í¼ ìˆ˜(ì¸ë±ìŠ¤ upper bound)
    LAST_PLAN_END: null, // Date | null
  };

  const $ = (sel, root) => (root || document).querySelector(sel);
  const $all = (sel, root) => Array.from((root || document).querySelectorAll(sel));
  const toInt = (v, d=0) => { if (v==null) return d; const n=parseInt(String(v).replace(/[^\d\-]/g,''),10); return Number.isFinite(n)?n:d; };
  const pad2 = (n) => String(n).padStart(2,'0');
  const parseMMSS = (v) => { const m=(v||'').trim().match(/^(\d{1,2}):([0-5]\d)$/); return m?(parseInt(m[1],10)*60+parseInt(m[2],10)):null; };
  const parseYYYYMMDDHHMM = (txt) => { const m=(txt||'').trim().match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})$/); return m?new Date(+m[1],+m[2]-1,+m[3],+m[4],+m[5],0,0):null; };
  const fmtDT = (dt) => dt.getFullYear()+'-'+pad2(dt.getMonth()+1)+'-'+pad2(dt.getDate())+' '+pad2(dt.getHours())+':'+pad2(dt.getMinutes());

  const getBaseMode = () => ($(`${SEL.baseMode}:checked`)?.value) || 'header';
  const getHeaderStart = () => {
    const $date = $(SEL.header.date), $start = $(SEL.header.start);
    if (!($date && $date.value && $start && $start.value)) return null;
    const ds=$date.value.split('-'), ts=$start.value.split(':');
    return new Date(+ds[0], +ds[1]-1, +ds[2], +ts[0], +ts[1], 0, 0);
  };
  const getGapSec = () => parseMMSS($(SEL.header.gap)?.value || '');

  const visibleRows = () => {
    if (!S.TBody) return [];
    return $all('tr', S.TBody).filter(tr => tr.style.display !== 'none' && !tr.querySelector('td[colspan]'));
  };
  const allRows = () => $all('tr', S.TBody).filter(tr => !tr.querySelector('td[colspan]'));

  const getFirstRowStart = () => {
    const rows = visibleRows();
    if (!rows.length) return null;
    return parseYYYYMMDDHHMM((rows[0].querySelector(SEL.cell.start)?.textContent || '').trim());
  };
  const setFirstRowStartIfEmpty = (dt) => {
    const rows = visibleRows();
    if (!rows.length || !dt) return;
    const cell = rows[0].querySelector(SEL.cell.start);
    const has = (cell?.textContent || '').trim();
    if (!has && cell) cell.textContent = fmtDT(dt);
  };

  const recalcTimesForAllRows = () => {
    const rows = visibleRows(); if (!rows.length) return;
    const gapSec = getGapSec(); if (gapSec == null) return;

    let base = getFirstRowStart();
    if (!base) {
      if (getBaseMode()==='last' && S.LAST_PLAN_END instanceof Date && !isNaN(S.LAST_PLAN_END)) base = new Date(S.LAST_PLAN_END.getTime());
      else base = getHeaderStart();
      setFirstRowStartIfEmpty(base);
    }
    if (!base) return;

    let running = new Date(base.getTime());
    rows.forEach((tr, idx) => {
      const start = (idx===0) ? new Date(base.getTime()) : new Date(running.getTime());
      let hanger = toInt(tr.querySelector(SEL.hidden.hangCnt)?.value, 0);
      if (!hanger) {
        const cellTxt = tr.querySelector(SEL.cell.hanger)?.textContent || '0';
        hanger = toInt(cellTxt.replace(/[^\d]/g,''), 0);
      }
      const end = new Date(start.getTime() + (hanger * gapSec * 1000));
      const cStart = tr.querySelector(SEL.cell.start);
      const cEnd = tr.querySelector(SEL.cell.end);
      if (cStart) cStart.textContent = fmtDT(start);
      if (cEnd)   cEnd.textContent   = fmtDT(end);
      running = end;
    });
  };

  const computeBaseStartForAppend = () => {
    const rows = visibleRows();
    if (rows.length) {
      const lastEndTxt = (rows[rows.length-1].querySelector(SEL.cell.end)?.textContent || '').trim();
      return parseYYYYMMDDHHMM(lastEndTxt) || getHeaderStart();
    }
    if (getBaseMode()==='last') {
      if (S.LAST_PLAN_END instanceof Date && !isNaN(S.LAST_PLAN_END)) return new Date(S.LAST_PLAN_END.getTime());
      return null;
    }
    return getHeaderStart();
  };

  const ensureLastPlanReadyIfNeeded = () => {
    if (getBaseMode() !== 'last') return true;
    if (S.LAST_PLAN_END instanceof Date && !isNaN(S.LAST_PLAN_END)) return true;
    const domTxt = document.querySelector('#last-plan-table tbody tr td:last-child')?.textContent || '';
    const dt = parseYYYYMMDDHHMM(domTxt);
    if (dt) { S.LAST_PLAN_END = dt; return true; }
    alert('ë§ˆì§€ë§‰ ê³„íš ì‹œê°„ì´ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í—¤ë”ì‹œê°„ì„ ì„ íƒí•˜ê±°ë‚˜ ìµœê·¼ ì‘ì—… ëª©ë¡ì´ í‘œì‹œëœ ë’¤ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
    return false;
  };

  const recalcSearchRow = (tr) => {
    const hanger = toInt(tr.querySelector('.hanger-val')?.textContent, 0);
    const capH   = toInt(tr.querySelector('.cap-hanger-val')?.textContent, 0);
    const capR   = toInt(tr.querySelector('.cap-rack-val')?.textContent, 0);
    const prod   = Math.max(0, hanger * capH * capR);
    const prodSpan = tr.querySelector('.prod-val');
    if (prodSpan) prodSpan.textContent = (prod||0).toLocaleString();
    return {hanger, capH, capR, prod:(prod||0)};
  };

  const bumpProd = (tr, delta) => {
    const capR = toInt(tr.querySelector('.cap-rack-val')?.textContent, 0);
    const capH = toInt(tr.querySelector('.cap-hanger-val')?.textContent, 1);
    const cur  = toInt((tr.querySelector('.prod-val')?.textContent || '').replace(/,/g,''), 0);
    const next = Math.max(0, cur + delta*capR);
    const rackCount = capR>0 ? Math.ceil(next/capR) : 0;
    const hanger    = capH>0 ? Math.ceil(rackCount/capH) : 0;
    const hangerSpan = tr.querySelector('.hanger-val');
    const prodSpan   = tr.querySelector('.prod-val');
    if (hangerSpan) hangerSpan.textContent = hanger;
    if (prodSpan)   prodSpan.textContent   = next.toLocaleString();
  };

  const resequence = () => { visibleRows().forEach((tr, i) => { const seq = tr.querySelector(SEL.seq); if (seq) seq.value = i+1; }); };

  const initHeaderAndClean = () => {
    const $date  = $(SEL.header.date);
    const $start = $(SEL.header.start);
    const $gap   = $(SEL.header.gap);
    const now = new Date();
    if ($date)  $date.value  = now.getFullYear()+'-'+pad2(now.getMonth()+1)+'-'+pad2(now.getDate());
    if ($start) $start.value = pad2(now.getHours())+':'+pad2(now.getMinutes());
    if ($gap && !$gap.value) $gap.value = '4:30';

    // ì´ˆê¸° formsCount ì…‹ì—…(TOTAL_FORMS ê¸°ë°˜)
    S.formsCount = toInt($(SEL.formsetTF(S.formPrefix))?.value, 0);
  };

  const initSujuSearch = () => {
    const form  = $(SEL.suju.form);
    const body  = $(SEL.suju.tbody);
    const count = $(SEL.suju.count);
    if (!form) return;

    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const params = new URLSearchParams(new FormData(form)).toString();
      const url = "{% url 'orders:search_sales_orders' %}?"+params;
      fetch(url, {headers:{'X-Requested-With':'XMLHttpRequest'}})
        .then(res=>{ if(!res.ok) throw new Error('ê²€ìƒ‰ ì‹¤íŒ¨'); return res.json(); })
        .then(data=>{
          const rows = data.results || [];
          if (body) body.innerHTML = '';
          if (count) count.textContent = rows.length+'ê±´';
          if(!rows.length){
            if (body) body.innerHTML = '<tr><td colspan="8" class="text-center">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
          }
          rows.forEach((r,i)=>{
            const tr = document.createElement('tr');
            tr.innerHTML =
              '<td class="text-center">'+(i+1)+'</td>'+
              '<td class="text-start">'+(r.product_code || '')+'</td>'+
              '<td class="text-start">'+(r.product_name || '')+'</td>'+
              '<td class="text-center">'+(r.customer_name || '')+'</td>'+
              '<td class="text-end">'+((r.order_qty||0).toLocaleString())+'</td>'+
              '<td class="text-center">'+(r.order_date || '')+'</td>'+
              '<td class="text-center">'+(r.planned_ship_date || r.delivery_date || '')+'</td>'+
              '<td class="text-center">'+((r.injection_stock!=null)? r.injection_stock : '-')+'</td>';
            if (body) body.appendChild(tr);
          });
        })
        .catch(()=> alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'));
    });
  };

  const initSearchRowCalc = () => {
    $all(SEL.search.rows).forEach(recalcSearchRow);

    document.addEventListener('click', (e)=>{
      const arrow = e.target.closest(SEL.search.arrow);
      if (!arrow) return;
      const tr = arrow.closest('.sr-row'); if(!tr) return;
      const field = arrow.getAttribute('data-field');
      if (field === 'prod'){ bumpProd(tr, arrow.classList.contains('inc') ? +1 : -1); return; }
      const span = (field === 'hanger') ? tr.querySelector('.hanger-val') : tr.querySelector('.cap-hanger-val');
      let v = toInt(span ? span.textContent : '0', 0);
      if (arrow.classList.contains('inc')) v += 1;
      if (arrow.classList.contains('dec')) v = Math.max(0, v-1);
      if (span) span.textContent = v;
      recalcSearchRow(tr);
    });

    $all(SEL.search.btnApply).forEach(btn=>{
      btn.addEventListener('click', ()=>{
        if (!S.TBody) return;
        const row = btn.closest('.sr-row'); if(!row) return;
        if (!ensureLastPlanReadyIfNeeded()) return;

        const vals = recalcSearchRow(row);
        const capR = vals.capR, capH = vals.capH, hanger = vals.hanger, prod = vals.prod;
        if (!capR || !prod){ alert('ìƒì‚°ëŸ‰ 0ì€ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íˆ¬ì…í–‰ê±°/ë ‰ìˆ˜ëŸ‰/ë ‰ë‹¹EAë¥¼ í™•ì¸í•˜ì„¸ìš”.'); return; }

        const gapSec = getGapSec();
        const baseStart = computeBaseStartForAppend();
        if (gapSec == null || !baseStart){ alert('ì‘ì—…ì¼ì/ì‹œì‘ì‹œê°„/í–‰ê±°ê°„ê²© ë˜ëŠ” ë§ˆì§€ë§‰ ê³„íš ì‹œê°„ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }

        // í—¤ë”(ìš”ì•½) ê°’ë„ ì±„ì›Œë‘ë˜, ë¼ì¸ë³„ íˆë“ ì„ ìš°ì„  ì‚¬ìš©
        const prodSel = document.getElementById('id_product');
        const custSel = document.getElementById('id_customer');
        //if (prodSel) prodSel.value = row.getAttribute('data-product');
        //if (custSel) custSel.value = row.getAttribute('data-customer');

        const start = new Date(baseStart.getTime());
        const end   = new Date(start.getTime() + (hanger * gapSec * 1000));
        const startText = fmtDT(start), endText = fmtDT(end);

        const idx = S.formsCount; // ë‹¤ìŒ ì¸ë±ìŠ¤ = í˜„ì¬ ì´ í¼ ìˆ˜
        const prodName = row.getAttribute('data-product-name') || (row.querySelector('td:nth-child(3)')?.textContent || '');
        const rackCount = hanger * capH;

        const html =
          '<tr class="row-flash">'+
            `<td><input type="number" name="${S.formPrefix}-${idx}-sequence" value="${visibleRows().length+1}" class="form-control form-control-sm text-center seq"></td>`+
            `<td class="cell-spec">${row.getAttribute('data-spec')||''}</td>`+
            `<td class="cell-material text-center">${row.getAttribute('data-material')||''}</td>`+
            `<td class="cell-name text-start">${prodName||''}</td>`+
            `<td class="cell-hanger text-end">${hanger.toLocaleString()}</td>`+
            `<td class="cell-prod text-end">${prod.toLocaleString()}</td>`+
            `<td class="cell-start text-center">${startText}</td>`+
            `<td class="cell-end text-center">${endText}</td>`+
            `<td><input type="text" name="${S.formPrefix}-${idx}-remark" class="form-control form-control-sm remark"></td>`+
            '<td class="text-center">'+
              '<button type="button" class="icon-btn btn-up">â–²</button>'+
              '<button type="button" class="icon-btn btn-down">â–¼</button>'+
            '</td>'+
            '<td class="text-center">'+
              '<button type="button" class="btn-erp btn-erp-danger btn-del">ì‚­ì œ</button>'+
              `<input type="checkbox" name="${S.formPrefix}-${idx}-DELETE" class="d-none del-flag">`+
            '</td>'+
            // ìˆ˜ëŸ‰/ìš©ëŸ‰
            `<input type="number" name="${S.formPrefix}-${idx}-rack_capacity"    class="d-none cap-rack"    value="${capR}">`+
            `<input type="number" name="${S.formPrefix}-${idx}-rack_count"       class="d-none rack-count"  value="${rackCount}">`+
            `<input type="number" name="${S.formPrefix}-${idx}-hanger_capacity"  class="d-none cap-hanger"  value="${capH}">`+
            `<input type="number" name="${S.formPrefix}-${idx}-hanger_count"     class="d-none hanger-count" value="${hanger}">`+
            // [ì¤‘ìš”] per-line product/customer
            `<input type="hidden" name="${S.formPrefix}-${idx}-product_id"  class="line-product-id"  value="${row.getAttribute('data-product')||''}">`+
            `<input type="hidden" name="${S.formPrefix}-${idx}-customer_id" class="line-customer-id" value="${row.getAttribute('data-customer')||''}">`+
            // ì‹œê°„ í…ìŠ¤íŠ¸
            `<input type="hidden" name="${S.formPrefix}-${idx}-start_text" class="line-start" value="${startText}">`+
            `<input type="hidden" name="${S.formPrefix}-${idx}-end_text"   class="line-end"   value="${endText}">`+
          '</tr>';

        // ì²« ë¹ˆ ì•ˆë‚´í–‰ ì œê±°
        if (S.TBody.children.length===1 && S.TBody.firstElementChild.querySelector('td[colspan]')) S.TBody.innerHTML = '';
        S.TBody.insertAdjacentHTML('beforeend', html);

        // ì´ í¼ ìˆ˜ ì¦ê°€(TOTAL_FORMSëŠ” ì‚­ì œ í¬í•¨ ì´ ê°œìˆ˜)
        S.formsCount += 1;
        if (S.$totalForms) S.$totalForms.value = String(S.formsCount);

        resequence();
        recalcTimesForAllRows();
        S.TBody.lastElementChild?.scrollIntoView({behavior:'smooth', block:'nearest'});
      });
    });
  };

  const bindMoveDelete = () => {
    if (!S.TBody) return;
    S.TBody.addEventListener('click', (e)=>{
      const btn = e.target.closest(`${SEL.lineBtn.up},${SEL.lineBtn.down},${SEL.lineBtn.del}`);
      if (!btn) return;
      const tr = btn.closest('tr'); if (!tr) return;

      if (btn.matches(SEL.lineBtn.up)) {
        const prev = tr.previousElementSibling;
        if (prev && !prev.querySelector('td[colspan]')) {
          prev.before(tr);
          resequence(); recalcTimesForAllRows();
        }
        return;
      }
      if (btn.matches(SEL.lineBtn.down)) {
        const next = tr.nextElementSibling;
        if (next && !next.querySelector('td[colspan]')) {
          next.after(tr);
          resequence(); recalcTimesForAllRows();
        }
        return;
      }
      if (btn.matches(SEL.lineBtn.del)) {
        const del = tr.querySelector(SEL.hidden.del);
        if (del) del.checked = true;  // í¼ì€ ìœ ì§€, ì‚­ì œ í”Œë˜ê·¸ë§Œ ì„¤ì •
        tr.style.display = 'none';
        // TOTAL_FORMSëŠ” ìœ ì§€(ì‚­ì œ í¬í•¨ ì´ ê°œìˆ˜)
        resequence(); recalcTimesForAllRows();
      }
    });
  };

  const bindHeaderRecalc = () => {
    ['chk-date','chk-start','timestep'].forEach((id)=>{
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('change', recalcTimesForAllRows);
      el.addEventListener('input',  recalcTimesForAllRows);
    });

    const $date  = document.getElementById('chk-date');
    const $start = document.getElementById('chk-start');
    const $gap   = document.getElementById('timestep');

    document.getElementById('btn-now')?.addEventListener('click', ()=>{
      const now = new Date();
      if ($date)  $date.value  = now.getFullYear()+'-'+pad2(now.getMonth()+1)+'-'+pad2(now.getDate());
      if ($start) $start.value = pad2(now.getHours())+':'+pad2(now.getMinutes());
      recalcTimesForAllRows();
    });

    $all('#check-form [data-delta]').forEach((btn)=>{
      btn.addEventListener('click', ()=>{
        const delta = parseInt(btn.getAttribute('data-delta'),10) || 0;
        if (!($date && $start && $date.value && $start.value)) return;
        const base = getHeaderStart(); if (!base) return;
        base.setMinutes(base.getMinutes() + delta);
        $date.value  = base.getFullYear()+'-'+pad2(base.getMonth()+1)+'-'+pad2(base.getDate());
        $start.value = pad2(base.getHours())+':'+pad2(base.getMinutes());
        recalcTimesForAllRows();
      });
    });

    document.getElementById('btn-clear-check')?.addEventListener('click', ()=>{
      const now=new Date();
      if ($date)  $date.value  = now.getFullYear()+'-'+pad2(now.getMonth()+1)+'-'+pad2(now.getDate());
      if ($start) $start.value = pad2(now.getHours())+':'+pad2(now.getMinutes());
      if ($gap && !$gap.value) $gap.value = '4:30';
      recalcTimesForAllRows();
    });

    $all(SEL.baseMode).forEach(r=>{ r.addEventListener('change', ()=> { updateLastPlanPreview(); }); });
  };

  const beforeSubmit = () => {
    const form = $(SEL.form); if(!form) return;
    form.addEventListener('submit', (e)=>{
      const rowsVisible = visibleRows();
      const rowsAll = allRows();

      if (!rowsVisible.length){
        e.preventDefault();
        alert('ë¼ì¸ì´ ì—†ìŠµë‹ˆë‹¤. ê²€ìƒ‰ ê²°ê³¼ì—ì„œ [ì¶”ê°€] í›„ ì €ì¥í•˜ì„¸ìš”.');
        return;
      }

      recalcTimesForAllRows();

      // ê° í¼ì˜ start_text / end_textê°€ ì—†ìœ¼ë©´ ìƒì„±
      rowsAll.forEach((tr)=>{
        const sTxt = (tr.querySelector(SEL.cell.start)?.textContent || '').trim();
        const eTxt = (tr.querySelector(SEL.cell.end)?.textContent   || '').trim();

        let sHid = tr.querySelector(SEL.hidden.start);
        let eHid = tr.querySelector(SEL.hidden.end);
        if (!sHid) { sHid = document.createElement('input'); sHid.type='hidden'; sHid.className='line-start'; tr.appendChild(sHid); }
        if (!eHid) { eHid = document.createElement('input'); eHid.type='hidden'; eHid.className='line-end'; tr.appendChild(eHid); }

        // name ë¶€ì—¬(ì—†ë‹¤ë©´ ì¶”ì • ì¸ë±ìŠ¤ë¡œ) â€” ì´ë¯¸ ìˆëŠ” ê²½ìš° ê·¸ëŒ€ë¡œ ë‘ 
        if (!sHid.name || !eHid.name){
          // tr ë‚´ë¶€ì˜ ì–´ë–¤ input name ì´ë“  í•˜ë‚˜ ê³¨ë¼ prefix-idx-... íŒ¨í„´ì—ì„œ idx ì¶”ì¶œ
          const anyInput = tr.querySelector('[name]');
          if (anyInput){
            const m = anyInput.name.match(/^(.*-\d+)-/); // prefix-idx-
            if (m){ sHid.name = m[1] + '-start_text'; eHid.name = m[1] + '-end_text'; }
          }
        }
        sHid.value = sTxt;
        eHid.value = eTxt;
      });

      // í—¤ë” planned_start/planned_end = ê°€ì‹œí–‰ì˜ ì²« ì‹œì‘/ë§ˆì§€ë§‰ ì¢…ë£Œ
      const firstStart = (rowsVisible[0].querySelector(SEL.cell.start)?.textContent || '').trim();
      const lastEnd    = (rowsVisible[rowsVisible.length-1].querySelector(SEL.cell.end)?.textContent || '').trim();
      const ps = document.getElementById('id_planned_start');
      const pe = document.getElementById('id_planned_end');
      if (ps && firstStart) ps.value = firstStart;
      if (pe && lastEnd)    pe.value = lastEnd;

      // [í•µì‹¬] TOTAL_FORMSëŠ” ì‚­ì œ í¬í•¨ ì´ í¼ ìˆ˜ë¡œ ê³ ì •
      if (S.$totalForms) S.$totalForms.value = String(S.formsCount);
    });
  };

  const initSujuDefaultMonthRange = () => {
    const form = $(SEL.suju.form);
    if (!form) return;
    const from1 = form.querySelector('input[name="order_date_from"]');
    const to1   = form.querySelector('input[name="order_date_to"]');
    const from2 = form.querySelector('input[name="delivery_date_from"]');
    const to2   = form.querySelector('input[name="delivery_date_to"]');

    const now   = new Date();
    const first = new Date(now.getFullYear(), now.getMonth(), 1);
    const last  = new Date(now.getFullYear(), now.getMonth()+1, 0);

    const vFirst = first.getFullYear() + '-' + pad2(first.getMonth()+1) + '-' + pad2(first.getDate());
    const vLast  = last.getFullYear()  + '-' + pad2(last.getMonth()+1)  + '-' + pad2(last.getDate());

    if (from1 && !from1.value) from1.value = vFirst;
    if (to1   && !to1.value)   to1.value   = vLast;
    if (from2 && !from2.value) from2.value = vFirst;
    if (to2   && !to2.value)   to2.value   = vLast;
  };

  const bindResetButtons = () => {
    (function(){
      const $form  = $(SEL.suju.form);
      const $tbody = $(SEL.suju.tbody);
      const $count = $(SEL.suju.count);
      const $reset = $(SEL.suju.reset);
      if ($reset) $reset.addEventListener('click', ()=>{
        if ($form){ $all('input[type="date"], input[type="text"]', $form).forEach(i=>{ i.value=''; }); }
        if ($count) $count.textContent = '';
        if ($tbody) $tbody.innerHTML = '<tr><td colspan="8" class="text-center">ê²€ìƒ‰ ì¡°ê±´ì„ ì…ë ¥í•˜ê³  ì¡°íšŒë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>';
      });
    })();
    (function(){
      const $form  = $(SEL.search.form);
      const $reset = $(SEL.search.reset);
      const $tbody = document.querySelector('#search-list tbody');
      if ($reset) $reset.addEventListener('click', ()=>{
        if ($form){ $all('input[type="text"]', $form).forEach(i=>{ i.value=''; }); $all('select', $form).forEach(s=>{ s.value=''; }); }
        if ($tbody) $tbody.innerHTML = '<tr><td colspan="8" class="text-center">ê²€ìƒ‰ ì¡°ê±´ì„ ì…ë ¥í•˜ê³  ì¡°íšŒë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>';
      });
    })();
  };

  async function fetchLastPlan(){
    try {
      const res = await fetch("{% url 'orders:last_end' %}", {headers:{'X-Requested-With':'XMLHttpRequest'}});
      if (!res.ok) return null;
      return await res.json();
    } catch { return null; }
  }

  async function updateLastPlanPreview(){
    const wrap  = $(SEL.lastPlanWrap);
    const tbody = $(SEL.lastPlanTbody);
    if (!wrap || !tbody) return;

    wrap.style.display = '';
    tbody.innerHTML = '<tr><td colspan="7" class="text-center">ì½ëŠ” ì¤‘...</td></tr>';

    const data = await fetchLastPlan();
    if (!data || !data.last_end){
      S.LAST_PLAN_END = null;
      tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">ìµœê·¼ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
      return;
    }
    const dt = parseYYYYMMDDHHMM(data.last_end);
    S.LAST_PLAN_END = dt;

    tbody.innerHTML =
      `<tr>
        <td class="text-start">${data.lot||''}</td>
        <td class="text-start">${data.product_name||''}</td>
        <td class="text-start">${data.customer_name||''}</td>
        <td class="text-end">${(data.hanger_count||0).toLocaleString()}</td>
        <td class="text-end">${(data.prod_qty||0).toLocaleString()}</td>
        <td class="text-center">${data.last_start||''}</td>
        <td class="text-center">${data.last_end||''}</td>
      </tr>`;
  }

  const initDummyAppend = () => {
    const incBtn = $(SEL.dummy.inc), decBtn = $(SEL.dummy.dec), addBtn = $(SEL.dummy.add), disp = $(SEL.dummy.val);
    if (!(incBtn && decBtn && addBtn && disp)) return;

    const DUMMY_PRODUCT_ID  = window.DUMMY_PRODUCT_ID  || '';
    const DUMMY_CUSTOMER_ID = window.DUMMY_CUSTOMER_ID || '';
    const getCount = () => Math.max(0, toInt(disp.textContent || '1', 1));

    incBtn.addEventListener('click', ()=> { disp.textContent = String(getCount()+1); });
    decBtn.addEventListener('click', ()=> { disp.textContent = String(Math.max(0, getCount()-1)); });

    addBtn.addEventListener('click', ()=>{
      if (!S.TBody) return;
      if (!ensureLastPlanReadyIfNeeded()) return;

      const hanger = getCount();
      if (!hanger){ alert('ë¹ˆí–‰ê±° ìˆ˜ê°€ 0ì…ë‹ˆë‹¤.'); return; }

      const gapSec = getGapSec();
      const baseStart = computeBaseStartForAppend();
      if (gapSec == null || !baseStart){ alert('ì‘ì—…ì¼ì/ì‹œì‘ì‹œê°„/í–‰ê±°ê°„ê²© ë˜ëŠ” ë§ˆì§€ë§‰ ê³„íš ì‹œê°„ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }

      const prodSel = document.getElementById('id_product');
      const custSel = document.getElementById('id_customer');
      if (DUMMY_PRODUCT_ID && prodSel)  prodSel.value = DUMMY_PRODUCT_ID;
      if (DUMMY_CUSTOMER_ID && custSel) custSel.value = DUMMY_CUSTOMER_ID;

      const start = new Date(baseStart.getTime());
      const end   = new Date(start.getTime() + (hanger * gapSec * 1000));
      const startText = fmtDT(start), endText = fmtDT(end);

      const idx = S.formsCount;

      const html =
        '<tr class="row-flash">'+
          `<td><input type="number" name="${S.formPrefix}-${idx}-sequence" value="${visibleRows().length+1}" class="form-control form-control-sm text-center seq"></td>`+
          '<td class="cell-spec"></td>'+
          '<td class="cell-material text-center"></td>'+
          '<td class="cell-name text-start">ë¹ˆí–‰ê±°</td>'+
          `<td class="cell-hanger text-end">${hanger.toLocaleString()}</td>`+
          '<td class="cell-prod text-end">0</td>'+
          `<td class="cell-start text-center">${startText}</td>`+
          `<td class="cell-end text-center">${endText}</td>`+
          `<td><input type="text" name="${S.formPrefix}-${idx}-remark" class="form-control form-control-sm remark" value="ë¹ˆí–‰ê±°"></td>`+
          '<td class="text-center">'+
            '<button type="button" class="icon-btn btn-up">â–²</button>'+
            '<button type="button" class="icon-btn btn-down">â–¼</button>'+
          '</td>'+
          '<td class="text-center">'+
            '<button type="button" class="btn-erp btn-erp-danger btn-del">ì‚­ì œ</button>'+
            `<input type="checkbox" name="${S.formPrefix}-${idx}-DELETE" class="d-none del-flag">`+
          '</td>'+
          // ë¹ˆí–‰ê±°: ìˆ˜ëŸ‰/ìš©ëŸ‰
          `<input type="number" name="${S.formPrefix}-${idx}-rack_capacity"    class="d-none cap-rack"   value="0">`+
          `<input type="number" name="${S.formPrefix}-${idx}-rack_count"       class="d-none rack-count" value="0">`+
          `<input type="number" name="${S.formPrefix}-${idx}-hanger_capacity"  class="d-none cap-hanger" value="1">`+
          `<input type="number" name="${S.formPrefix}-${idx}-hanger_count"     class="d-none hanger-count" value="${hanger}">`+
          // [ì¤‘ìš”] per-line product/customer
          `<input type="hidden" name="${S.formPrefix}-${idx}-product_id"  class="line-product-id"  value="${DUMMY_PRODUCT_ID}">`+
          `<input type="hidden" name="${S.formPrefix}-${idx}-customer_id" class="line-customer-id" value="${DUMMY_CUSTOMER_ID}">`+
          // ì‹œê°„ í…ìŠ¤íŠ¸
          `<input type="hidden" name="${S.formPrefix}-${idx}-start_text" class="line-start" value="${startText}">`+
          `<input type="hidden" name="${S.formPrefix}-${idx}-end_text"   class="line-end"   value="${endText}">`+
        '</tr>';

      if (S.TBody.children.length===1 && S.TBody.firstElementChild.querySelector('td[colspan]')) S.TBody.innerHTML = '';
      S.TBody.insertAdjacentHTML('beforeend', html);

      S.formsCount += 1;
      if (S.$totalForms) S.$totalForms.value = String(S.formsCount);

      resequence();
      recalcTimesForAllRows();
      S.TBody.lastElementChild?.scrollIntoView({behavior:'smooth', block:'nearest'});
    });
  };

  document.addEventListener('DOMContentLoaded', function(){
    S.TBody       = $(SEL.tbody);
    S.$totalForms = $(SEL.formsetTF(S.formPrefix));

    initHeaderAndClean();
    initSujuSearch();
    initSearchRowCalc();
    bindMoveDelete();
    bindHeaderRecalc();
    beforeSubmit();
    initSujuDefaultMonthRange();
    bindResetButtons();
    initDummyAppend();
    updateLastPlanPreview();
  });

  window.recalcTimesForAllRows = recalcTimesForAllRows;
  window.getHeaderStart = getHeaderStart;
  window.updateLastPlanPreview = updateLastPlanPreview;

})();
</script>

{% endblock %}
