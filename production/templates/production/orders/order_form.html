{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}
{% load humanize %}

{% block content %}

<style>
  .erp-box{border:1px solid #000; padding:12px; border-radius:2px; background:#fff; margin-bottom:12px;}
  .erp-title{font-size:20px; font-weight:700; margin:8px 0 12px;}
  .erp-table{width:100%; border-collapse:collapse; font-size:11.4px; table-layout:fixed; line-height:1.2;}
  .erp-table th,.erp-table td{border:1px solid #000; padding:4px 5px;}
  .erp-table thead th{background:#f1f1f1; font-weight:700; text-align:center;}
  .text-right{text-align:right;} .text-center{text-align:center;}
  .btn-erp{border:1px solid #000; background:#efefef; padding:4px 10px; cursor:pointer; font-size:12px;}
  .btn-erp-danger{background:#ffedf0; border-color:#c00; color:#c00;}
  .btn-erp-primary{background:#4CAF50; border-color:#3c9b43; color:#fff;}
  .btn-ghost{background:#fff;}
  .ux-badge{font-size:12px; border:1px solid #000; padding:4px 8px; border-radius:3px; background:#f8f9fa; margin-right:6px;}
  .ux-badge.ok{background:#e8f5e9; border-color:#28a745;}
  .ux-badge.bad{background:#fff5f5; border-color:#dc3545; color:#c00;}
  .warn{border-color:#dc3545 !important;}
  .num input{ text-align:right; }
  .icon-btn{ width:28px; height:26px; line-height:22px; text-align:center; padding:0; border:1px solid #000; background:#fff; cursor:pointer;}
  .arrow{border:0;background:transparent;cursor:pointer;font-weight:700;color:#0d6efd; padding:0 2px;}
  .arrow:focus{outline:none;}
  .val{display:inline-block; min-width:22px;}
</style>

<div class="erp-title">{{ work_order|default_if_none:''|yesno:"ì‘ì—…ì§€ì‹œì„œ ìˆ˜ì •,ì‘ì—…ì§€ì‹œì„œ ë“±ë¡" }}</div>

<!-- ===== suju : ìˆ˜ì£¼ëª©ë¡ ===== -->
<div id="suju" class="erp-box">
  <div style="font-weight:700; margin-bottom:6px;">ìˆ˜ì£¼ëª©ë¡</div>
  <table class="erp-table">
    <thead>
      <tr>
        <th style="width:3%">NO</th>
        <th style="width:7%">í’ˆë²ˆ</th>
        <th>í’ˆëª…</th>
        <th style="width:12%">ê³ ê°ì‚¬</th>
        <th style="width:7%">ìˆ˜ëŸ‰</th>
        <th style="width:11%">ìˆ˜ì£¼ì¼</th>
        <th style="width:11%">ì¶œê³  ì˜ˆì •ì¼</th>
        <th style="width:10%">ì‚¬ì¶œì¬ê³ </th>
      </tr>
    </thead>
    <tbody>
      {% for s in sales_list %}
      <tr>
        <td class="text-center">{{ forloop.counter }}</td>
        <td class="text-start">{{ s.product.part_number }}</td>
        <td class="text-start">{{ s.product.name }}</td>
        <td class="text-center">{{ s.order.customer.name }}</td>
        <td class="text-end">{{ s.quantity|intcomma }}</td>
        <td class="text-center">{{ s.order.order_date|date:"Y-m-d" }}</td>
        <td class="text-center">{{ s.delivery_date|date:"Y-m-d" }}</td>
        <td class="text-center">-</td>
      </tr>
      {% empty %}
      <tr><td colspan="8" class="text-center">ìˆ˜ì£¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ===== search : ê²€ìƒ‰ + ê²°ê³¼(â–²â–¼ ì¡°ì ˆ/ìƒì‚°ëŸ‰ ìë™ê³„ì‚°) ===== -->
<div id="search" class="erp-box">
  <div style="font-weight:700; margin-bottom:6px;">ê²€ìƒ‰</div>

  <form method="get" class="d-flex align-items-center" style="gap:8px; margin-bottom:8px;">
    <div>ê³ ê°ì‚¬
      <select name="customer" class="form-select form-select-sm d-inline-block" style="width:200px;">
        <option value="">------</option>
        {% for c in customers %}
          <option value="{{ c.id }}" {% if selected_customer|default:'' == c.id|stringformat:'s' %}selected{% endif %}>{{ c.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div>í’ˆëª…/í’ˆë²ˆ
      <input type="text" name="q" value="{{ query|default:'' }}" class="form-control form-control-sm d-inline-block" style="width:320px;">
    </div>
    <button class="btn-erp">ì¡°íšŒ</button>
  </form>

  <table class="erp-table">
    <thead>
      <tr>
        <th style="width:10%">ì œì¡°ì‚¬ì–‘</th>
        <th style="width:10%">ì†Œì¬</th>
        <th>í’ˆëª…</th>
        <th style="width:12%">íˆ¬ì…í–‰ê±°ìˆ˜</th>
        <th style="width:12%">í–‰ê±°ë‹¹ ë ‰ìˆ˜ëŸ‰</th>
        <th style="width:12%">ë ‰ë‹¹ ì œí’ˆìˆ˜</th>
        <th style="width:10%">ìƒì‚°ëŸ‰</th>
        <th style="width:10%">ì¶”ê°€</th>
      </tr>
    </thead>
    <tbody>
      {% for p in search_results %}
      <tr class="sr-row"
          data-product="{{ p.id }}"
          data-product-name="{{ p.name|escapejs }}"
          data-customer="{{ p.customer_id }}"
          data-customer-name="{{ p.customer.name|escapejs }}"
          data-cap-rack="{{ p.product_per_rack|default:0 }}"
          data-cap-hanger="{{ p.rack_per_hanger|default:1 }}"
          data-hanger="{{ p.hanger_count|default:1 }}">

        <td class="text-start">{{ p.spec }}</td>
        <td class="text-center">{{ p.material }}</td>

        <td class="text-start">
          {{ p.name }}
          <!--
          <div class="text-muted small">Part No: {{ p.part_number }}</div>
          <div class="text-muted small">ê³ ê°ì‚¬: {{ p.customer.name }}</div>
          -->
        </td>

        <!-- íˆ¬ì…í–‰ê±°ìˆ˜ -->
        <td class="text-center">
          <button type="button" class="arrow dec" data-field="hanger">â–¼</button>
          <span class="val hanger-val">{{ p.hanger_count|default:1 }}</span>
          <button type="button" class="arrow inc" data-field="hanger">â–²</button>
        </td>

        <!-- í–‰ê±°ë‹¹ ë ‰ìˆ˜ëŸ‰ -->
        <td class="text-center">
          <button type="button" class="arrow dec" data-field="cap-hanger">â–¼</button>
          <span class="val cap-hanger-val">{{ p.rack_per_hanger|default:1 }}</span>
          <button type="button" class="arrow inc" data-field="cap-hanger">â–²</button>
        </td>

        <!-- ë ‰ë‹¹ ì œí’ˆìˆ˜ (ì½ê¸° ì „ìš©) -->
        <td class="text-center"><span class="val cap-rack-val">{{ p.product_per_rack|default:0 }}</span></td>

        <!-- ìƒì‚°ëŸ‰ â–²â–¼ (capR ë‹¨ìœ„ step) -->
        <td class="text-end">
          <button type="button" class="arrow dec" data-field="prod">â–¼</button>
          <span class="prod-val">0</span>
          <button type="button" class="arrow inc" data-field="prod">â–²</button>
        </td>

        <td class="text-center">
          <button type="button" class="btn-erp btn-apply">ì¶”ê°€</button>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="8" class="text-center">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ===== check : ì¤‘ê°„ ì •ë³´ í‘œì‹œ(ë™ì¼ ìŠ¤íƒ€ì¼) ===== -->
<div id="check" class="erp-box">
  <div style="font-weight:700; margin-bottom:6px;">ì²´í¬</div>
  <div>ì¼ê°„ Last Task. StartTime.</div>
</div>

<!-- ===== task : New Task(í¼ì…‹) + ì €ì¥ ===== -->
<form method="post" id="order-form" novalidate>
  {% csrf_token %}

  <!-- (1) í—¤ë” ì…ë ¥ í…Œì´ë¸” UI ì‚­ì œ â†’ íˆë“  í•„ë“œë§Œ ìœ ì§€ -->
  <div class="d-none">
    {{ form.product }}
    {{ form.customer }}
    {{ form.order_qty }}
    {{ form.planned_start }}
    {{ form.planned_end }}
    {{ form.remark }}
  </div>

  <!-- (2) New Task -->
  {{ formset.management_form }}
  <div id="task" class="erp-box">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div>
        <span class="ux-badge">Last Task: <b>{{ last_task|default:"-" }}</b></span>
        <span class="ux-badge">ì§€ì‹œìˆ˜ëŸ‰: <b id="badge-order">0</b> EA</span>
        <span class="ux-badge" id="badge-sum">ë ‰Ã—EA í•©ê³„: <b id="badge-sum-val">0</b> EA</span>
        <span class="ux-badge" id="badge-match">ì¼ì¹˜ ì—¬ë¶€: <b id="badge-match-val">-</b></span>
      </div>
      <a href="{% url 'production:orders:order_list' %}" class="btn-erp btn-ghost">â† ëª©ë¡ìœ¼ë¡œ</a>
    </div>

    <table class="erp-table" id="line-table">
      <thead>
        <tr>
          <th style="width:60px;">seq</th>
          <th style="width:120px;">1ë ‰ë‹¹ EA</th>
          <th style="width:120px;">ë ‰ ìˆ˜</th>
          <th style="width:140px;">1í–‰ê±°ë‹¹ ë ‰ ìˆ˜</th>
          <th style="width:120px;">í–‰ê±° ìˆ˜</th>
          <th>ë¹„ê³ </th>
          <th style="width:128px;">ì´ë™/ë³µì œ</th>
          <th style="width:60px;">ì‚­ì œ</th>
        </tr>
      </thead>
      <tbody id="line-tbody">
        {% for f in formset.forms %}
        <tr>
          <td>{{ f.sequence|add_class:"form-control form-control-sm text-center seq" }}</td>
          <td class="num">{{ f.rack_capacity|add_class:"form-control form-control-sm cap-rack" }}</td>
          <td class="num">{{ f.rack_count|add_class:"form-control form-control-sm rack-count" }}</td>
          <td class="num">{{ f.hanger_capacity|add_class:"form-control form-control-sm cap-hanger" }}</td>
          <td class="num">{{ f.hanger_count|add_class:"form-control form-control-sm hanger-count" }}</td>
          <td>{{ f.remark|add_class:"form-control form-control-sm" }}</td>
          <td class="text-center">
            <button type="button" class="icon-btn btn-up">â–²</button>
            <button type="button" class="icon-btn btn-down">â–¼</button>
            <button type="button" class="icon-btn btn-dup">ï¼‹</button>
          </td>
          <td class="text-center">
            {% if formset.can_delete %}
              <button type="button" class="btn-erp btn-erp-danger btn-del">ì‚­ì œ</button>
              {{ f.DELETE|add_class:"d-none del-flag" }}
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="8" class="text-center">ë¼ì¸ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ ê²€ìƒ‰ ê²°ê³¼ì—ì„œ [ì¶”ê°€]í•˜ê±°ë‚˜ [+ í–‰ ì¶”ê°€]ë¥¼ ì´ìš©í•˜ì„¸ìš”.</td></tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="d-flex justify-content-between align-items-center" style="margin-top:8px;">
      <div class="small text-muted">
        â€» ê·œì¹™: <b>ì§€ì‹œEA = ë ‰ ìˆ˜ Ã— 1ë ‰ë‹¹EA</b>, <b>í–‰ê±° ìˆ˜ Ã— 1í–‰ê±°ë‹¹ ë ‰ â‰¥ ë ‰ ìˆ˜</b>
      </div>
      <div class="d-flex" style="gap:6px;">
        <button type="button" id="btn-add-row" class="btn-erp">+ í–‰ ì¶”ê°€</button>
        <button type="button" id="btn-clear-rows" class="btn-erp btn-erp-danger">ì „ì²´ ì‚­ì œ</button>
        <button type="submit" class="btn-erp btn-erp-primary">ğŸ’¾ ì €ì¥</button>
      </div>
    </div>
  </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const tbody = document.getElementById('line-tbody');
  const addBtn = document.getElementById('btn-add-row');
  const clearBtn = document.getElementById('btn-clear-rows');
  const totalForms = document.getElementById('{{ formset.prefix }}-TOTAL_FORMS');
  const formPrefix = '{{ formset.prefix }}';
  const orderQtyInput = document.getElementById('id_order_qty'); // íˆë“ ì´ì§€ë§Œ id ì¡´ì¬

  /* ============== ë°°ì§€ ============== */
  function refreshBadges(){
    const orderQty = parseInt(orderQtyInput?.value || '0', 10);
    let sum = 0, ok = true;

    [...tbody.querySelectorAll('tr')].forEach(tr=>{
      const rc = tr.querySelector('.rack-count');
      const capRack = tr.querySelector('.cap-rack');
      const hc = tr.querySelector('.hanger-count');
      const capHang = tr.querySelector('.cap-hanger');
      if(!rc || !capRack || !hc || !capHang) return;

      const rackCount = parseInt(rc.value || '0', 10);
      const rackCap   = parseInt(capRack.value || '0', 10);
      const hangCount = parseInt(hc.value || '0', 10);
      const hangCap   = parseInt(capHang.value || '0', 10);

      sum += rackCount * rackCap;
      rc.classList.remove('warn'); hc.classList.remove('warn');
      if (hangCap > 0 && hangCount * hangCap < rackCount) {
        rc.classList.add('warn'); hc.classList.add('warn'); ok = false;
      }
    });

    document.getElementById('badge-order').textContent = (orderQty||0).toLocaleString();
    document.getElementById('badge-sum-val').textContent = sum.toLocaleString();

    const badge = document.getElementById('badge-match');
    const badgeVal = document.getElementById('badge-match-val');
    if(orderQty === sum && ok){ badge.classList.add('ok'); badge.classList.remove('bad'); badgeVal.textContent='ì¼ì¹˜'; }
    else { badge.classList.add('bad'); badge.classList.remove('ok'); badgeVal.textContent='ë¶ˆì¼ì¹˜'; }
  }

  function resequence(){
    [...tbody.querySelectorAll('tr')].forEach((tr,i)=>{
      const seq = tr.querySelector('.seq'); if(seq) seq.value = i+1;
    });
  }

  function addRowWith(capRack, capHang, rackCount=0, hangCount=0, remark=""){
    const idx = parseInt(totalForms.value,10);
    const html = `
      <tr>
        <td><input type="number" name="${formPrefix}-${idx}-sequence" value="${idx+1}" class="form-control form-control-sm text-center seq"></td>
        <td class="num"><input type="number" name="${formPrefix}-${idx}-rack_capacity" value="${capRack||0}" class="form-control form-control-sm cap-rack"></td>
        <td class="num"><input type="number" name="${formPrefix}-${idx}-rack_count" value="${rackCount||0}" class="form-control form-control-sm rack-count"></td>
        <td class="num"><input type="number" name="${formPrefix}-${idx}-hanger_capacity" value="${capHang||0}" class="form-control form-control-sm cap-hanger"></td>
        <td class="num"><input type="number" name="${formPrefix}-${idx}-hanger_count" value="${hangCount||0}" class="form-control form-control-sm hanger-count"></td>
        <td><input type="text" name="${formPrefix}-${idx}-remark" value="${remark||""}" class="form-control form-control-sm"></td>
        <td class="text-center">
          <button type="button" class="icon-btn btn-up">â–²</button>
          <button type="button" class="icon-btn btn-down">â–¼</button>
          <button type="button" class="icon-btn btn-dup">ï¼‹</button>
        </td>
        <td class="text-center">
          <button type="button" class="btn-erp btn-erp-danger btn-del">ì‚­ì œ</button>
          <input type="checkbox" name="${formPrefix}-${idx}-DELETE" class="d-none del-flag">
        </td>
      </tr>`;
    tbody.insertAdjacentHTML('beforeend', html);
    totalForms.value = idx + 1;
    refreshBadges();
  }

  addBtn.addEventListener('click', ()=> addRowWith(0,0,0,0,""));
  clearBtn.addEventListener('click', ()=>{
    tbody.innerHTML = `<tr><td colspan="8" class="text-center">ë¼ì¸ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ ê²€ìƒ‰ ê²°ê³¼ì—ì„œ [ì¶”ê°€]í•˜ê±°ë‚˜ [+ í–‰ ì¶”ê°€]ë¥¼ ì´ìš©í•˜ì„¸ìš”.</td></tr>`;
    totalForms.value = 0; refreshBadges();
  });

  tbody.addEventListener('click', (e)=>{
    const tr = e.target.closest('tr'); if(!tr) return;
    if(e.target.classList.contains('btn-up') && tr.previousElementSibling){
      tr.parentNode.insertBefore(tr, tr.previousElementSibling); resequence();
    }
    if(e.target.classList.contains('btn-down') && tr.nextElementSibling){
      tr.parentNode.insertBefore(tr.nextElementSibling, tr); resequence();
    }
    if(e.target.classList.contains('btn-dup')){
      const capRack = tr.querySelector('.cap-rack')?.value||0;
      const capHang = tr.querySelector('.cap-hanger')?.value||0;
      const rc = tr.querySelector('.rack-count')?.value||0;
      const hc = tr.querySelector('.hanger-count')?.value||0;
      const rm = tr.querySelector('input[name$="-remark"]')?.value||"";
      addRowWith(capRack, capHang, rc, hc, rm); resequence();
    }
    if(e.target.classList.contains('btn-del')){
      const del = tr.querySelector('.del-flag');
      if(del){ del.checked = true; tr.style.display='none'; }
      refreshBadges();
    }
  });

  tbody.addEventListener('input', (e)=>{
    if(e.target.matches('.rack-count,.cap-rack,.hanger-count,.cap-hanger')) refreshBadges();
  });
  orderQtyInput?.addEventListener('input', refreshBadges);

  /* ====== ê²€ìƒ‰ê²°ê³¼: ìƒì‚°ëŸ‰/í–‰ê±°/í–‰ê±°ë‹¹ë ‰ ì¡°ì ˆ ====== */
  function recalcRow(tr){
    const hanger = parseInt(tr.querySelector('.hanger-val').textContent || '0', 10);
    const capH   = parseInt(tr.querySelector('.cap-hanger-val').textContent || '0', 10);
    const capR   = parseInt(tr.querySelector('.cap-rack-val').textContent || '0', 10);
    const prod   = (hanger * capH * capR) || 0;
    tr.querySelector('.prod-val').textContent = prod.toLocaleString();
    return {hanger, capH, capR, prod};
  }

  function bumpProd(tr, delta){
    const capR = parseInt(tr.querySelector('.cap-rack-val').textContent || '0', 10) || 0;
    const capH = parseInt(tr.querySelector('.cap-hanger-val').textContent || '0', 10) || 1;
    const curProd = parseInt((tr.querySelector('.prod-val').textContent||'0').replaceAll(',',''), 10) || 0;
    const nextProd = Math.max(0, curProd + (delta * capR));
    const rackCount = capR > 0 ? Math.ceil(nextProd / capR) : 0;
    const hanger    = capH > 0 ? Math.ceil(rackCount / capH) : 0;
    tr.querySelector('.hanger-val').textContent = hanger;
    tr.querySelector('.prod-val').textContent   = nextProd.toLocaleString();
  }

  document.querySelectorAll('.sr-row').forEach(tr => recalcRow(tr));

  document.querySelectorAll('.sr-row .arrow').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const tr = btn.closest('.sr-row');
      const field = btn.dataset.field; // 'hanger' | 'cap-hanger' | 'prod'
      if(field === 'prod'){ bumpProd(tr, btn.classList.contains('inc') ? +1 : -1); return; }

      const span = field === 'hanger' ? tr.querySelector('.hanger-val') : tr.querySelector('.cap-hanger-val');
      let v = parseInt(span.textContent || '0', 10) || 0;
      if(btn.classList.contains('inc')) v += 1;
      if(btn.classList.contains('dec')) v = Math.max(0, v-1);
      span.textContent = v;
      recalcRow(tr);
    });
  });

  // ì¶”ê°€ â†’ í—¤ë” íˆë“  ì„¸íŒ… + ë¼ì¸ ìƒì„±
  document.querySelectorAll('.sr-row .btn-apply').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const tr = btn.closest('.sr-row');
      const productId  = tr.dataset.product;
      const customerId = tr.dataset.customer;
      const vals = recalcRow(tr); // {hanger, capH, capR, prod}

      const prodSel = document.getElementById('id_product');
      const custSel = document.getElementById('id_customer');
      if (prodSel) prodSel.value = productId;
      if (custSel) custSel.value = customerId;

      if (orderQtyInput) orderQtyInput.value = vals.prod; // ì§€ì‹œìˆ˜ëŸ‰=ìƒì‚°ëŸ‰

      const rackCount = vals.hanger * vals.capH; // ë ‰ ìˆ˜ = í–‰ê±°ìˆ˜Ã—í–‰ê±°ë‹¹ ë ‰
      addRowWith(vals.capR, vals.capH, rackCount, vals.hanger, "");
      refreshBadges();
    });
  });

  // ì´ˆê¸°
  refreshBadges();
});
</script>

{% endblock %}
