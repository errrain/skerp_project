{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}
{% load humanize %}

{% block content %}

<style>
  .erp-box{border:1px solid #000; padding:12px; border-radius:2px; background:#fff; margin-bottom:12px;}
  .erp-title{font-size:20px; font-weight:700; margin:8px 0 12px;}
  .erp-table{width:100%; border-collapse:collapse; font-size:11.4px; table-layout:fixed; line-height:1.2;}
  .erp-table th,.erp-table td{border:1px solid #000; padding:4px 5px;}
  .erp-table thead th{background:#f1f1f1; font-weight:700; text-align:center;}
  .text-right{text-align:right;} .text-center{text-align:center;}
  .btn-erp{border:1px solid #000; background:#efefef; padding:4px 10px; cursor:pointer; font-size:12px;}
  .btn-erp-danger{background:#ffedf0; border-color:#c00; color:#c00;}
  .btn-erp-primary{background:#4CAF50; border-color:#3c9b43; color:#fff;}
  .btn-ghost{background:#fff;}
  .warn{border-color:#dc3545 !important;}
  .num input{ text-align:right; }
  .icon-btn{ width:28px; height:26px; line-height:22px; text-align:center; padding:0; border:1px solid #000; background:#fff; cursor:pointer;}
  .arrow{border:0;background:transparent;cursor:pointer;font-weight:700;color:#0d6efd; padding:0 2px;}
  .arrow:focus{outline:none;}
  .val{display:inline-block; min-width:22px;}

  /* í‘œ ë‚´ìš© ë†’ì´ë§Œí¼ ë³´ì´ë‹¤ê°€, ì´ˆê³¼ ì‹œ ìŠ¤í¬ë¡¤. í‘œ í•˜ë‹¨ ì—¬ë°± 5px */
  #suju-list-wrap, #search-list-wrap{
    max-height: 260px;
    height: auto;
    overflow-y: auto;
    overflow-x: hidden;
    padding-bottom: 5px;
  }
  #suju-list thead th, #suju-list tbody td,
  #search-list thead th, #search-list tbody td{ white-space: nowrap; }

  /* ì¶”ê°€ëœ ë¼ì¸ í•˜ì´ë¼ì´íŠ¸ */
  .row-flash { animation: flash 1.2s ease-out 1; }
  @keyframes flash {
    0% { background:#fff9cc; }
    100% { background:transparent; }
  }
</style>

<div class="erp-title">{{ work_order|default_if_none:''|yesno:"ì‘ì—…ì§€ì‹œì„œ ìˆ˜ì •,ì‘ì—…ì§€ì‹œì„œ ë“±ë¡" }}</div>

<!-- ===== suju : ìˆ˜ì£¼ëª©ë¡ ===== -->
<div id="suju" class="erp-box">
  <div class="d-flex align-items-end justify-content-between" style="gap:8px; margin-bottom:6px;">
    <div style="font-weight:700;">ìˆ˜ì£¼ëª©ë¡</div>
    <form id="suju-search-form" class="d-flex align-items-end" style="gap:8px; flex-wrap:wrap;">
      <div>ìˆ˜ì£¼ì¼ From
        <input type="date" name="order_date_from" class="form-control form-control-sm d-inline-block" style="width:150px;">
      </div>
      <div>To
        <input type="date" name="order_date_to" class="form-control form-control-sm d-inline-block" style="width:150px;">
      </div>
      <div>ì¶œê³ ì˜ˆì • From
        <input type="date" name="delivery_date_from" class="form-control form-control-sm d-inline-block" style="width:150px;">
      </div>
      <div>To
        <input type="date" name="delivery_date_to" class="form-control form-control-sm d-inline-block" style="width:150px;">
      </div>
      <div>í’ˆëª…/í’ˆë²ˆ
        <input type="text" name="name" class="form-control form-control-sm d-inline-block" style="width:260px;" placeholder="í’ˆëª… ë˜ëŠ” í’ˆë²ˆ">
      </div>
      <button type="submit" class="btn-erp">ì¡°íšŒ</button>
      <button type="button" class="btn-erp btn-ghost" id="btn-suju-reset">ì´ˆê¸°í™”</button>
      <span id="suju-count" class="small text-muted"></span>
    </form>
  </div>

  <div id="suju-list-wrap">
    <table id="suju-list" class="erp-table">
      <thead>
        <tr>
          <th style="width:3%">NO</th>
          <th style="width:7%">í’ˆë²ˆ</th>
          <th>í’ˆëª…</th>
          <th style="width:12%">ê³ ê°ì‚¬</th>
          <th style="width:7%">ìˆ˜ëŸ‰</th>
          <th style="width:11%">ìˆ˜ì£¼ì¼</th>
          <th style="width:11%">ì¶œê³  ì˜ˆì •ì¼</th>
          <th style="width:10%">ì‚¬ì¶œì¬ê³ </th>
        </tr>
      </thead>
      <tbody id="suju-tbody">
        {% for s in sales_list %}
        <tr>
          <td class="text-center">{{ forloop.counter }}</td>
          <td class="text-start">{{ s.product.part_number }}</td>
          <td class="text-start">{{ s.product.name }}</td>
          <td class="text-center">{{ s.order.customer.name }}</td>
          <td class="text-end">{{ s.quantity|intcomma }}</td>
          <td class="text-center">{{ s.order.order_date|date:"Y-m-d" }}</td>
          <td class="text-center">{{ s.delivery_date|date:"Y-m-d" }}</td>
          <td class="text-center">-</td>
        </tr>
        {% empty %}
        <tr><td colspan="8" class="text-center">ìˆ˜ì£¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- ===== search : ì œí’ˆ ê²€ìƒ‰ ===== -->
<div id="search" class="erp-box">
  <div style="font-weight:700; margin-bottom:6px;">ê²€ìƒ‰</div>

  <form method="get" id="search-form" class="d-flex align-items-center" style="gap:8px; margin-bottom:8px; flex-wrap:wrap;">
    <div>ê³ ê°ì‚¬
      <select name="customer" class="form-select form-select-sm d-inline-block" style="width:200px;">
        <option value="">------</option>
        {% for c in customers %}
          <option value="{{ c.id }}" {% if selected_customer|default:'' == c.id|stringformat:'s' %}selected{% endif %}>{{ c.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div>í’ˆëª…/í’ˆë²ˆ
      <input type="text" name="q" value="{{ query|default:'' }}" class="form-control form-control-sm d-inline-block" style="width:320px;">
    </div>
    <button type="submit" class="btn-erp">ì¡°íšŒ</button>
    <button type="button" class="btn-erp btn-ghost" id="btn-search-reset">ì´ˆê¸°í™”</button>
  </form>

  <div id="search-list-wrap">
    <table id="search-list" class="erp-table">
      <thead>
        <tr>
          <th style="width:10%">ì œì¡°ì‚¬ì–‘</th>
          <th style="width:10%">ì†Œì¬</th>
          <th>í’ˆëª…</th>
          <th style="width:12%">íˆ¬ì…í–‰ê±°ìˆ˜</th>
          <th style="width:12%">í–‰ê±°ë‹¹ ë ‰ìˆ˜ëŸ‰</th>
          <th style="width:12%">ë ‰ë‹¹ ì œí’ˆìˆ˜</th>
          <th style="width:10%">ìƒì‚°ëŸ‰</th>
          <th style="width:10%">ì¶”ê°€</th>
        </tr>
      </thead>
      <tbody>
        {% for p in search_results %}
        <tr class="sr-row"
            data-product="{{ p.id }}"
            data-product-name="{{ p.name|escapejs }}"
            data-customer="{{ p.customer_id }}"
            data-customer-name="{{ p.customer.name|escapejs }}"
            data-spec="{{ p.spec|escapejs }}"
            data-material="{{ p.material|escapejs }}"
            data-cap-rack="{{ p.product_per_rack|default:0 }}"
            data-cap-hanger="{{ p.rack_per_hanger|default:1 }}"
            data-hanger="{{ p.hanger_count|default:1 }}">
          <td class="text-start">{{ p.spec }}</td>
          <td class="text-center">{{ p.material }}</td>
          <td class="text-start">{{ p.name }}</td>
          <td class="text-center">
            <button type="button" class="arrow dec" data-field="hanger">â–¼</button>
            <span class="val hanger-val">{{ p.hanger_count|default:1 }}</span>
            <button type="button" class="arrow inc" data-field="hanger">â–²</button>
          </td>
          <td class="text-center">
            <button type="button" class="arrow dec" data-field="cap-hanger">â–¼</button>
            <span class="val cap-hanger-val">{{ p.rack_per_hanger|default:1 }}</span>
            <button type="button" class="arrow inc" data-field="cap-hanger">â–²</button>
          </td>
          <td class="text-center"><span class="val cap-rack-val">{{ p.product_per_rack|default:0 }}</span></td>
          <td class="text-end">
            <button type="button" class="arrow dec" data-field="prod">â–¼</button>
            <span class="prod-val">0</span>
            <button type="button" class="arrow inc" data-field="prod">â–²</button>
          </td>
          <td class="text-center">
            <button type="button" class="btn-erp btn-apply">ì¶”ê°€</button>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="8" class="text-center">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- ===== ì²´í¬ ===== -->
<div id="check" class="erp-box">
  <div style="font-weight:700; margin-bottom:6px;">ì‘ì—… ì§€ì‹œ ì¼ì‹œ</div>

  <form id="check-form" class="d-flex align-items-end" style="gap:10px; flex-wrap:wrap;">
    <div>
      <label class="form-label mb-1">ì‘ì—…ì¼ì</label>
      <input type="date" id="chk-date" class="form-control form-control-sm" style="width:160px;">
    </div>
    <div>
      <label class="form-label mb-1">ì‘ì—…ì‹œì‘ì‹œê°„</label>
      <input type="time" id="chk-start" class="form-control form-control-sm" style="width:140px;" step="60">
    </div>
    <div class="d-flex align-items-end" style="gap:8px;">
      <button type="button" class="btn-erp" id="btn-now">ì§€ê¸ˆìœ¼ë¡œ</button>
      <button type="button" class="btn-erp" data-delta="-1">-1ë¶„</button>
      <button type="button" class="btn-erp" data-delta="-10">-10ë¶„</button>
      <button type="button" class="btn-erp" data-delta="10">+10ë¶„</button>
      <button type="button" class="btn-erp" data-delta="1">+1ë¶„</button>
      <button type="button" class="btn-erp btn-ghost" id="btn-clear-check">ì´ˆê¸°í™”</button>

      <div class="d-flex flex-column" style="min-width:150px; margin-left:16px;">
        <label class="form-label mb-1">í–‰ê±°ê°„ê²©</label>
        <input type="text" id="timestep"
               class="form-control form-control-sm"
               style="width:150px;"
               inputmode="numeric"
               placeholder="mm:ss"
               pattern="^\d{1,2}:[0-5]\d$"
               value="4:30">
      </div>
    </div>
  </form>
</div>

<!-- ===== task : New Task(í¼ì…‹) + ì €ì¥ ===== -->
<form method="post" id="order-form" novalidate>
  {% csrf_token %}
  <div class="d-none">
    {{ form.product }}
    {{ form.customer }}
    {{ form.order_qty }}
    {{ form.planned_start }}
    {{ form.planned_end }}
    {{ form.remark }}
  </div>

  {{ formset.management_form }}
  <div id="task" class="erp-box">

    <table class="erp-table" id="line-table">
      <thead>
        <tr>
          <th style="width:60px;">seq</th>
          <th style="width:10%">ì œì¡°ì‚¬ì–‘</th>
          <th style="width:10%">ì†Œì¬</th>
          <th>í’ˆëª…</th>
          <th style="width:12%">íˆ¬ì…í–‰ê±°ìˆ˜</th>
          <th style="width:10%">ìƒì‚°ëŸ‰</th>
          <th style="width:14%">ì‘ì—…ì‹œì‘ ì˜ˆì •ì¼ì‹œ</th>
          <th style="width:14%">ì‘ì—…ì¢…ë£Œ ì˜ˆì •ì¼ì‹œ</th>
          <th style="width:10%">ë¹„ê³ </th>
          <th style="width:100px;">ì´ë™</th>
          <th style="width:60px;">ì‚­ì œ</th>
        </tr>
      </thead>
      <tbody id="line-tbody">
        {% for f in formset.forms %}
        <tr>
          <td>{{ f.sequence|add_class:"form-control form-control-sm text-center seq" }}</td>
          <td class="cell-spec"></td>
          <td class="cell-material"></td>
          <td class="cell-name text-start"></td>
          <td class="cell-hanger text-end"></td>
          <td class="cell-prod text-end"></td>
          <td class="cell-start text-center"></td>
          <td class="cell-end text-center"></td>
          <td>{{ f.remark|add_class:"form-control form-control-sm remark" }}</td>
          <td class="text-center">
            <button type="button" class="icon-btn btn-up">â–²</button>
            <button type="button" class="icon-btn btn-down">â–¼</button>
          </td>
          <td class="text-center">
            {% if formset.can_delete %}
              <button type="button" class="btn-erp btn-erp-danger btn-del">ì‚­ì œ</button>
              {{ f.DELETE|add_class:"d-none del-flag" }}
            {% endif %}
          </td>

          {{ f.rack_capacity|add_class:"d-none cap-rack" }}
          {{ f.rack_count|add_class:"d-none rack-count" }}
          {{ f.hanger_capacity|add_class:"d-none cap-hanger" }}
          {{ f.hanger_count|add_class:"d-none hanger-count" }}
        </tr>
        {% empty %}
        <tr><td colspan="11" class="text-center">ë¼ì¸ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ ê²€ìƒ‰ ê²°ê³¼ì—ì„œ [ì¶”ê°€]í•˜ê±°ë‚˜ [+ í–‰ ì¶”ê°€]ë¥¼ ì´ìš©í•˜ì„¸ìš”.</td></tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="d-flex justify-content-between align-items-center" style="margin-top:8px;">
      <div class="small text-muted">
        â€» ê·œì¹™: <b>ì§€ì‹œEA = ë ‰ ìˆ˜ Ã— 1ë ‰ë‹¹EA</b>, <b>í–‰ê±° ìˆ˜ Ã— 1í–‰ê±°ë‹¹ ë ‰ â‰¥ ë ‰ ìˆ˜</b>
      </div>
      <div class="d-flex" style="gap:6px;">
        <button type="button" id="btn-add-row" class="btn-erp">+ í–‰ ì¶”ê°€</button>
        <button type="button" id="btn-clear-rows" class="btn-erp btn-erp-danger">ì „ì²´ ì‚­ì œ</button>
        <button type="submit" class="btn-erp btn-erp-primary">ğŸ’¾ ì €ì¥</button>
      </div>
    </div>
  </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', () => {
  /* ---------- ê³µí†µ ìœ í‹¸ ---------- */
  const pad2 = n => String(n).padStart(2,'0');
  const parseMMSS = v => {
    const m = (v||'').trim().match(/^(\d{1,2}):([0-5]\d)$/);
    return m ? (+m[1]*60 + +m[2]) : null;
  };
  const fmtDT = dt => `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())} ${pad2(dt.getHours())}:${pad2(dt.getMinutes())}`;

  const $date = document.getElementById('chk-date');
  const $start = document.getElementById('chk-start');
  const $gapInput = document.getElementById('timestep');

  function nowToInputs() {
    const d=new Date();
    $date.value = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    $start.value= `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    if(!$gapInput.value) $gapInput.value = '4:30';
  }
  function shiftMinutes(delta){
    let base = new Date();
    if($date.value){
      const [y,m,dy]=$date.value.split('-').map(Number);
      base = new Date(y,m-1,dy);
    }
    const [hh,mm]=($start.value||'00:00').split(':').map(Number);
    base.setHours(hh,mm,0,0);
    base = new Date(base.getTime()+delta*60000);
    $date.value = `${base.getFullYear()}-${pad2(base.getMonth()+1)}-${pad2(base.getDate())}`;
    $start.value= `${pad2(base.getHours())}:${pad2(base.getMinutes())}`;
  }
  document.getElementById('btn-now').addEventListener('click', nowToInputs);
  document.querySelectorAll('#check-form [data-delta]').forEach(b=>{
    b.addEventListener('click',()=>shiftMinutes(parseInt(b.dataset.delta,10)));
  });
  document.getElementById('btn-clear-check').addEventListener('click',()=>{
    $date.value=''; $start.value=''; $gapInput.value='4:30'; $gapInput.setCustomValidity('');
  });
  $gapInput.addEventListener('change', ()=>{
    const sec = parseMMSS($gapInput.value);
    if(sec===null){ $gapInput.setCustomValidity('mm:ss í˜•ì‹ (ì˜ˆ: 4:30)'); }
    else { $gapInput.setCustomValidity(''); }
  });
  nowToInputs();

  /* ---------- ìˆ˜ì£¼ëª©ë¡ ê²€ìƒ‰ ---------- */
  const sujuForm  = document.getElementById('suju-search-form');
  const sujuBody  = document.getElementById('suju-tbody');
  const sujuCount = document.getElementById('suju-count');

  sujuForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const params = new URLSearchParams(new FormData(sujuForm)).toString();
    const url = "{% url 'production:orders:search_sales_orders' %}?"+params;
    try{
      const res = await fetch(url, {headers:{'X-Requested-With':'XMLHttpRequest'}});
      if(!res.ok) throw new Error('ê²€ìƒ‰ ì‹¤íŒ¨');
      const data = await res.json();
      const rows = data.results || [];
      sujuBody.innerHTML = '';
      sujuCount.textContent = `${rows.length}ê±´`;
      if(!rows.length){
        sujuBody.innerHTML = `<tr><td colspan="8" class="text-center">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
        return;
      }
      rows.forEach((r,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="text-center">${i+1}</td>
          <td class="text-start">${r.product_code || ''}</td>
          <td class="text-start">${r.product_name || ''}</td>
          <td class="text-center">${r.customer_name || ''}</td>
          <td class="text-end">${(r.order_qty||0).toLocaleString()}</td>
          <td class="text-center">${r.order_date || ''}</td>
          <td class="text-center">${r.planned_ship_date || r.delivery_date || ''}</td>
          <td class="text-center">${r.injection_stock ?? '-'}</td>`;
        sujuBody.appendChild(tr);
      });
    }catch(err){
      console.error(err);
      alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  });

  /* ---------- ë¼ì¸(Formset) ì¡°ì‘ ---------- */
  const tbody = document.getElementById('line-tbody');
  const addBtn = document.getElementById('btn-add-row');
  const clearBtn = document.getElementById('btn-clear-rows');
  const totalForms = document.getElementById('{{ formset.prefix }}-TOTAL_FORMS');
  const formPrefix = '{{ formset.prefix }}';
  const orderQtyInput = document.getElementById('id_order_qty');

function refreshBadges(){
  const trs = [...tbody.querySelectorAll('tr')].filter(tr => tr.style.display !== 'none');
  let sum = 0, ok = true;

  trs.forEach(tr=>{
    const rackCount = +tr.querySelector('.rack-count')?.value || 0;
    const capRack   = +tr.querySelector('.cap-rack')?.value   || 0;
    const hangCount = +tr.querySelector('.hanger-count')?.value|| 0;
    const capHang   = +tr.querySelector('.cap-hanger')?.value || 0;
    const orderQtyEl = document.getElementById('id_order_qty');
    const orderQty = parseInt(orderQtyEl?.value || '0', 10);

    sum += rackCount * capRack;

    const bad = (capHang > 0 && hangCount * capHang < rackCount);
    tr.classList.toggle('warn-line', bad);
    if (bad) ok = false;
  });

  const orderQty = +(orderQtyInput?.value || 0);

  const elOrder = document.getElementById('badge-order');
  if (elOrder) elOrder.textContent = (orderQty || 0).toLocaleString();

  const elSum = document.getElementById('badge-sum-val');
  if (elSum) elSum.textContent = sum.toLocaleString();

  const badge   = document.getElementById('badge-match');
  const badgeVal= document.getElementById('badge-match-val');
  if (badge && badgeVal) {
    if (orderQty === sum && ok) {
      badge.classList.add('ok');  badge.classList.remove('bad');
      badgeVal.textContent = 'ì¼ì¹˜';
    } else {
      badge.classList.add('bad'); badge.classList.remove('ok');
      badgeVal.textContent = 'ë¶ˆì¼ì¹˜';
    }
  }
}
  function resequence(){
    [...tbody.querySelectorAll('tr')].forEach((tr,i)=>{ const seq=tr.querySelector('.seq'); if(seq) seq.value=i+1; });
  }

  // ë¹ˆ í–‰ ìˆ˜ë™ ì¶”ê°€(í‘œì‹œ ì¹¼ëŸ¼ì€ ê³µë°±)
  addBtn.addEventListener('click', ()=>{
    const idx = +totalForms.value;
    const html = `
      <tr class="row-flash">
        <td><input type="number" name="${formPrefix}-${idx}-sequence" value="${idx+1}" class="form-control form-control-sm text-center seq"></td>
        <td class="cell-spec"></td>
        <td class="cell-material"></td>
        <td class="cell-name text-start"></td>
        <td class="cell-hanger text-end"></td>
        <td class="cell-prod text-end"></td>
        <td class="cell-start text-center"></td>
        <td class="cell-end text-center"></td>
        <td><input type="text" name="${formPrefix}-${idx}-remark" class="form-control form-control-sm remark"></td>
        <td class="text-center">
          <button type="button" class="icon-btn btn-up">â–²</button>
          <button type="button" class="icon-btn btn-down">â–¼</button>
        </td>
        <td class="text-center">
          <button type="button" class="btn-erp btn-erp-danger btn-del">ì‚­ì œ</button>
          <input type="checkbox" name="${formPrefix}-${idx}-DELETE" class="d-none del-flag">
        </td>
        <input type="number" name="${formPrefix}-${idx}-rack_capacity" class="d-none cap-rack" value="0">
        <input type="number" name="${formPrefix}-${idx}-rack_count"    class="d-none rack-count" value="0">
        <input type="number" name="${formPrefix}-${idx}-hanger_capacity" class="d-none cap-hanger" value="0">
        <input type="number" name="${formPrefix}-${idx}-hanger_count"    class="d-none hanger-count" value="0">
      </tr>`;
    tbody.insertAdjacentHTML('beforeend', html);
    totalForms.value = idx+1;
    tbody.lastElementChild.scrollIntoView({behavior:'smooth', block:'nearest'});
    refreshBadges();
  });

  clearBtn.addEventListener('click', ()=>{
    tbody.innerHTML = `<tr><td colspan="11" class="text-center">ë¼ì¸ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ ê²€ìƒ‰ ê²°ê³¼ì—ì„œ [ì¶”ê°€]í•˜ê±°ë‚˜ [+ í–‰ ì¶”ê°€]ë¥¼ ì´ìš©í•˜ì„¸ìš”.</td></tr>`;
    totalForms.value = 0; refreshBadges();
  });

  tbody.addEventListener('click',(e)=>{
    const tr = e.target.closest('tr'); if(!tr) return;
    if(e.target.classList.contains('btn-up') && tr.previousElementSibling){
      tr.parentNode.insertBefore(tr, tr.previousElementSibling); resequence();
    }
    if(e.target.classList.contains('btn-down') && tr.nextElementSibling){
      tr.parentNode.insertBefore(tr.nextElementSibling, tr); resequence();
    }
    if(e.target.classList.contains('btn-dup')){
      const idx = +totalForms.value;
      const clone = tr.cloneNode(true);
      // name ì¸ë±ìŠ¤ ì¹˜í™˜
      clone.querySelectorAll('[name]').forEach(inp=>{
        inp.name = inp.name.replace(new RegExp(`${formPrefix}-(\\d+)-`), `${formPrefix}-${idx}-`);
      });
      clone.classList.add('row-flash');
      tbody.appendChild(clone);
      totalForms.value = idx+1; resequence(); refreshBadges();
      tbody.lastElementChild.scrollIntoView({behavior:'smooth', block:'nearest'});
    }
    if(e.target.classList.contains('btn-del')){
      const del = tr.querySelector('.del-flag');
      if(del){ del.checked = true; tr.style.display='none'; }
      refreshBadges();
    }
  });

  tbody.addEventListener('input',(e)=>{
    if(e.target.matches('.rack-count,.cap-rack,.hanger-count,.cap-hanger')) refreshBadges();
  });
  orderQtyInput?.addEventListener('input', refreshBadges);

  /* ---------- ê²€ìƒ‰ê²°ê³¼ í–‰ ì¡°ì •(ê¸°ì¡´) ---------- */
  function recalcRow(tr){
    const hanger = parseInt(tr.querySelector('.hanger-val').textContent || '0', 10);
    const capH   = parseInt(tr.querySelector('.cap-hanger-val').textContent || '0', 10);
    const capR   = parseInt(tr.querySelector('.cap-rack-val').textContent || '0', 10);
    const prod   = (hanger * capH * capR) || 0;
    tr.querySelector('.prod-val').textContent = prod.toLocaleString();
    return {hanger, capH, capR, prod};
  }
  function bumpProd(tr, delta){
    const capR = parseInt(tr.querySelector('.cap-rack-val').textContent || '0', 10) || 0;
    const capH = parseInt(tr.querySelector('.cap-hanger-val').textContent || '0', 10) || 1;
    const curProd = parseInt((tr.querySelector('.prod-val').textContent||'0').replaceAll(',',''), 10) || 0;
    const nextProd = Math.max(0, curProd + (delta * capR));
    const rackCount = capR > 0 ? Math.ceil(nextProd / capR) : 0;
    const hanger    = capH > 0 ? Math.ceil(rackCount / capH) : 0;
    tr.querySelector('.hanger-val').textContent = hanger;
    tr.querySelector('.prod-val').textContent   = nextProd.toLocaleString();
  }
  document.querySelectorAll('.sr-row').forEach(tr => recalcRow(tr));
  document.querySelectorAll('.sr-row .arrow').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const tr = btn.closest('.sr-row');
      const field = btn.dataset.field;
      if(field === 'prod'){ bumpProd(tr, btn.classList.contains('inc') ? +1 : -1); return; }
      const span = field === 'hanger' ? tr.querySelector('.hanger-val') : tr.querySelector('.cap-hanger-val');
      let v = parseInt(span.textContent || '0', 10) || 0;
      if(btn.classList.contains('inc')) v += 1;
      if(btn.classList.contains('dec')) v = Math.max(0, v-1);
      span.textContent = v;
      recalcRow(tr);
    });
  });

  /* ---------- ê²€ìƒ‰í–‰ [ì¶”ê°€] â†’ ë¼ì¸ ì£¼ì… ---------- */
  function computePlanTimes(hanger){
    if(!($date.value && $start.value)) return {startText:'', endText:''};
    const [y,m,dy]=$date.value.split('-').map(Number);
    const [hh,mm]=$start.value.split(':').map(Number);
    const start = new Date(y,m-1,dy,hh,mm,0,0);
    const gapSec = parseMMSS($gapInput.value);
    if(gapSec===null) return {startText:'', endText:''};
    const end = new Date(start.getTime() + (hanger * gapSec * 1000));
    return {startText: fmtDT(start), endText: fmtDT(end)};
  }

  document.querySelectorAll('.sr-row .btn-apply').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const tr = btn.closest('.sr-row');
      const vals = recalcRow(tr);
      const capR = vals.capR, capH = vals.capH, hanger = vals.hanger, prod = vals.prod;

      if(!capR || !prod){
        alert('ìƒì‚°ëŸ‰ 0ì€ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íˆ¬ì…í–‰ê±°/ë ‰ìˆ˜ëŸ‰/ë ‰ë‹¹EAë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        return;
      }
      // í–‰ê±°ê°„ê²© ìœ íš¨ì„±
      if(parseMMSS($gapInput.value) === null){
        alert('í–‰ê±°ê°„ê²©ì€ mm:ss í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: 4:30)');
        $gapInput.focus();
        return;
      }

      // í—¤ë” ê°’ ì„¸íŒ…
      const prodSel = document.getElementById('id_product');
      const custSel = document.getElementById('id_customer');
      const orderQtyInput = document.getElementById('id_order_qty');
      if (prodSel) prodSel.value = tr.dataset.product;
      if (custSel) custSel.value = tr.dataset.customer;
      if (orderQtyInput) orderQtyInput.value = prod;

      const rackCount = hanger * capH;
      const {startText, endText} = computePlanTimes(hanger);

      // ë¼ì¸ ì£¼ì…
      const idx = +totalForms.value;
      const html = `
        <tr class="row-flash">
          <td><input type="number" name="${formPrefix}-${idx}-sequence" value="${idx+1}" class="form-control form-control-sm text-center seq"></td>
          <td class="cell-spec">${tr.dataset.spec || ''}</td>
          <td class="cell-material text-center">${tr.dataset.material || ''}</td>
          <td class="cell-name text-start">${tr.dataset.productName || tr.dataset.product_name || tr.dataset.productname || tr.dataset.product_name || tr.dataset.product_name || tr.querySelector('td:nth-child(3)')?.textContent || ''}</td>
          <td class="cell-hanger text-end">${hanger.toLocaleString()}</td>
          <td class="cell-prod text-end">${prod.toLocaleString()}</td>
          <td class="cell-start text-center">${startText || '-'}</td>
          <td class="cell-end text-center">${endText || '-'}</td>
          <td><input type="text" name="${formPrefix}-${idx}-remark" class="form-control form-control-sm remark"></td>
          <td class="text-center">
            <button type="button" class="icon-btn btn-up">â–²</button>
            <button type="button" class="icon-btn btn-down">â–¼</button>
          </td>
          <td class="text-center">
            <button type="button" class="btn-erp btn-erp-danger btn-del">ì‚­ì œ</button>
            <input type="checkbox" name="${formPrefix}-${idx}-DELETE" class="d-none del-flag">
          </td>
          <input type="number" name="${formPrefix}-${idx}-rack_capacity" class="d-none cap-rack" value="${capR}">
          <input type="number" name="${formPrefix}-${idx}-rack_count"    class="d-none rack-count" value="${rackCount}">
          <input type="number" name="${formPrefix}-${idx}-hanger_capacity" class="d-none cap-hanger" value="${capH}">
          <input type="number" name="${formPrefix}-${idx}-hanger_count"    class="d-none hanger-count" value="${hanger}">
        </tr>`;
      // ë¹ˆ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ì œê±°
      if(tbody.children.length===1 && tbody.firstElementChild.querySelector('td[colspan]')) tbody.innerHTML='';
      tbody.insertAdjacentHTML('beforeend', html);
      totalForms.value = idx+1;
      tbody.lastElementChild.scrollIntoView({behavior:'smooth', block:'nearest'});
      refreshBadges();
    });
  });

  refreshBadges();
});

/* ---------- ì´ˆê¸°í™” ë²„íŠ¼ë“¤ ---------- */
(function(){
  const $form  = document.getElementById('suju-search-form');
  const $tbody = document.getElementById('suju-tbody');
  const $count = document.getElementById('suju-count');
  const $reset = document.getElementById('btn-suju-reset');
  $reset.addEventListener('click', () => {
    $form.querySelectorAll('input[type="date"], input[type="text"]').forEach(el => el.value = '');
    $count.textContent = '';
    $tbody.innerHTML = `<tr><td colspan="8" class="text-center">ê²€ìƒ‰ ì¡°ê±´ì„ ì…ë ¥í•˜ê³  ì¡°íšŒë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>`;
  });
})();
(function(){
  const $form  = document.getElementById('search-form');
  const $reset = document.getElementById('btn-search-reset');
  const $tbody = document.querySelector('#search-list tbody');
  $reset.addEventListener('click', () => {
    $form.querySelectorAll('input[type="text"]').forEach(el => el.value = '');
    $form.querySelectorAll('select').forEach(sel => sel.value = '');
    $tbody.innerHTML = `<tr><td colspan="8" class="text-center">ê²€ìƒ‰ ì¡°ê±´ì„ ì…ë ¥í•˜ê³  ì¡°íšŒë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>`;
  });
})();
</script>

{% endblock %}
