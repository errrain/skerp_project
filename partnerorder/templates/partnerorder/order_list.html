<!-- partnerorder/order_list.html -->
{% extends 'base.html' %}
{% load humanize %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3" style="font-size: 0.9rem;">
  <h4 class="mb-0">협력사 발주 처리</h4>
  <!-- 협력사용 화면: 신규 버튼 없음 -->
</div>

<form method="get" class="row g-2 mb-3 align-items-center">
  <div class="col-auto">
    <select name="status" class="form-select form-select-sm">
      <option value="">상태 전체</option>
      {% for s in status_list %}
        <option value="{{ s }}" {% if request.GET.status == s %}selected{% endif %}>{{ s }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-auto">
    <input type="date" name="from" value="{{ request.GET.from }}" class="form-control form-control-sm" placeholder="발주일 From">
  </div>
  <div class="col-auto">
    <input type="date" name="to" value="{{ request.GET.to }}" class="form-control form-control-sm" placeholder="발주일 To">
  </div>
  <div class="col-auto">
    <button type="submit" class="btn btn-sm btn-primary">검색</button>
  </div>
</form>

<form method="post" action="{% url 'partner:print_qr' %}">
  {% csrf_token %}
  <table class="table table-striped table-bordered table-sm text-center align-middle" style="font-size: 12px; border: 1px solid #000000;">
    <thead class="table-light">
      <tr>
        <th class="fw-bold table-header" style="width:28px;">
          <input type="checkbox" id="chk-all" onclick="document.querySelectorAll('input[name=ids]').forEach(c=>c.checked=this.checked)">
        </th>
        <th class="fw-bold table-header">발주 LOT</th>
        <th class="fw-bold table-header">발주처</th>
        <th class="fw-bold table-header">발주일</th>
        <th class="fw-bold table-header">품명(대표)</th>
        <th class="fw-bold table-header">수량합</th>
        <th class="fw-bold table-header">입고 예정일</th>
        <th class="fw-bold table-header">상태</th>
        <th class="fw-bold table-header">관리</th>
      </tr>
    </thead>
    <tbody>
      {% for o in object_list %}
      <tr>
        <td><input type="checkbox" name="ids" value="{{ o.id }}"></td>
        <td>{{ o.order_lot }}</td>
        <td>{{ o.vendor.name }}</td>
        <td>{{ o.order_date|date:"Y-m-d" }}</td>
        <td>{% with fi=o.items.first %}{% if fi %}{{ fi.injection.name }}{% else %}-{% endif %}{% endwith %}</td>
        <td>{{ o.qty_sum|default:0 }}</td>
        <td>{{ o.due_date|date:"Y-m-d" }}</td>
        <td>
          <span class="badge bg-secondary">{{ o.status }}</span>
          {% if o.shipping_registered_at %}
            <div class="small text-muted">{{ o.shipping_registered_at|date:"Y-m-d H:i" }}</div>
          {% endif %}
        </td>
<td> {% if o.status == '미입고' or o.status == '반출' %} {% if user.is_internal or o.vendor_id == user.vendor_id %} <!-- 중첩 form 제거, 버튼만 두고 제출 목적지 분기 -->
  <button type="submit" class="btn btn-sm btn-outline-success" formaction="{% url 'partner:register_shipping' o.id %}" formmethod="post"> 배송등록 </button> {% endif %} {% endif %} </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="9" class="text-center text-muted">조회된 데이터가 없습니다.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="d-flex justify-content-end">
    <button type="submit" class="btn btn-sm btn-outline-dark">QR 출력</button>
  </div>
</form>

{% endblock %}

