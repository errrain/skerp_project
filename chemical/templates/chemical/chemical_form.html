{% extends 'base.html' %}
{% load widget_tweaks %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4>ì•½í’ˆ ë“±ë¡/ìˆ˜ì •</h4>
    {% if form.instance.pk %}
    <a href="{% url 'chemical:chemical_price' form.instance.pk %}" class="btn btn-sm btn-outline-primary">ğŸ’° ë‹¨ê°€ íƒ­</a>
    {% endif %}
</div>

<form method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}

    {% if form.non_field_errors %}
    <div class="alert alert-danger py-2 small">
        {{ form.non_field_errors }}
    </div>
    {% endif %}

    <div class="row">
        <div class="col-md-8">
            <div class="row">
                <!-- í’ˆëª… -->
                <div class="col-md-6 mb-2">
                    <label class="form-label">í’ˆëª… *</label>
                    {{ form.name|add_class:"form-control form-control-sm" }}
                    {% if form.name.errors %}<div class="invalid-feedback d-block small">{{ form.name.errors.0 }}</div>{% endif %}
                </div>

                <!-- ê·œê²©(ìì—°ì–´) -->
                <div class="col-md-6 mb-2">
                    <label class="form-label">ê·œê²©(ìì—°ì–´)</label>
                    {{ form.spec|add_class:"form-control form-control-sm" }}
                    <div class="form-text">
                        ì˜ˆ) <code>18kg/ë§</code>, <code>ë¶„ë§</code>, <code>500mm SJ2</code>
                    </div>
                    {% if form.spec.errors %}<div class="invalid-feedback d-block small">{{ form.spec.errors.0 }}</div>{% endif %}
                </div>

                <!-- ë‹¨ìœ„ê·œê²©(ì •ìˆ˜) / ì¸¡ì • ë‹¨ìœ„ -->
                <div class="col-md-3 mb-2">
                    <label class="form-label">ë‹¨ìœ„ê·œê²©(ì •ìˆ˜)</label>
                    {{ form.unit_qty|add_class:"form-control form-control-sm" }}
                    {% if form.unit_qty.errors %}<div class="invalid-feedback d-block small">{{ form.unit_qty.errors.0 }}</div>{% endif %}
                </div>
                <div class="col-md-3 mb-2">
                    <label class="form-label">ì¸¡ì • ë‹¨ìœ„</label>
                    {{ form.spec_unit|add_class:"form-select form-select-sm" }}
                    {% if form.spec_unit.errors %}<div class="invalid-feedback d-block small">{{ form.spec_unit.errors.0 }}</div>{% endif %}
                </div>

                <!-- í¬ì¥ë‹¨ìœ„ / ë¹„ê³ (ì„±ìƒÂ·ë“±ê¸‰) -->
                <div class="col-md-3 mb-2">
                    <label class="form-label">í¬ì¥ë‹¨ìœ„</label>
                    {{ form.container_uom|add_class:"form-control form-control-sm" }}
                    <div class="form-text">ì˜ˆ) ë§ / í†µ / ë“œëŸ¼ / EA</div>
                    {% if form.container_uom.errors %}<div class="invalid-feedback d-block small">{{ form.container_uom.errors.0 }}</div>{% endif %}
                </div>
                <div class="col-md-3 mb-2">
                    <label class="form-label">ë¹„ê³ (ì„±ìƒ/ë“±ê¸‰)</label>
                    {{ form.spec_note|add_class:"form-control form-control-sm" }}
                    <div class="form-text">ì˜ˆ) ë¶„ë§, SJ2</div>
                    {% if form.spec_note.errors %}<div class="invalid-feedback d-block small">{{ form.spec_note.errors.0 }}</div>{% endif %}
                </div>

                <!-- ì‚¬ìš© ë‹¨ìœ„ / í¬ì¥ë‹¹ ì‚¬ìš©ë‹¨ìœ„ ìˆ˜ëŸ‰ -->
                <div class="col-md-3 mb-2">
                    <label class="form-label">ì‚¬ìš© ë‹¨ìœ„</label>
                    {{ form.use_unit|add_class:"form-select form-select-sm" }}
                    {% if form.use_unit.errors %}<div class="invalid-feedback d-block small">{{ form.use_unit.errors.0 }}</div>{% endif %}
                </div>
                <div class="col-md-3 mb-2">
                    <label class="form-label">í¬ì¥ë‹¹ ì‚¬ìš©ë‹¨ìœ„ ìˆ˜ëŸ‰</label>
                    {{ form.use_base_qty|add_class:"form-control form-control-sm" }}
                    <div class="form-text">ì˜ˆ) 4L, ì‚¬ìš©ë‹¨ìœ„ mL â†’ 4000</div>
                    {% if form.use_base_qty.errors %}<div class="invalid-feedback d-block small">{{ form.use_base_qty.errors.0 }}</div>{% endif %}
                </div>

                <!-- ê³ ê°ì‚¬ / ì‚¬ìš©ì—¬ë¶€ -->
                <div class="col-md-6 mb-2">
                    <label class="form-label">ê³ ê°ì‚¬</label>
                    {{ form.customer|add_class:"form-select form-select-sm" }}
                    {% if form.customer.errors %}<div class="invalid-feedback d-block small">{{ form.customer.errors.0 }}</div>{% endif %}
                </div>
                <div class="col-md-6 mb-2">
                    <label class="form-label">ì‚¬ìš©ì—¬ë¶€</label>
                    {{ form.use_yn|add_class:"form-select form-select-sm" }}
                    {% if form.use_yn.errors %}<div class="invalid-feedback d-block small">{{ form.use_yn.errors.0 }}</div>{% endif %}
                </div>
            </div>
        </div>

        <!-- íŒŒì¼/ì´ë¯¸ì§€ ì˜ì—­ -->
        <div class="col-md-4">
            <div class="text-center mb-3">
                {% if form.instance.image %}
                    <img src="{{ form.instance.image.url }}" class="img-thumbnail mb-2" width="200" alt="ì œí’ˆ ì´ë¯¸ì§€">
                {% endif %}
                <label class="form-label">ì œí’ˆ ì´ë¯¸ì§€</label>
                {{ form.image|add_class:"form-control form-control-sm" }}
                {% if form.image.errors %}<div class="invalid-feedback d-block small">{{ form.image.errors.0 }}</div>{% endif %}
            </div>

            <div class="mb-2">
                <label class="form-label">MSDS íŒŒì¼</label>
                {{ form.msds_file|add_class:"form-control form-control-sm" }}
                {% if form.msds_file.errors %}<div class="invalid-feedback d-block small">{{ form.msds_file.errors.0 }}</div>{% endif %}
            </div>

            <div class="mb-2">
                <label class="form-label">TDS íŒŒì¼</label>
                {{ form.tds_file|add_class:"form-control form-control-sm" }}
                {% if form.tds_file.errors %}<div class="invalid-feedback d-block small">{{ form.tds_file.errors.0 }}</div>{% endif %}
            </div>
        </div>
    </div>

    <div class="mt-3">
        <button type="submit" class="btn btn-success btn-sm">ì €ì¥</button>
        <a href="{% url 'chemical:chemical_list' %}" class="btn btn-secondary btn-sm">â† ëª©ë¡</a>
    </div>
</form>

{% if form.instance.pk %}
<hr class="mt-4">

<div id="std-section"
     data-url="{% url 'chemical:chemical_std' form.instance.pk %}">
</div>

<div id="range-section"
     data-url="{% url 'chemical:chemical_range' form.instance.pk %}">
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const sectionIds = ['std-section', 'range-section'];

  sectionIds.forEach(function (id) {
    const container = document.getElementById(id);
    if (!container) return;

    const url = container.dataset.url;
    if (!url) return;

    function bindForm() {
      const form = container.querySelector('form');
      if (!form) return;

      form.addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(form);

        fetch(url, {
          method: 'POST',
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
          body: formData
        })
        .then(resp => resp.text())
        .then(html => {
          container.innerHTML = html;
          bindForm();
        });
      });
    }

    function loadBlock() {
      fetch(url, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      })
      .then(resp => resp.text())
      .then(html => {
        container.innerHTML = html;
        bindForm();
      });
    }

    loadBlock();
  });
});
</script>
{% endif %}
{% endblock %}
