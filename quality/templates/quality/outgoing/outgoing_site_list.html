{% extends "base.html" %}
{% load humanize %}
{% block content %}

<style>
  /* 현장용: 글자/버튼 크게, 터치 여유 확보 */

  .site-header {
    font-size: 1.4rem;
    font-weight: 700;
  }
  .site-sub {
    font-size: 0.9rem;
    color: #666;
  }
  .site-search label {
    font-size: 0.9rem;
    margin-bottom: .2rem;
  }
  .site-search input,
  .site-search button {
    font-size: 1rem;
  }

  .site-table {
    font-size: 1rem;
  }
  .site-table thead th {
    padding: 0.7rem 0.4rem;
    text-align: center;
    background: #000;
    color: #fff;
  }
  .site-table tbody td {
    padding: 0.6rem 0.4rem;
    vertical-align: middle;
  }

  .btn-site {
    font-size: 0.95rem;
    padding: 0.35rem 0.8rem;
  }

  .insp-tag {
    display:inline-block;
    padding:.25rem .7rem;
    border-radius:999px;
    border:1px solid transparent;
    font-size:.85rem;
    font-weight:600;
    white-space:nowrap;
  }
  .insp-tag-wait { background:#f8f9fa; border-color:#ced4da; color:#495057; }
  .insp-tag-ing  { background:#fff3cd; border-color:#ffe69c; color:#664d03; }
  .insp-tag-done { background:#d1e7dd; border-color:#badbcc; color:#0f5132; }
  .insp-tag-rest { background:#e2e3e5; border-color:#d3d6d8; color:#41464b; }
</style>

<div class="container-fluid">

  <!-- 헤더 / 날짜 네비 -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <div class="site-header">출하검사 (현장용)</div>
      <div class="site-sub">작업일 기준으로 생산완료 LOT만 표시됩니다.</div>
    </div>

    <div class="btn-group btn-group-sm" role="group" aria-label="날짜이동">
      <a class="btn btn-outline-secondary"
         href="?d={{ prev_date|date:'Y-m-d' }}">
        « 이전
      </a>
      <span class="btn btn-light disabled">
        {{ query_date|date:"Y-m-d" }}
      </span>
      <a class="btn btn-outline-secondary"
         href="?d={{ next_date|date:'Y-m-d' }}">
        다음 »
      </a>
    </div>
  </div>

  <!-- 검색영역 -->
  <form method="get" class="row g-2 mb-3 align-items-end site-search">
    <div class="col-auto">
      <label class="form-label mb-1">기준일(작업일)</label>
      <input type="date"
             name="d"
             class="form-control form-control-lg"
             value="{{ query_date|date:'Y-m-d' }}">
    </div>
    <div class="col-auto">
      <label class="form-label mb-1">&nbsp;</label>
      <button type="submit" class="btn btn-primary btn-lg">
        검색
      </button>
    </div>
  </form>

  <!-- 목록 테이블 -->
  <table class="table table-bordered site-table text-center">
    <thead>
      <tr>
        <th>작업 LOT</th>
        <th>품명</th>

        <!-- 계획검사수량(지시수량) = 작업수량 -->
        <th>계획검사수량<br>(지시수량)</th>

        <!-- 박스당 포장수량 -->
        <th>박스당<br>포장수량</th>

        <!-- 미검사 잔여수량 -->
        <th>미검사<br>잔여수량</th>

        <!-- 누적검사수량 -->
        <th>누적<br>검사수량</th>

        <!-- 포장완료 BOX / 포장완료수량 -->
        <th>포장완료 BOX<br>/ 포장완료수량</th>

        <!-- 누적불량수량 -->
        <th>누적<br>불량수량</th>

        <!-- 실수량 보정입력(±EA) -->
        <th>실수량<br>보정(±EA)</th>

        <!-- 검사일 -->
        <th>검사일</th>

        <th>상태</th>
        <th style="width: 120px;">검사</th>
      </tr>
    </thead>
    <tbody>
      {% for o in orders %}
        {% with insp=o.outgoing_inspection %}
        <tr>
          <!-- 작업 LOT / 품명 -->
          <td>{{ o.work_lot }}</td>
          <td class="text-start">{{ o.product.name }}</td>

          <!-- 계획검사수량(지시수량) = 작업수량 -->
          <td class="text-end">
            {{ o.order_qty|default:0|intcomma }}
          </td>

          <!-- 박스당 포장수량 -->
          <td class="text-end">
            {{ o.box_size_for_outgoing|default:0|intcomma }}
          </td>

          <!-- 미검사 잔여수량 -->
          <td class="text-end">
            {% if insp %}
              {{ o.remain_qty_for_outgoing|default:0|intcomma }}
            {% else %}
              -
            {% endif %}
          </td>

          <!-- 누적검사수량 -->
          <td class="text-end">
            {% if insp and insp.inspect_qty %}
              {{ insp.inspect_qty|intcomma }}
            {% else %}
              -
            {% endif %}
          </td>

          <!-- 포장완료 BOX / 포장완료수량 -->
          <td class="text-end">
            {% if insp and insp.good_qty %}
              {% if o.finished_box_cnt_for_outgoing %}
                {{ o.finished_box_cnt_for_outgoing|intcomma }} BOX /
              {% else %}
                0 BOX /
              {% endif %}
              {{ insp.good_qty|intcomma }} EA
            {% else %}
              -
            {% endif %}
          </td>

          <!-- 누적불량수량 -->
          <td class="text-end">
            {% if insp and insp.defect_qty %}
              {{ insp.defect_qty|intcomma }}
            {% else %}
              -
            {% endif %}
          </td>

          <!-- 실수량 보정입력(±EA) -->
          <td class="text-end">
            {% if insp and insp.adjust_qty %}
              {{ insp.adjust_qty|intcomma }}
            {% else %}
              0
            {% endif %}
          </td>

          <!-- 검사일 -->
          <td class="text-center">
            {% if insp and insp.inspection_date %}
              {{ insp.inspection_date|date:"Y-m-d" }}
            {% else %}
              -
            {% endif %}
          </td>

          <!-- 상태 태그 (기존 코드 그대로 유지) -->
          <td>
            {% if not insp %}
              <span class="insp-tag insp-tag-wait">대기</span>
            {% else %}
              {% if insp.status == "DRAFT" %}
                <span class="insp-tag insp-tag-ing">진행</span>
              {% elif insp.status == "HOLD" %}
                <span class="insp-tag insp-tag-rest">
                  잔량 {{ o.remain_qty_for_outgoing|default:0|intcomma }} EA
                </span>
              {% elif insp.status == "DONE" %}
                {% if insp.result == "FAIL" %}
                  <span class="insp-tag insp-tag-done">완료(불합격)</span>
                {% elif insp.result == "PASS" %}
                  <span class="insp-tag insp-tag-done">완료(합격)</span>
                {% else %}
                  <span class="insp-tag insp-tag-done">완료</span>
                {% endif %}
              {% else %}
                <span class="insp-tag insp-tag-wait">대기</span>
              {% endif %}
            {% endif %}
          </td>

          <!-- 검사 버튼 -->
          <td>
            <a href="{% url 'quality:outgoing_site_inspect' o.id %}" class="btn btn-success btn-site">
              검사
            </a>
          </td>
        </tr>
        {% endwith %}
      {% empty %}
        <tr>
          <td colspan="12" class="text-center text-muted">
            조회된 작업 LOT가 없습니다.
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

</div>

{% endblock %}
