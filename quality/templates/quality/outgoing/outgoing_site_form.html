{% extends "base.html" %}
{% load humanize %}
{% block content %}
{% now "Y-m-d" as today_str %}
{% now "Ymd" as today_compact %}
<style>
  .card-slim{border:1px solid #333;}
  .muted{color:#6c757d;}

  .summary-box{
    background:#000;
    color:#fff;
    border-radius:0.75rem;
    padding:0.9rem 1.1rem;
    display:flex;
    flex-wrap:wrap;
    gap:0.7rem 1.5rem;
    align-items:center;
    justify-content:space-between;
  }
  .summary-item{
    min-width:160px;
  }
  .summary-label{
    font-size:0.85rem;
    color:#ced4da;
  }
  .summary-value{
    font-size:1.4rem;
    font-weight:700;
  }
  .summary-value-large{
    font-size:1.8rem;
    font-weight:800;
  }

  .status-pill {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.8rem 1.8rem;   /* í¬ê¸° â†‘ */
    border-radius: 999px;
    border: 1px solid #fff;
    font-size: 1.4rem;        /* ê¸€ì”¨ 3ë°° ì •ë„ â†‘ */
    font-weight: 700;
    min-width: 10rem;         /* ê¸¸ì´ í™•ë³´ */
  }

  .status-pill--wait{
    background:#ffe066;
    color:#212529;
    border-color:#ffd43b;
    font-size:1.05rem;
    min-width:5rem;
    justify-content:center;
  }
  .status-pill--progress{
    background:#69db7c;
    color:#212529;
    border-color:#51cf66;
    font-size:1.05rem;
    min-width:5rem;
    justify-content:center;
  }
  .status-pill--done{
    background:#4dabf7;
    color:#fff;
    border-color:#339af0;
    font-size:1.05rem;
    min-width:5rem;
    justify-content:center;
  }

  .box-btn{
    font-size:1rem;
    padding:0.55rem 1.0rem;
    border-radius:9999px;
    font-weight:700;
  }

  .defect-card-title{
    font-size:1.0rem;
    font-weight:700;
    margin-bottom:.4rem;
  }

   .defect-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:.35rem .4rem;
    border-bottom:1px solid #eee;
  }
  .defect-row.compact-row{
    padding:.25rem .3rem;
  }
  .defect-label{
    flex:1 1 auto;
    font-size:0.95rem;
  }
  .compact-row .defect-label{
    font-size:0.88rem;
  }

  .defect-controls{
    display:flex;
    align-items:center;
    gap:.25rem;          /* ğŸ”½ ê°„ê²© ì‚´ì§ ì¤„ì´ê¸° (.4 â†’ .25) */
  }
  .counter-btn{
    width:2.0rem;        /* ğŸ”½ 2.4 â†’ 2.0 */
    height:2.0rem;
    border-radius:9999px;
    border:1px solid #adb5bd;
    background:#fff;
    font-size:1.2rem;    /* ğŸ”½ ê¸€ìë„ ì‚´ì§ ì¶•ì†Œ */
    line-height:1.8rem;
    text-align:center;
    cursor:pointer;
    user-select:none;
  }
  .counter-btn:active{
    transform:scale(0.96);
    background:#f1f3f5;
  }
  .counter-display{
    min-width:2.8rem;    /* ğŸ”½ 3.5 â†’ 2.8 */
    max-width:3.0rem;    /* ğŸ”¹ ë„ˆë¬´ ë„“ì–´ì§€ì§€ ì•Šê²Œ ìƒí•œë„ ì„¤ì • */
    padding:0.1rem 0.25rem;
    text-align:right;
    font-size:0.95rem;   /* ğŸ”½ ì¡°ê¸ˆ ì‘ê²Œ */
    font-weight:700;
    border:1px solid #ced4da;
    border-radius:0.45rem;
    background:#fff;
  }

  /* input ì— ì ìš©ë  ë•Œ ëª¨ì–‘ ì •ë¦¬ */
  input.counter-display{
    /* ë°•ìŠ¤ í…Œë‘ë¦¬/ë°°ê²½ì€ .counter-display ê³µí†µ ìŠ¤íƒ€ì¼ ì‚¬ìš© */
    outline:none;
    pointer-events:auto;
  }
  input.counter-display[readonly]{
    cursor:pointer;
  }

  @media (max-width:768px){
    .summary-box{
      flex-direction:column;
      align-items:flex-start;
    }
    .summary-item{
      width:100%;
    }
  }

  .numkeypad-overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.35);
    display:flex;
    align-items:flex-end;
    justify-content:center;
    z-index:1050;
  }
  .numkeypad-overlay.d-none{
    display:none;
  }
  .numkeypad-panel{
    background:#fff;
    width:100%;
    max-width:420px;
    border-radius:1rem 1rem 0 0;
    padding:1rem 1.25rem 1.25rem;
    box-shadow:0 -4px 16px rgba(0,0,0,0.25);
  }
  .numkeypad-display{
    font-size:1.4rem;
    font-weight:700;
    text-align:right;
    padding:0.4rem 0.2rem 0.6rem;
    border-bottom:1px solid #dee2e6;
    margin-bottom:0.6rem;
  }
  .numkeypad-grid{
    display:grid;
    grid-template-columns:repeat(3, minmax(0, 1fr));
    gap:0.4rem;
  }
  .numkey-btn{
    padding:0.6rem 0;
    font-size:1.25rem;
    border-radius:0.75rem;
    border:1px solid #ced4da;
    background:#f8f9fa;
  }
  .numkey-btn:active{
    background:#e9ecef;
  }
  .numkeypad-actions{
    display:flex;
    justify-content:flex-end;
    margin-top:0.6rem;
  }

  /* === ì‘ì—… LOT í—¤ë” ì¹´ë“œ(í˜„ì¥ìš© ê°€ë…ì„± ê°•í™”) === */
  .lot-info-card{
    background:#222;         /* ì§„í•œ ë°°ê²½ */
    color:#fff;              /* ê¸€ì í°ìƒ‰ */
    border-radius:0.75rem;
    border-color:#000;
  }
  .lot-info-label{
    font-size:0.85rem;
    opacity:0.8;
  }
  .lot-info-value{
    font-size:1.2rem;        /* ê°’ í¬ê²Œ */
    font-weight:700;
    letter-spacing:0.02em;
  }

  @media (max-width:768px){
    .lot-info-value{
      font-size:1.1rem;
    }
  }

  /* ìƒë‹¨ 5ê°œ ìˆ˜ëŸ‰/ìƒíƒœ ë°°ì¹˜ */
.summary-row-top {
  display: grid;
  grid-template-columns: repeat(4, minmax(0, 1fr)) 160px; /* ë§ˆì§€ë§‰ì€ pill í­ */
  column-gap: 2rem;
  row-gap: .25rem;
  align-items: flex-end;
}

/* ìƒíƒœ pillëŠ” ì˜¤ë¥¸ìª½ ì •ë ¬ */
.summary-item-status {
  text-align: right;
}

/* í•˜ë‹¨ ê²€ì‚¬ì¼/ë³´ì •ì…ë ¥ ë°°ì¹˜ */
.summary-row-bottom {
  display: flex;
  flex-wrap: wrap;
  gap: 1.5rem;
  align-items: flex-end;
}

.summary-bottom-item {
  min-width: 220px;   /* ë„ˆë¬´ ë¶™ì§€ ì•Šë„ë¡ ìµœì†Œ í­ */
}
.summary-row-bottom {
  display: flex;
  flex-wrap: wrap;
  gap: 1.5rem;
  align-items: flex-end;
}

.summary-bottom-item {
  min-width: 220px;
}

/* ë²„íŠ¼ ë¸”ëŸ­ì„ ì˜¤ë¥¸ìª½ ëìœ¼ë¡œ ë°€ê¸° */
.summary-bottom-actions {
  margin-left: auto;
}
/* ë„ê¸ˆë¶ˆëŸ‰ / ì‚¬ì¶œë¶ˆëŸ‰ / ì™„ì„±í’ˆ í˜„í™© ì•ˆì˜ í…ìŠ¤íŠ¸ í¬ê²Œ */
.defect-card-title,
.defect-row.compact-row .defect-label,
.defect-row.compact-row .counter-display,
#finishedProductList th,
#finishedProductList td {
  font-size: 0.9rem;          /* ê¸°ì¡´ì´ 0.85~0.9rem ì •ë„ì˜€ë‹¤ë©´ ì•½ 2pt â†‘ */
}
</style>

<div class="container-fluid" style="max-width: 1100px;">

  <!-- í—¤ë” -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h5 class="mb-1">ì¶œí•˜ê²€ì‚¬ (í˜„ì¥ìš©)</h5>
    </div>
    <a href="{% url 'quality:outgoing_site_list' %}?d={{ workorder.planned_start|date:'Y-m-d' }}"
       class="btn btn-sm btn-outline-secondary">
      ëª©ë¡
    </a>
  </div>

  <!-- LOT / ì œí’ˆ ì •ë³´ (í˜„ì¥ìš© í—¤ë”) -->
  <div class="card mb-3 card-slim lot-info-card">
    <div class="card-body" style="font-size:13px;">
      <div class="row g-3 align-items-center">
        <div class="col-12 col-md-3">
          <strong class="lot-info-label d-block">ì‘ì—… LOT</strong>
          <div class="lot-info-value">
            {{ workorder.work_lot }}
          </div>
        </div>
        <div class="col-12 col-md-3">
          <strong class="lot-info-label d-block">í’ˆëª…</strong>
          <div class="lot-info-value">
            {{ workorder.product.name }}
          </div>
        </div>
        <div class="col-6 col-md-3">
          <strong class="lot-info-label d-block">ê³„íšê²€ì‚¬ìˆ˜ëŸ‰(ì§€ì‹œìˆ˜ëŸ‰)</strong>
          <div class="lot-info-value" id="expectedQtyText">
            {{ workorder.order_qty|default:0|intcomma }} EA
          </div>
        </div>
        <div class="col-6 col-md-3">
          <strong class="lot-info-label d-block">ë°•ìŠ¤ë‹¹ í¬ì¥ìˆ˜ëŸ‰</strong>
          <div class="lot-info-value">
            <span id="boxSizeText">{{ box_size }}</span> EA
          </div>
        </div>
      </div>
    </div>
  </div>

  {# ê²€ì‚¬/BOX/ë¶ˆëŸ‰ ìš”ì•½ ë°•ìŠ¤ #}
  {% with plan_qty=workorder.order_qty|default:0 %}
  <div id="summaryBox"
       class="summary-box mb-3"
       data-expected="{{ plan_qty }}"
       data-box-size="{{ box_size }}"
       data-initial-good="{{ inspection.good_qty|default:0 }}"
       data-initial-defect="{{ inspection.defect_qty|default:0 }}"
       data-initial-loss="{{ inspection.loss_qty|default:0 }}">

    {# â–¶ ìƒë‹¨: 4ê°œ ìˆ˜ëŸ‰ + ìƒíƒœ pill #}
    <div class="summary-row-top">
      <!-- 1) ë¯¸ê²€ì‚¬ ì”ì—¬ìˆ˜ëŸ‰ -->
      <div class="summary-item">
        <div class="summary-label">ë¯¸ê²€ì‚¬ ì”ì—¬ìˆ˜ëŸ‰</div>
        <div class="summary-value" id="remainQtyText">
          0 EA
        </div>
      </div>

      <!-- 2) ëˆ„ì ê²€ì‚¬ìˆ˜ëŸ‰ -->
      <div class="summary-item">
        <div class="summary-label">ëˆ„ì ê²€ì‚¬ìˆ˜ëŸ‰</div>
        <div class="summary-value" id="inspectQtyText">
          {{ inspection.inspect_qty|default:0|intcomma }} EA
        </div>
      </div>

      <!-- 3) í¬ì¥ì™„ë£Œ BOX / í¬ì¥ì™„ë£Œìˆ˜ëŸ‰ -->
      <div class="summary-item">
        <div class="summary-label">í¬ì¥ì™„ë£Œ BOX / í¬ì¥ì™„ë£Œìˆ˜ëŸ‰</div>
        <div class="summary-value">
          <span id="boxCountText" class="summary-value-large">0</span> BOX
          <span class="ms-2" id="completedQtyText">0 EA</span>
        </div>
      </div>

      <!-- 4) ëˆ„ì ë¶ˆëŸ‰ìˆ˜ëŸ‰ -->
      <div class="summary-item">
        <div class="summary-label">ëˆ„ì ë¶ˆëŸ‰ìˆ˜ëŸ‰</div>
        <div class="summary-value">
          <span id="defectTotalText">0</span> EA
        </div>
      </div>

      <!-- 5) ê²€ì‚¬ ìƒíƒœ pill -->
      <div class="summary-item summary-item-status">
        <div class="status-pill status-pill--wait" id="statusDisplay">
          ê²€ì‚¬ëŒ€ê¸°
        </div>
      </div>
    </div>

    <!-- â–¶ í•˜ë‹¨: ê²€ì‚¬ì¼ + ì‹¤ìˆ˜ëŸ‰ ë³´ì •ì…ë ¥(Â±EA) + ë²„íŠ¼ -->
    <div class="summary-row-bottom mt-3">
      <!-- ê²€ì‚¬ì¼ -->
      <div class="summary-bottom-item">
        <label class="form-label text-white-50 mb-1">ê²€ì‚¬ì¼</label>
        <input type="date"
               name="inspection_date"
               class="form-control form-control-sm"
               value="{{ inspection.inspection_date|date:'Y-m-d' }}">
      </div>

      <!-- ì‹¤ìˆ˜ëŸ‰ ë³´ì •ì…ë ¥(Â±EA) -->
      <div class="summary-bottom-item">
        <label class="form-label text-white-50 mb-1">
          ì‹¤ìˆ˜ëŸ‰ ë³´ì •ì…ë ¥(Â±EA)
        </label>
        <div class="d-flex align-items-center">
          <button type="button"
                  class="btn btn-outline-light btn-sm me-2"
                  id="adjustMinusBtn">-</button>

          <div id="adjustQtyDisplay"
               class="form-control form-control-sm text-center"
               style="max-width:90px; cursor:pointer;">
            {{ inspection.adjust_qty|default:0 }}
          </div>

          <button type="button"
                  class="btn btn-outline-light btn-sm ms-2"
                  id="adjustPlusBtn">+</button>
        </div>
      </div>

      <!-- âœ… 1 BOX í¬ì¥ ì™„ë£Œ / ê²€ì‚¬ ë§ˆê° -->
      <div class="summary-bottom-item ms-auto summary-bottom-actions">
        <label class="form-label mb-1 d-block">&nbsp;</label>
        <div class="d-flex align-items-center gap-2">
          <button type="button"
                  id="btnBoxDone"
                  class="btn btn-primary box-btn">
            1 BOX í¬ì¥ ì™„ë£Œ
          </button>
          <button type="button"
                  id="btnFinalize"
                  class="btn btn-warning box-btn">
            ê²€ì‚¬ ë§ˆê°
          </button>
        </div>
      </div>
    </div>
  </div>
  {% endwith %}

  <!-- ì¶œí•˜ê²€ì‚¬ ì…ë ¥ í¼ -->
  <form method="post" id="siteInspectForm" class="mb-4">
    {% csrf_token %}

    {# í•©ê³„ í•„ë“œ(hidden) - JSê°€ ìë™ìœ¼ë¡œ ì±„ì›€ #}
    <input type="hidden" name="inspect_qty" id="inspectQtyInput"
           value="{{ inspection.inspect_qty|default:0 }}">
    <input type="hidden" name="good_qty" id="goodQtyInput"
           value="{{ inspection.good_qty|default:0 }}">
    <input type="hidden" name="_defect_qty_total" id="defectQtyInput"
           value="{{ inspection.defect_qty|default:0 }}">
    <input type="hidden" name="loss_qty" id="lossQtyInput"
           value="{{ inspection.loss_qty|default:0 }}">

    {# ğŸ”¹ ì‹¤ìˆ˜ëŸ‰ ë³´ì •ì…ë ¥(Â±EA) hidden - í¼ ì•ˆìœ¼ë¡œ ì´ë™ #}
    <input type="hidden"
           name="adjust_qty"
           id="adjustQtyInput"
           value="{{ inspection.adjust_qty|default:0 }}">

    <input type="hidden" id="finishedLotsInput"
           name="finished_lots_payload"
           value='{{ finished_lots_json|default:"[]"  }}'>


    <input type="hidden" name="status" id="statusInput"
           value="{{ inspection.status|default:'WAIT' }}">

    <!-- ë¶ˆëŸ‰ ì½”ë“œë³„ ì¹´ìš´íŠ¸ (ë„ê¸ˆ / ì‚¬ì¶œ / ì™„ì„±í’ˆí˜„í™©) -->
    <div class="row">
      <!-- ë„ê¸ˆë¶ˆëŸ‰ -->
      <div class="col-12 col-lg-5 mb-3">
        <div class="card card-slim">
          <div class="card-body" style="padding:0.8rem;">
            <div class="defect-card-title">ë„ê¸ˆë¶ˆëŸ‰</div>

            {% if plating_codes %}
            <div class="row g-1">
              {# ì™¼ìª½ 9ê°œ #}
              <div class="col-6">
                {% with plating_codes|slice:":9" as left_codes %}
                  {% for item in left_codes %}
                  <div class="defect-row compact-row"
                       data-defect-code="{{ item.code }}">
                    <div class="defect-label">
                      {{ item.label }}
                    </div>
                    <div class="defect-controls">
                      <button type="button" class="counter-btn btn-minus">-</button>
                      <input type="text"
                             class="counter-display"
                             data-role="display"
                             value="{{ item.qty|default:0 }}"
                             readonly>
                      <button type="button" class="counter-btn btn-plus">+</button>
                    </div>
                    <input type="hidden" name="defect_code" value="{{ item.code }}">
                    <input type="hidden" name="defect_qty"
                           value="{{ item.qty|default:0 }}"
                           data-role="input">
                  </div>
                  {% endfor %}
                {% endwith %}
              </div>

              {# ì˜¤ë¥¸ìª½ 9ê°œ #}
              <div class="col-6">
                {% with plating_codes|slice:"9:" as right_codes %}
                  {% for item in right_codes %}
                  <div class="defect-row compact-row"
                       data-defect-code="{{ item.code }}">
                    <div class="defect-label">
                      {{ item.label }}
                    </div>
                    <div class="defect-controls">
                      <button type="button" class="counter-btn btn-minus">-</button>
                      <input type="text"
                             class="counter-display"
                             data-role="display"
                             value="{{ item.qty|default:0 }}"
                             readonly>
                      <button type="button" class="counter-btn btn-plus">+</button>
                    </div>
                    <input type="hidden" name="defect_code" value="{{ item.code }}">
                    <input type="hidden" name="defect_qty"
                           value="{{ item.qty|default:0 }}"
                           data-role="input">
                  </div>
                  {% endfor %}
                {% endwith %}
              </div>
            </div>
            {% else %}
            <div class="text-muted small">ë“±ë¡ëœ ë„ê¸ˆë¶ˆëŸ‰ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- ì‚¬ì¶œë¶ˆëŸ‰ -->
      <div class="col-12 col-lg-3 mb-3 d-flex">
        <div class="card card-slim flex-fill">
          <div class="card-body" style="padding:0.8rem;">
            <div class="defect-card-title">ì‚¬ì¶œë¶ˆëŸ‰</div>
            {% for item in injection_codes %}
            <div class="defect-row compact-row"
                 data-defect-code="{{ item.code }}">
              <div class="defect-label">
                {{ item.label }}
              </div>
              <div class="defect-controls">
                <button type="button" class="counter-btn btn-minus">-</button>
                <input type="text"
                       class="counter-display"
                       data-role="display"
                       value="{{ item.qty|default:0 }}"
                       readonly>
                <button type="button" class="counter-btn btn-plus">+</button>
              </div>
              <input type="hidden" name="defect_code" value="{{ item.code }}">
              <input type="hidden" name="defect_qty"
                     value="{{ item.qty|default:0 }}"
                     data-role="input">
            </div>
            {% empty %}
            <div class="text-muted small">ë“±ë¡ëœ ì‚¬ì¶œë¶ˆëŸ‰ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- ì™„ì„±í’ˆ í˜„í™© -->
      <div class="col-12 col-lg-4 mb-3 d-flex">
        <div class="card card-slim flex-fill">
          <div class="card-body" style="padding:0.8rem;">
            <div class="defect-card-title mb-2">ì™„ì„±í’ˆ í˜„í™©</div>

            <table class="table table-sm table-bordered mb-0" style="font-size:0.9rem;">
              <thead>
                <tr>
                  <th style="background:#f8f9fa;text-align:center; width:45%;">LOT ë²ˆí˜¸</th>
                  <th style="background:#f8f9fa;text-align:center; width:25%;">ìˆ˜ëŸ‰(EA)</th>
                  <th style="background:#f8f9fa;text-align:center; width:30%;">í¬ì¥ìƒíƒœ</th>
                </tr>
              </thead>
              <tbody id="finishedProductList">
                <tr>
                  <td style="text-align:center;padding:0.5rem;color:#999;">-</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- í•˜ë‹¨ ë²„íŠ¼ -->
    <div class="d-flex justify-content-between align-items-center mt-3">
      <div class="text-muted small">
        â€» ë¶ˆëŸ‰ ìˆ˜ëŸ‰ì´ 0ì¸ í•­ëª©ì€ ì €ì¥ ì‹œ ë¬´ì‹œë©ë‹ˆë‹¤.
      </div>
      <div class="d-flex gap-2">
        <a href="{% url 'quality:outgoing_site_list' %}?d={{ workorder.planned_start|date:'Y-m-d' }}"
           class="btn btn-outline-secondary">
          ëª©   ë¡
        </a>
        {% if inspection.pk %}
        <!--button type="submit"
                name="action"
                value="delete"
                class="btn btn-outline-danger"
                onclick="return confirm('í˜„ì¬ ì¶œí•˜ê²€ì‚¬ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
          ì‚­ì œ
        </button -->
        {% endif %}
        <button type="submit"
                name="action"
                value="save"
                class="btn btn-primary">
          ì €   ì¥
        </button>
      </div>
    </div>

  </form>
</div>

<!-- ìˆ«ì í‚¤íŒ¨ë“œ (í˜„ì¥ìš©) -->
<div id="numKeypad" class="numkeypad-overlay d-none">
  <div class="numkeypad-panel">
    <div class="numkeypad-display" id="numKeypadDisplay">0</div>
    <div class="numkeypad-grid">
      <button type="button" class="numkey-btn" data-key="1">1</button>
      <button type="button" class="numkey-btn" data-key="2">2</button>
      <button type="button" class="numkey-btn" data-key="3">3</button>

      <button type="button" class="numkey-btn" data-key="4">4</button>
      <button type="button" class="numkey-btn" data-key="5">5</button>
      <button type="button" class="numkey-btn" data-key="6">6</button>

      <button type="button" class="numkey-btn" data-key="7">7</button>
      <button type="button" class="numkey-btn" data-key="8">8</button>
      <button type="button" class="numkey-btn" data-key="9">9</button>

      <button type="button" class="numkey-btn" data-key="C">C</button>
      <button type="button" class="numkey-btn" data-key="0">0</button>
      <button type="button" class="numkey-btn" data-key="BS">âŒ«</button>
    </div>
    <div class="numkeypad-actions mt-2">
      <button type="button" class="btn btn-sm btn-secondary me-2"
              id="numKeypadCancel">ì·¨ì†Œ</button>
      <button type="button" class="btn btn-sm btn-primary"
              id="numKeypadOk">í™•ì¸</button>
    </div>
  </div>
</div>

<script>
(function () {
  const summaryBox = document.getElementById("summaryBox");
  if (!summaryBox) return;

  // ===== ê¸°ë³¸ ê°’ =====
  const PLAN_QTY =
    parseInt(summaryBox.dataset.expected || "0", 10) || 0;   // ê³„íšê²€ì‚¬ìˆ˜ëŸ‰
  const BOX_SIZE =
    parseInt(summaryBox.dataset.boxSize || "24", 10) || 24;  // ë°•ìŠ¤ë‹¹ í¬ì¥ìˆ˜ëŸ‰

  // ì™„ë£Œ BOX ì–‘í’ˆ ìˆ˜ëŸ‰ â€“ DB good_qty ê¸°ì¤€
  let completedQty =
    parseInt(summaryBox.dataset.initialGood || "0", 10) || 0;

  // ë¶ˆëŸ‰ / LOSS
  let defectTotal =
    parseInt(summaryBox.dataset.initialDefect || "0", 10) || 0;
  let lossQty =
    parseInt(summaryBox.dataset.initialLoss || "0", 10) || 0;

  // ì‹¤ìˆ˜ëŸ‰ ë³´ì •ì…ë ¥(Â±EA)
  const adjustQtyInput = document.getElementById("adjustQtyInput");
  let adjustQty =
    parseInt((adjustQtyInput && adjustQtyInput.value) || "0", 10) || 0;

  const adjustQtyDisplay = document.getElementById("adjustQtyDisplay");
  const adjustMinusBtn   = document.getElementById("adjustMinusBtn");
  const adjustPlusBtn    = document.getElementById("adjustPlusBtn");

  // ===== ìƒë‹¨ ìš”ì•½ ì˜ì—­ =====
  const expectedQtyText  = document.getElementById("expectedQtyText");
  const inspectQtyText   = document.getElementById("inspectQtyText");
  const remainQtyText    = document.getElementById("remainQtyText");
  const boxCountText     = document.getElementById("boxCountText");
  const completedQtyText = document.getElementById("completedQtyText");
  const defectTotalText  = document.getElementById("defectTotalText");
  const statusDisplay    = document.getElementById("statusDisplay");

  const inspectQtyInput  = document.getElementById("inspectQtyInput");
  const goodQtyInput     = document.getElementById("goodQtyInput");
  const defectQtyInput   = document.getElementById("defectQtyInput");
  const lossQtyInput     = document.getElementById("lossQtyInput");

  const btnBoxDone  = document.getElementById("btnBoxDone");
  const btnFinalize = document.getElementById("btnFinalize");

  // ===== ì™„ì„± LOT ê´€ë ¨ =====
  const finishedListBody  = document.getElementById("finishedProductList");
  const finishedLotsInput = document.getElementById("finishedLotsInput");
  const statusInput       = document.querySelector('input[name="status"]');
  const formEl            = document.getElementById("siteInspectForm");

  // ê²€ì‚¬ë§ˆê° í”Œë˜ê·¸ hidden
  let finalizeInput = null;
  if (formEl) {
    finalizeInput = document.createElement("input");
    finalizeInput.type = "hidden";
    finalizeInput.name = "finalized";
    finalizeInput.id   = "finalizedFlag";
    formEl.appendChild(finalizeInput);
  }

  // ===== ìˆ«ì í‚¤íŒ¨ë“œ ìš”ì†Œ =====
  const keypadOverlay = document.getElementById("numKeypad");
  const keypadDisplay = document.getElementById("numKeypadDisplay");
  const keypadButtons = keypadOverlay
    ? keypadOverlay.querySelectorAll(".numkey-btn")
    : [];
  const keypadOk     = document.getElementById("numKeypadOk");
  const keypadCancel = document.getElementById("numKeypadCancel");
  let keypadTarget   = null;   // { displayEl, inputEl }

  // ===== LOT ë¦¬ìŠ¤íŠ¸ ë¡œë”© =====
  let finishedLots = [];
  if (finishedLotsInput && finishedLotsInput.value) {
    try {
      const parsed = JSON.parse(finishedLotsInput.value);
      if (Array.isArray(parsed)) {
        finishedLots = parsed.map(function (item, idx) {
          return {
            seq:      item.seq || idx + 1,
            lot:      item.lot || "",
            qty:      parseInt(item.qty || "0", 10),
            box_size: parseInt(item.box_size || BOX_SIZE, 10),
            status:   item.status || "FULL",   // FULL / SHORT ì½”ë“œ
          };
        });
      }
    } catch (e) {
      console.error("Error parsing finishedLotsInput JSON:", e);
      finishedLots = [];
    }
  }

  // ğŸ”¹ JSONìœ¼ë¡œ ë³µì›ëœ finishedLots ê¸°ì¤€ìœ¼ë¡œ completedQty ì¬ê³„ì‚°
  recalcCompletedQty();

  console.log("INIT from dataset", {
    PLAN_QTY,
    BOX_SIZE,
    initialGood: summaryBox.dataset.initialGood,
    initialDefect: summaryBox.dataset.initialDefect,
    initialLoss: summaryBox.dataset.initialLoss,
    adjustQty,
  });
  console.log("RAW finishedLotsInput.value =", finishedLotsInput && finishedLotsInput.value);
  console.log("INIT finishedLots =", finishedLots);
  console.log("INIT completedQty =", completedQty);

  // ===== ê³µí†µ í•¨ìˆ˜ë“¤ =====

  function getLotDate() {
    const inspInput = document.querySelector("input[name='inspection_date']");
    const v = inspInput && inspInput.value; // "2025-11-19"
    if (v && v.length >= 10) {
      return v.replace(/-/g, "");          // "20251119"
    }
    const d   = new Date();
    const y   = d.getFullYear();
    const m   = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return "" + y + m + day;
  }

  function recalcFromDefectInputs() {
    const inputs = document.querySelectorAll("[data-role='input']");
    let sum = 0;
    inputs.forEach(function (inp) {
      const v = parseInt(inp.value || "0", 10) || 0;
      sum += v;
    });
    defectTotal = sum;
  }

  function updateStatusLabel(inspectQty, remainQty) {
    if (!statusDisplay) return;

    let text = "ê²€ì‚¬ëŒ€ê¸°";
    let cls  = "status-pill--wait";

    if (inspectQty > 0 && remainQty > 0) {
      text = "ê²€ì‚¬ì§„í–‰ì¤‘";
      cls  = "status-pill--progress";
    } else if (inspectQty > 0 && remainQty === 0) {
      text = "ê²€ì‚¬ ë§ˆê° ì™„ë£Œ";
      cls  = "status-pill--done";
    }

    statusDisplay.textContent = text;
    statusDisplay.classList.remove(
      "status-pill--wait",
      "status-pill--progress",
      "status-pill--done"
    );
    statusDisplay.classList.add(cls);
  }

  function refreshView() {
    // 1) ê¸°ë³¸ ê°’
    const actualTotal  = PLAN_QTY + adjustQty;                 // ê³„íš + ë³´ì •
    const goodQty      = completedQty;                         // í¬ì¥ ì™„ë£Œ ì–‘í’ˆ
    const rawInspect   = goodQty + defectTotal + lossQty;      // ì‹¤ì¸¡ ê²€ì‚¬ìˆ˜
    const finalInspect = rawInspect + adjustQty;               // ìµœì¢… ì¸ì • ê²€ì‚¬ìˆ˜ëŸ‰
    const remainQty    = Math.max(actualTotal - rawInspect, 0);

    const boxCount = BOX_SIZE > 0
      ? Math.floor(goodQty / BOX_SIZE)
      : 0;

    // 2) hidden ë™ê¸°í™” â€“ ìµœì¢… ì¸ì • ê²€ì‚¬ìˆ˜ëŸ‰ ì €ì¥
    if (inspectQtyInput) inspectQtyInput.value = finalInspect;
    if (goodQtyInput)    goodQtyInput.value    = goodQty;
    if (defectQtyInput)  defectQtyInput.value  = defectTotal;
    if (lossQtyInput)    lossQtyInput.value    = lossQty;

    // 3) ì¹´ë“œ í‘œì‹œ â€“ ëˆ„ì ê²€ì‚¬ìˆ˜ëŸ‰ì€ finalInspect ê¸°ì¤€
    if (expectedQtyText)
      expectedQtyText.textContent = PLAN_QTY.toLocaleString() + " EA";

    if (inspectQtyText)
      inspectQtyText.textContent = finalInspect.toLocaleString() + " EA";

    if (remainQtyText)
      remainQtyText.textContent = remainQty.toLocaleString() + " EA";

    if (boxCountText)
      boxCountText.textContent = boxCount.toString();

    if (completedQtyText)
      completedQtyText.textContent = goodQty.toLocaleString() + " EA";

    if (defectTotalText)
      defectTotalText.textContent = defectTotal.toLocaleString() + " EA";

    // ìƒíƒœ pill ì—…ë°ì´íŠ¸ â€“ ì¸ìë¡œ finalInspect/ remainQty ì‚¬ìš©
    updateStatusLabel(finalInspect, remainQty);

    console.log("REFRESH", {
      completedQty,
      defectTotal,
      lossQty,
      PLAN_QTY,
      adjustQty,
      inspectQty: finalInspect,
      remainQty,
    });
  }

  function syncFinishedLotsHidden() {
    if (!finishedLotsInput) return;
    finishedLotsInput.value = JSON.stringify(finishedLots);
  }

  function renderFinishedLots() {
    if (!finishedListBody) return;

    while (finishedListBody.firstChild) {
      finishedListBody.removeChild(finishedListBody.firstChild);
    }

    if (!finishedLots.length) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 3;
      td.style.textAlign = "center";
      td.style.color     = "#999";
      td.textContent     = "-";
      tr.appendChild(td);
      finishedListBody.appendChild(tr);
      syncFinishedLotsHidden();
      return;
    }

    finishedLots.forEach(function (item, index) {
      const tr = document.createElement("tr");

      const tdLot = document.createElement("td");
      tdLot.style.textAlign = "center";
      tdLot.textContent = item.lot || "";
      tr.appendChild(tdLot);

      const tdQty = document.createElement("td");
      tdQty.style.textAlign = "right";
      tdQty.textContent = (item.qty || 0).toLocaleString() + " EA";
      tr.appendChild(tdQty);

      const tdStatus = document.createElement("td");
      tdStatus.style.textAlign = "center";

      const spanStatus = document.createElement("span");

      // ì½”ë“œ â†’ í•œê¸€ ë¼ë²¨ ë³€í™˜
      let statusText = "ì™„ì„±";
      if (item.status === "SHORT") statusText = "ë¶€ì¡±";

      spanStatus.textContent = statusText;
      tdStatus.appendChild(spanStatus);

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "btn btn-sm btn-outline-danger ms-2";
      btn.textContent = "ì‚­ì œ";
      btn.addEventListener("click", function () {
        removeBoxByIndex(index);
      });
      tdStatus.appendChild(btn);

      tr.appendChild(tdStatus);
      finishedListBody.appendChild(tr);
    });

    syncFinishedLotsHidden();
  }

  function recalcCompletedQty() {
    completedQty = finishedLots.reduce(function (sum, item) {
      return sum + (item.qty || 0);
    }, 0);
  }

  // ----- BOX ì¶”ê°€/ì‚­ì œ -----

  function addFinishedBox() {
    const lotDate = getLotDate();
    const seq     = finishedLots.length + 1;
    const seqStr  = String(seq).padStart(2, "0");
    //const tempNo = "ì„ì‹œí¬ì¥ " + seq;  // í™”ë©´ í‘œì‹œìš©
    const tempNo = "ì„ì‹œí¬ì¥ ";  // í™”ë©´ í‘œì‹œìš©
    finishedLots.push({
        seq: seq,
        lot: tempNo,  // DB ì½”ë“œ ì•„ë‹˜!
        qty: BOX_SIZE,
        box_size: BOX_SIZE,
        status: "FULL",
    });

    recalcCompletedQty();
    renderFinishedLots();
    refreshView();
  }

  function addPartialBox(partialQty) {
    if (partialQty <= 0) return;

    const seq = finishedLots.length + 1;
    const lotLabel = "ì”ëŸ‰ ì„ì‹œí¬ì¥ ";   // ğŸ‘ˆ ì—¬ê¸°ë„ ì„ì‹œ ë¼ë²¨

    finishedLots.push({
      seq:      seq,
      lot:      lotLabel,    // ğŸ‘ˆ í™”ë©´ìš© ì„ì‹œ LOT
      qty:      partialQty,
      box_size: BOX_SIZE,
      status:   "SHORT",     // ì½”ë“œ
    });

    recalcCompletedQty();
    renderFinishedLots();
    refreshView();
  }

  function removeBoxByIndex(index) {
    if (index < 0 || index >= finishedLots.length) return;

    finishedLots.splice(index, 1);

    recalcCompletedQty();
    renderFinishedLots();
    refreshView();
  }

  // ----- ìˆ«ì í‚¤íŒ¨ë“œ -----

  function openKeypad(displayEl, inputEl) {
    if (!keypadOverlay || !keypadDisplay || !inputEl) return;

    keypadTarget = { displayEl: displayEl, inputEl: inputEl };
    keypadDisplay.textContent = String(
      parseInt(inputEl.value || "0", 10) || 0
    );
    keypadOverlay.classList.remove("d-none");
  }

  function closeKeypad(apply) {
    if (!keypadOverlay) return;

    if (apply && keypadTarget && keypadDisplay) {
      let val = parseInt(keypadDisplay.textContent || "0", 10);
      if (isNaN(val)) val = 0;

      // ğŸ”¹ adjustQtyInput ì¼ ë•Œë§Œ ìŒìˆ˜ í—ˆìš©, ë‚˜ë¨¸ì§€ëŠ” 0 ì´í•˜ ê¸ˆì§€
      if (!(keypadTarget &&
            keypadTarget.inputEl &&
            keypadTarget.inputEl.id === "adjustQtyInput")) {
        if (val < 0) val = 0;
      }

      const inputEl   = keypadTarget.inputEl;
      const displayEl = keypadTarget.displayEl;

      inputEl.value = String(val);
      if (displayEl) {
        if (displayEl.tagName === "INPUT") {
          displayEl.value = val.toString();
        } else {
          displayEl.textContent = val.toString();
        }
      }

      // âœ… ë³´ì •ê°’ì´ë©´ adjustQty ë³€ìˆ˜ë„ ê°™ì´ ì—…ë°ì´íŠ¸
      if (inputEl.id === "adjustQtyInput") {
        adjustQty = val;
      }

      recalcFromDefectInputs();
      refreshView();
    }

    keypadTarget = null;
    keypadOverlay.classList.add("d-none");
  }

  if (keypadOverlay && keypadDisplay) {
    keypadButtons.forEach(function (btn) {
      btn.addEventListener("click", function () {
        const key = btn.dataset.key;
        let text  = keypadDisplay.textContent || "0";

        if (key === "C") {
          text = "0";
        } else if (key === "BS") {
          text = text.slice(0, -1) || "0";
        } else if (key >= "0" && key <= "9") {
          if (text === "0") text = key;
          else text += key;
        }

        keypadDisplay.textContent = text;
      });
    });

    if (keypadOk) {
      keypadOk.addEventListener("click", function () {
        closeKeypad(true);
      });
    }
    if (keypadCancel) {
      keypadCancel.addEventListener("click", function () {
        closeKeypad(false);
      });
    }
  }

  // ----- ë¶ˆëŸ‰ ì¹´ìš´í„° -----

  document.querySelectorAll(".defect-row").forEach(function (row) {
    const minusBtn = row.querySelector(".btn-minus");
    const plusBtn  = row.querySelector(".btn-plus");
    const display  = row.querySelector("[data-role='display']");
    const input    = row.querySelector("[data-role='input']");
    if (!input) return;

    function setQty(newVal) {
      if (newVal < 0) newVal = 0;
      input.value = String(newVal);

      if (display) {
        if (display.tagName === "INPUT") {
          display.value = String(newVal);
        } else {
          display.textContent = String(newVal);
        }
      }

      recalcFromDefectInputs();
      refreshView();
    }

    if (minusBtn) {
      minusBtn.addEventListener("click", function () {
        const current = parseInt(input.value || "0", 10) || 0;
        setQty(current - 1);
      });
    }

    if (plusBtn) {
      plusBtn.addEventListener("click", function () {
        const current = parseInt(input.value || "0", 10) || 0;
        setQty(current + 1);
      });
    }

    if (display) {
      display.addEventListener("click", function () {
        openKeypad(display, input);
      });
    }
  });

  // ----- ì‹¤ìˆ˜ëŸ‰ ë³´ì •ì…ë ¥(Â±EA) -----
  function setAdjustQty(newVal) {
    // ì‹¤ìˆ˜ëŸ‰ ë³´ì •ì…ë ¥ì€ ìŒìˆ˜ í—ˆìš© (Â±EA)
    adjustQty = newVal;

    if (adjustQtyInput) {
      adjustQtyInput.value = String(newVal);
    }
    if (adjustQtyDisplay) {
      adjustQtyDisplay.textContent = String(newVal);
    }

    refreshView();
  }

  // - ë²„íŠ¼
  if (adjustMinusBtn) {
    adjustMinusBtn.addEventListener("click", function () {
      setAdjustQty(adjustQty - 1);
    });
  }

  // + ë²„íŠ¼
  if (adjustPlusBtn) {
    adjustPlusBtn.addEventListener("click", function () {
      setAdjustQty(adjustQty + 1);
    });
  }

  // ìˆ«ì ë°•ìŠ¤ í´ë¦­ â†’ í‚¤íŒ¨ë“œ
  if (adjustQtyDisplay && adjustQtyInput) {
    adjustQtyDisplay.addEventListener("click", function () {
      openKeypad(adjustQtyDisplay, adjustQtyInput);
    });
  }

  // ì´ˆê¸° ë Œë”
  recalcFromDefectInputs();
  refreshView();
  renderFinishedLots();

  // ----- 1 BOX í¬ì¥ ì™„ë£Œ -----
  if (btnBoxDone) {
    btnBoxDone.addEventListener("click", function () {
      const actualTotal = PLAN_QTY + adjustQty;
      const inspectQty  = completedQty + defectTotal + lossQty;
      const remainQty   = Math.max(actualTotal - inspectQty, 0);

      if (remainQty < BOX_SIZE) {
        alert("ë¯¸ê²€ì‚¬ ì”ì—¬ìˆ˜ëŸ‰ì´ ë°•ìŠ¤ë‹¹ í¬ì¥ìˆ˜ëŸ‰ë³´ë‹¤ ì ì–´ì„œ BOXë¥¼ ë§Œë“¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      addFinishedBox();
    });
  }

  // ----- ê²€ì‚¬ ë§ˆê° -----
  if (btnFinalize) {
    btnFinalize.addEventListener("click", function () {
      if (finalizeInput && finalizeInput.value === "1") {
        alert("ì´ë¯¸ ê²€ì‚¬ ë§ˆê° ìˆ˜ëŸ‰ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.\n[ì €ì¥]ë§Œ ëˆŒëŸ¬ ì£¼ì„¸ìš”.");
        return;
      }

      const actualTotal = PLAN_QTY + adjustQty;
      const inspectQty  = completedQty + defectTotal + lossQty;
      const remainQty   = Math.max(actualTotal - inspectQty, 0);

      if (remainQty >= BOX_SIZE) {
        alert(
          "ë¯¸ê²€ì‚¬ ì”ì—¬ìˆ˜ëŸ‰ì´ ë°•ìŠ¤ë‹¹ í¬ì¥ìˆ˜ëŸ‰ ì´ìƒì…ë‹ˆë‹¤.\n" +
          "[1 BOX í¬ì¥ ì™„ë£Œ] ë²„íŠ¼ìœ¼ë¡œ ë¨¼ì € í¬ì¥í•œ í›„ ê²€ì‚¬ ë§ˆê°í•´ ì£¼ì„¸ìš”."
        );
        return;
      }

      let msg = "";
      if (remainQty > 0) {
        const previewSeq = finishedLots.length + 1;
        const lotDate    = getLotDate();
        const seqStr     = String(previewSeq).padStart(2, "0");
        const lotNo      = "C-" + lotDate + "-" + seqStr;

        msg =
          "ë¯¸ê²€ì‚¬ ì”ì—¬ìˆ˜ëŸ‰ " +
          remainQty.toLocaleString() +
          " EA ë¥¼\n" +
          "ì”ëŸ‰ë°•ìŠ¤ë¡œ ìƒì„±í•˜ê³  ê²€ì‚¬ ë§ˆê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
      } else {
        msg =
          "ë¯¸ê²€ì‚¬ ì”ì—¬ìˆ˜ëŸ‰ì´ 0EA ì…ë‹ˆë‹¤.\n" +
          "ê·¸ëŒ€ë¡œ ê²€ì‚¬ ë§ˆê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
      }

      if (!confirm(msg)) {
        return;
      }

      if (remainQty > 0) {
        addPartialBox(remainQty);
      }

      if (statusInput) {
        statusInput.value = "DONE";
      }
      if (finalizeInput) {
        finalizeInput.value = "1";
      }

      refreshView();
      alert("ê²€ì‚¬ ë§ˆê° ìˆ˜ëŸ‰ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nì´ ìƒíƒœì—ì„œ [ì €ì¥] ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.");
    });
  }
})();
</script>
{% endblock %}