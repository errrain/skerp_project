{% extends "base.html" %}
{% load humanize %}
{% block content %}
<style>
  .card-slim{border:1px solid #333}
  .muted{color:#6c757d}
  .chip{
    display:inline-block;border:1px solid #bbb;border-radius:6px;
    padding:.2rem .45rem;font-size:.8rem;margin-right:.25rem;background:#fff
  }
</style>

<div class="container" style="max-width: 1100px;">

  <!-- 헤더 영역 -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">출하검사 입력</h5>
    <a href="{% url 'quality:outgoing_list' %}"
       class="btn btn-sm btn-outline-secondary">
      목록
    </a>
  </div>

  <!-- 작업 LOT 헤더 카드 -->
  <div class="card mb-3 card-slim">
    <div class="card-body" style="font-size:13px;">
      <div class="row g-2">
        <div class="col-md-3">
          <strong>작업 LOT</strong>
          <div>{{ workorder.work_lot }}</div>
        </div>
        <div class="col-md-3">
          <strong>고객</strong>
          <div>{{ workorder.customer.name }}</div>
        </div>
        <div class="col-md-3">
          <strong>품명</strong>
          <div>{{ workorder.product.name }}</div>
        </div>
        <div class="col-md-3">
          <strong>지시수량</strong>
          <div>{{ workorder.order_qty|default:0|intcomma }}</div>
        </div>
      </div>

      <div class="row g-2 mt-1">
        <div class="col-md-3">
          <strong>계획시작</strong>
          <div>{{ workorder.planned_start|date:"Y-m-d H:i" }}</div>
        </div>
        <div class="col-md-3">
          <strong>계획종료</strong>
          <div>{{ workorder.planned_end|date:"Y-m-d H:i" }}</div>
        </div>
        <div class="col-md-3">
          <strong>실제시작</strong>
          <div>{{ workorder.actual_start|date:"Y-m-d H:i" }}</div>
        </div>
        <div class="col-md-3">
          <strong>실제종료</strong>
          <div>{{ workorder.actual_end|date:"Y-m-d H:i" }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- 출하검사 입력 폼 -->
  <div class="card mb-3 card-slim">
    <div class="card-body" style="font-size:13px;">
      <form method="post" class="mb-0">
        {% csrf_token %}

        <!-- 1. 기본 검사 정보 -->
        <div class="row g-2">
          <div class="col-md-3">
            <label class="form-label">검사일</label>
            <input type="date"
                   name="inspection_date"
                   class="form-control form-control-sm"
                   value="{{ inspection.inspection_date|date:'Y-m-d' }}">
          </div>

          <div class="col-md-3">
            <label class="form-label">합격여부</label>
            <select name="status" class="form-select form-select-sm">
              <option value="DRAFT" {% if inspection.status == 'DRAFT' %}selected{% endif %}>대기</option>
              <option value="PASS"  {% if inspection.status == 'PASS'  %}selected{% endif %}>합격</option>
              <option value="FAIL"  {% if inspection.status == 'FAIL'  %}selected{% endif %}>불합격</option>
              <option value="HOLD"  {% if inspection.status == 'HOLD'  %}selected{% endif %}>보류</option>
            </select>
          </div>

          <div class="col-md-3">
            <label class="form-label">검사수량</label>
            <input type="number" name="inspect_qty" min="0"
                   class="form-control form-control-sm"
                   value="{{ inspection.inspect_qty|default:workorder.order_qty }}">
          </div>

          <div class="col-md-3">
            <label class="form-label">LOSS 수량</label>
            <input type="number" name="loss_qty" min="0"
                   class="form-control form-control-sm"
                   value="{{ inspection.loss_qty|default:0 }}">
          </div>
        </div>

        <div class="row g-2 mt-1">
          <div class="col-md-3">
            <label class="form-label">양품수량</label>
            <input type="number" name="good_qty" min="0"
                   class="form-control form-control-sm"
                   value="{{ inspection.good_qty|default:inspection.inspect_qty }}">
          </div>
          <div class="col-md-3">
            <label class="form-label">불량수량</label>
            <input type="number" name="defect_qty" min="0"
                   class="form-control form-control-sm"
                   value="{{ inspection.defect_qty|default:0 }}">
          </div>
          <div class="col-md-6">
            <label class="form-label">비고</label>
            <input type="text" name="remark"
                   class="form-control form-control-sm"
                   value="{{ inspection.remark }}">
          </div>
        </div>

        <hr class="my-3">

        <!-- 2. 불량 코드별 수량 입력 -->
        <div class="row">
          <!-- 도금불량 -->
          <div class="col-md-6">
            <h6 class="mb-2">도금불량</h6>
            <table class="table table-sm table-bordered mb-0" style="font-size:12px;">
              <thead class="table-light">
                <tr>
                  <th style="width:55%;">불량항목</th>
                  <th style="width:45%;">수량</th>
                </tr>
              </thead>
              <tbody>
                {% for item in plating_codes %}
                <tr>
                  <td class="text-start">
                    {{ item.label }}
                    <input type="hidden" name="defect_code" value="{{ item.code }}">
                  </td>
                  <td>
                    <input type="number" min="0"
                           name="defect_qty"
                           class="form-control form-control-sm text-end"
                           value="{{ item.qty|default:0 }}">
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- 사출불량 -->
          <div class="col-md-6">
            <h6 class="mb-2">사출불량</h6>
            <table class="table table-sm table-bordered mb-0" style="font-size:12px;">
              <thead class="table-light">
                <tr>
                  <th style="width:55%;">불량항목</th>
                  <th style="width:45%;">수량</th>
                </tr>
              </thead>
              <tbody>
                {% for item in injection_codes %}
                <tr>
                  <td class="text-start">
                    {{ item.label }}
                    <input type="hidden" name="defect_code" value="{{ item.code }}">
                  </td>
                  <td>
                    <input type="number" min="0"
                           name="defect_qty"
                           class="form-control form-control-sm text-end"
                           value="{{ item.qty|default:0 }}">
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <div class="mt-3 d-flex justify-content-between">
          <div class="text-muted small">
            ※ 불량 수량이 0인 항목은 저장 시 무시됩니다.
          </div>
          <div class="d-flex gap-2">
            <a href="{% url 'quality:outgoing_list' %}"
               class="btn btn-sm btn-outline-secondary">
              목록
            </a>

            {% if inspection.pk %}
              <button type="submit"
                      name="action"
                      value="delete"
                      class="btn btn-sm btn-outline-danger"
                      onclick="return confirm('현재 출하검사 데이터를 삭제하시겠습니까?');">
                삭제
              </button>
            {% endif %}

            <button type="submit"
                    name="action"
                    value="save"
                    class="btn btn-sm btn-primary">
              저장
            </button>
          </div>
        </div>

      </form>
    </div>
  </div>

</div>
{% endblock %}
